[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order Schedule Settings",
  "enabled": 0,
  "modified": "2025-06-21 17:04:32.951170",
  "module": "ONEGENE",
  "name": "Order Schedule Settings",
  "script": "frappe.ui.form.on('Sales Order Schedule Settings', {\n\trefresh(frm) {\n        frm.disable_save()\n        if(frm.doc.attach) {\n            frappe.call({\n                method: 'onegene.onegene.doctype.sales_order_schedule_settings.sales_order_schedule_settings.get_data',\n                args: {\n                    'file': frm.doc.attach,\n                },\n                callback(r) {\n                    if (r.message) {\n        \t\t\t\tfrm.fields_dict.html.$wrapper.empty().append(r.message)\n\n                    }\n                }\n            })\n            \n        }\n//         frm.call('get_data').then(r => {\n// \t\t\tif (r.message) {\n\t\t\t\t// frm.fields_dict.html.$wrapper.empty().append(r.message)\n// \t\t\t}\n//         })\n\t},\n\tupload(frm) {\n        if (frm.doc.attach) {\n            frappe.call({\n                method: 'onegene.onegene.doctype.sales_order_schedule_settings.sales_order_schedule_settings.enqueue_upload',\n                args: {\n                    'file': frm.doc.attach,\n                },\n                freeze: true,\n                freeze_message: 'Updating Order Schedule Data....',\n                callback(r) {\n                    if (r.message) {\n                        frappe.show_alert({\n                            message: __('Order Schedule Updated Successfully'),\n                            indicator: 'green'\n                        }, 5);\n                    }\n                }\n            })\n        }\n        else {\n            frappe.msgprint('Please Attach the Excel File')\n        }\n        \n    },\n    \n    download(frm){\n        var path = \"onegene.onegene.doctype.sales_order_schedule_settings.sales_order_schedule_settings.template_sheet\"\n\t\tvar args = 'name=%(name)s'\n\t\tif (path) {\n\t\t\twindow.location.href = repl(frappe.request.url +\n\t\t\t\t'?cmd=%(cmd)s&%(args)s', {\n\t\t\t\tcmd: path,\n\t\t\t\targs: args,\n\t\t\t\tname: frm.doc.name\n\t\t\t});\n\t\t}\n    },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2025-07-31 17:55:00.578740",
  "module": "ONEGENE",
  "name": "Purchase Receipt",
  "script": "frappe.ui.form.on('Purchase Receipt', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\tasync validate(frm) {\n        for (let row of frm.doc.items) {\n            if (row.item_code) {\n                let r = await frappe.db.get_value(\"Item\", row.item_code, \"custom_warehouse\");\n                if (r.message && r.message.custom_warehouse) {\n                    let warehouse = r.message.custom_warehouse;\n                    await frappe.model.set_value(row.doctype, row.name, \"warehouse\", warehouse);\n                }\n            }\n        }\n    frm.refresh_field(\"items\");\n    }\n})\n\nfrappe.ui.form.on('Purchase Receipt Item', {\n    qty(frm,cdt,cdn) {\n\t\tvar child = locals[cdt][cdn];\n\t\tif (child.qty > child.custom_dispatched_quantity) {\n\t\t    frappe.msgprint(`<b>Row ${child.idx}:</b> Received Quantity should not exceed Dispatched Quantity of ${child.custom_dispatched_quantity}`);\n\t\t    frappe.model.set_value(cdt, cdn, \"qty\", 0);\n\t\t}\n\t\telse {\n\t\t    frappe.model.set_value(cdt, cdn, \"custom_sr_qty\", child.qty);\n\t\t}\n    },\n\tcustom_inspect(frm,cdt,cdn){\n\t    var child = locals [cdt][cdn]\n        var ip = frappe.model.make_new_doc_and_get_name('Item Inspection');\n        ip = locals['Item Inspection'][ip];\n        ip.purchase_receipt_number = frm.doc.name\n        ip.company_name = frm.doc.company\n        ip.item_code = child.item_code\n        ip.received_qty = child.qty\n        ip.warehouse = frm.doc.set_warehouse\n        ip.id = child.name\n        frappe.set_route(\"Form\", \"Item Inspection\",ip.name)\n    },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "User",
  "enabled": 1,
  "modified": "2025-11-20 11:22:16.321640",
  "module": "ONEGENE",
  "name": "User",
  "script": "frappe.ui.form.on('User', {\n\trefresh(frm) {\n\t\tif(frm.doc.__islocal){\n\t        frm.set_value(\"new_password\", \"wonjin@321\");\n\t    }\n\t    if (!frappe.user.has_role('System Manager') && !frappe.user.has_role('HR Manager') && !frappe.user.has_role('HR User')) {\n\t        frm.set_df_property('first_name','read_only',1);\n\t        frm.set_df_property('middle_name','read_only',1);\n\t        frm.set_df_property('last_name','read_only',1);\n\t        frm.set_df_property('username','read_only',1);\n\t        frm.set_df_property('language','read_only',1);\n\t        frm.set_df_property('time_zone','read_only',1);\n\t        frm.set_df_property('enabled','read_only',1);\n\t       // frm.set_df_property('short_bio','hidden',1);\n\t    }\n\t    if(!frm.doc.__islocal){\n\t        if (!frappe.user.has_role('System Manager')) {\n\t        frm.set_df_property('password_for_admin','hidden',1);\n\t    }\n\t    }\n\t},\n\tonload(frm){\n\t    if(frm.doc.__islocal){\n\t        frm.set_value(\"new_password\", \"wonjin@321\");\n\t    }\n\t    if(!frm.doc.__islocal){\n\t        if (!frappe.user.has_role('System Manager')) {\n\t        frm.set_df_property('password_for_admin','hidden',1);\n\t    }\n\t    }\n\t    \n\t},\n\tvalidate(frm){\n\t    if(frm.doc.__islocal){\n\t        frm.set_value(\"new_password\", \"wonjin@321\");\n\t    }\n\t    frm.set_value(\"password_for_admin\", frm.doc.new_password);\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2024-11-22 16:57:45.698762",
  "module": "ONEGENE",
  "name": "Employee",
  "script": "frappe.ui.form.on('Employee', {\n\trefresh(frm) {\n\tif (frappe.datetime.get_today()>=frm.doc.custom_probation_end_date){\n\t    frm.add_custom_button(__(\"Print Confirmation Letter\"), function () {\n                var f_name = frm.doc.name;\n                var print_format =\"Confirmation Letter\";\n                 window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                    + \"doctype=\" + encodeURIComponent(\"Employee\")\n                    + \"&name=\" + encodeURIComponent(f_name)\n                    + \"&trigger_print=1\"\n                    + \"&format=\" + print_format\n                    + \"&no_letterhead=0\"\n                    + \"&letterhead=\" + encodeURIComponent\n                ));\n            });\n\t    }\n    if (frm.doc.employee_category != 'Apprentice'){\n        frm.set_value('custom_pf_type','');\n    }\n\t},\n\n\tonload(frm){\n    if(frm.doc.__islocal){\n        frm.trigger(\"set_employee_number\");\n    }\n\t},\n\temployee_category(frm){\n   \n        frm.trigger(\"set_employee_number\")\n        if(frm.doc.employee_category == 'Staff' || frm.doc.employee_category == 'Sub Staff' ){\n            frappe.call({\n                    method: 'onegene.onegene.custom.update_role',\n                    args: {\n                        id:frm.doc.user_id,\n                    },\n                    \n                });\n        }\n\t},\n\tuser_id(frm){\n\t    if(frm.doc.employee_category == 'Staff' || frm.doc.employee_category == 'Sub Staff' ){\n            frappe.call({\n                    method: 'onegene.onegene.custom.update_role',\n                    args: {\n                        id:frm.doc.user_id,\n                    },\n                    \n                });\n        }\n\t},\n\tdesignation(frm){\n \n        frm.trigger(\"set_employee_number\")\n    \n\t},\n// \tstatus(frm){\n//         if(frm.doc.status == 'Left'){\n//             frappe.call({\n//                     method: 'onegene.onegene.custom.mark_disable',\n//                     args: {\n//                         id:frm.doc.user_id,\n//                     },\n                    \n//                 });\n//         }\n//     },\n\tdepartment(frm){\n \n        frm.trigger(\"set_employee_number\")\n    \n\t},\n\tcustom_contractor(frm){\n\t    frm.trigger(\"set_employee_number\")\n\t},\n\tcustom_contractor_shortcode(frm){\n\t    frm.trigger(\"set_employee_number\")\n\t},\n\tcustom_apply_resignation(frm) {\n        console.log(\"HI\")\n        frappe.route_options = { 'employee': frm.doc.name }\n        frappe.set_route('Form', 'Resignation Form','new')\n    },\n    set_employee_number(frm){\n\t    if(frm.doc.employee_category && frm.doc.designation && frm.doc.department ){\n            frappe.call({\n                method: 'onegene.onegene.utils.set_naming',\n                args: {\n                    employee_category: frm.doc.employee_category,\n                    department: frm.doc.department,\n                    designation :frm.doc.designation\n                },\n                callback: function(r) {\n                    console.log(r.message)\n                    if (r.message) {\n                        frm.set_value('employee_number',r.message)\n                    }\n                }\n            });\n\t    }\n\t    if(frm.doc.employee_category && frm.doc.custom_contractor && frm.doc.custom_contractor_shortcode){\n\t        frappe.call({\n                method: 'onegene.onegene.utils.set_naming_contractor',\n                args: {\n                    employee_category: frm.doc.employee_category,\n                    contractor_shortcode : frm.doc.custom_contractor_shortcode,\n                    contractor : frm.doc.custom_contractor\n                },\n                callback: function(r) {\n                    console.log(r.message)\n                    if (r.message) {\n                        frm.set_value('employee_number',r.message)\n                    }\n                }\n            });\n\t    }\n    },\n    // Client-side Script\n// after_save(frm) {\n//     if (frm.doc.__islocal && !frm.doc.user_id) {\n//         frappe.call({\n//             method: 'onegene.onegene.custom.create_user',\n//             args: {\n//                 employee: frm.doc.employee,\n//                 first_name: frm.doc.first_name,\n//                 employee_name: frm.doc.employee_name,\n//                 date_of_birth:frm.doc.date_of_birth,\n//                 gender:frm.doc.gender\n//             },\n//             callback: function(r) {\n//                 if (r.message) {\n//                     console.log(\"User created or updated:\", r.message);\n//                     // frm.set_value('user_id', r.message.message);  // Assuming response format from create_user\n//                     // frm.save();  // Save the document with updated user_id\n//                 } else {\n//                     frappe.msgprint(__('Error occurred while creating the user.'));\n//                 }\n//             },\n//         });\n//     }\n\n    // if (frm.doc.user_id && frm.doc.create_user_permission == 0) {\n    //     frm.set_value('create_user_permission', 1);\n    //     frm.save();  // Save after updating permission\n    // }\n// }\n\n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Offer",
  "enabled": 1,
  "modified": "2024-01-03 10:01:49.774525",
  "module": "ONEGENE",
  "name": "Job Offer",
  "script": "frappe.ui.form.on('Job Offer', {\n\trefresh(frm) {\n\tif(!frm.doc.__islocal){\n\t\tfrm.add_custom_button(__(\"Print Joining Report\"), function () {\n                var f_name = frm.doc.name;\n                var print_format =\"JOINING REPORT\";\n                 window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                    + \"doctype=\" + encodeURIComponent(\"Job Offer\")\n                    + \"&name=\" + encodeURIComponent(f_name)\n                    + \"&trigger_print=1\"\n                    + \"&format=\" + print_format\n                    + \"&no_letterhead=0\"\n                    + \"&letterhead=\" + encodeURIComponent\n                ));\n            });\n        frm.add_custom_button(__(\"Print Appointment Letter\"), function () {\n                var f_name = frm.doc.name;\n                var print_format =\"Offer Letter\";\n                 window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                    + \"doctype=\" + encodeURIComponent(\"Job Offer\")\n                    + \"&name=\" + encodeURIComponent(f_name)\n                    + \"&trigger_print=1\"\n                    + \"&format=\" + print_format\n                    + \"&no_letterhead=0\"\n                    + \"&letterhead=\" + encodeURIComponent\n                ));\n            });\n\t\t}\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Applicant",
  "enabled": 1,
  "modified": "2024-01-03 10:03:14.027595",
  "module": "ONEGENE",
  "name": "Job Applicant",
  "script": "frappe.ui.form.on('Job Applicant', {\n\trefresh(frm) {\n\t\tif(!frm.doc.__islocal){\n\t\tfrm.add_custom_button(__(\"Print Employment Form\"), function () {\n                var f_name = frm.doc.name;\n                var print_format =\"Job Applicant\";\n                 window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                    + \"doctype=\" + encodeURIComponent(\"Job Applicant\")\n                    + \"&name=\" + encodeURIComponent(f_name)\n                    + \"&trigger_print=1\"\n                    + \"&format=\" + print_format\n                    + \"&no_letterhead=0\"\n                    + \"&letterhead=\" + encodeURIComponent\n                ));\n            });\n\t\t}\n\n\t},\n\tcustom_member_of_epf(frm) {\n\t    $('*[data-fieldname=\"custom_if_so_please_give_the_following_details\"]').find('.grid-remove-rows').hide();\n\t\t$('*[data-fieldname=\"custom_if_so_please_give_the_following_details\"]').find('.grid-remove-all-rows').hide();\n\t\t$('*[data-fieldname=\"custom_if_so_please_give_the_following_details\"]').find('.grid-add-row').remove();\n    if (frm.doc.custom_member_of_epf == \"Yes\") {\n        var epf = [\"E.P.F\", \"F.P.S\", \"E.S.I\"];\n        $.each(epf, function (i, d) {\n            var child = frm.add_child('custom_if_so_please_give_the_following_details');\n            child.name1 = d;\n        });\n        frm.refresh_field('custom_if_so_please_give_the_following_details');\n    }\n},\n\tcustom_if_so_please_give_the_following_details_on_form_rendered: function (frm, cdt, cdn) {\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-delete-row').hide();\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-duplicate-row').hide();\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-move-row').hide();\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-append-row').hide();\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-insert-row-below').hide();\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-insert-row').hide();\n\t},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Attendance Permission",
  "enabled": 1,
  "modified": "2024-12-13 11:58:21.621868",
  "module": "ONEGENE",
  "name": "Attendance Permission",
  "script": "frappe.ui.form.on('Attendance Permission', {\n    refresh: function(frm) {\n\t\tfrm.trigger(\"set_employee\");\n\t},\n\tasync set_employee(frm) {\n\t\tif (frm.doc.employee) return;\n\t\tconst employee = await hrms.get_current_employee(frm);\n\t\tif (employee) {\n\t\t\tfrm.set_value(\"employee\", employee);\n\t\t}\n\t},\n\temployee(frm){\n\t    if (frm.doc.employee_category){\n\t        if (frm.doc.employee_category=='Staff'){\n\t            frm.set_value('permission_hours','2');\n\t        }\n\t        else if (frm.doc.employee_category=='Sub Staff'){\n\t            frm.set_value('permission_hours','2');\n\t        }\n\t        else{\n\t            frm.set_value('permission_hours','1');\n\t        }\n\t    }\n\t    else{\n\t        frm.set_value('permission_hours','1');\n\t    }\n\t},\n\tonload:function(frm){\n\t    if (frm.doc.permission_hours=='1'){ \n\t        if (frm.doc.employee_category=='Staff' || frm.doc.employee_category=='Sub Staff'){\n\t            frm.set_value('permission_hours','2');\n\t        }\n\t    }\n\t   // else{\n\t   //     frm.set_value('permission_hours','1');\n\t   // }\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Salary Slip",
  "enabled": 1,
  "modified": "2024-11-07 16:55:58.158460",
  "module": "ONEGENE",
  "name": "Salary Slip",
  "script": "frappe.ui.form.on('Salary Slip', {\r\n    onload(frm){\r\n        frm.trigger(\"employee\")\r\n    },\r\n    start_date(frm){\r\n        frm.trigger(\"employee\")\r\n    },\r\n\trefresh(frm) {\r\n\t\tfrappe.call({\r\n\t\t    method:\"frappe.client.get\",\r\n\t\t    args:{\r\n\t\t        doctype:\"Employee\",\r\n\t\t        filters:{\"name\":frm.doc.employee},\r\n\t\t        \"fieldname\": \"employee_category\"\r\n\t\t    },\r\n\t\t    callback(r){\r\n\t\t        if (r.message.employee_category==\"Staff\" || r.message.employee_category==\"Sub Staff\"){\r\n\t\t            frm.add_custom_button(__(\"Print PAYSLIP\"), function () {\r\n                    var f_name = frm.doc.name;\r\n                    var print_format =\"PAYSLIP-Staff\";\r\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\r\n                        + \"doctype=\" + encodeURIComponent(\"Salary Slip\")\r\n                        + \"&name=\" + encodeURIComponent(f_name)\r\n                        + \"&trigger_print=1\"\r\n                        + \"&format=\" + print_format\r\n                        + \"&no_letterhead=0\"\r\n                        + \"&letterhead=\" + encodeURIComponent\r\n                    ));\r\n\t\t            })\r\n\t\t        }\r\n\t\t        if (r.message.employee_category==\"Operator\"){\r\n\t\t            frm.add_custom_button(__(\"Print PAYSLIP\"), function () {\r\n                    var f_name = frm.doc.name;\r\n                    var print_format =\"PAYSLIP - Operators\";\r\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\r\n                        + \"doctype=\" + encodeURIComponent(\"Salary Slip\")\r\n                        + \"&name=\" + encodeURIComponent(f_name)\r\n                        + \"&trigger_print=1\"\r\n                        + \"&format=\" + print_format\r\n                        + \"&no_letterhead=0\"\r\n                        + \"&letterhead=\" + encodeURIComponent\r\n                    ));\r\n\t\t        })\r\n\t\t        }\r\n\t\t        if (r.message.employee_category==\"Trainee\"){\r\n\t\t            frm.add_custom_button(__(\"Print PAYSLIP\"), function () {\r\n                    var f_name = frm.doc.name;\r\n                    var print_format =\"Trainee\";\r\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\r\n                        + \"doctype=\" + encodeURIComponent(\"Salary Slip\")\r\n                        + \"&name=\" + encodeURIComponent(f_name)\r\n                        + \"&trigger_print=1\"\r\n                        + \"&format=\" + print_format\r\n                        + \"&no_letterhead=0\"\r\n                        + \"&letterhead=\" + encodeURIComponent\r\n                    ));\r\n\t\t        })\r\n\t\t        }\r\n\t\t        if (r.message.employee_category==\"Apprentice\"){\r\n\t\t            frappe.call({\r\n            \t\t    method:\"onegene.onegene.custom.check_pf_type\",\r\n            \t\t    args:{\r\n            \t\t        'name':frm.doc.name\r\n            \t\t    },\r\n            \t\t    callback(r){\r\n            \t\t        if (r.message == \"Without PF\"){\r\n            \t\t             console.log(\"Hi1\")\r\n            \t\t            frm.add_custom_button(__(\"Print PAYSLIP\"), function () {\r\n                                var f_name = frm.doc.name;\r\n                                var print_format =\"PAYSLIP - Apprentice\";\r\n                                window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\r\n                                    + \"doctype=\" + encodeURIComponent(\"Salary Slip\")\r\n                                    + \"&name=\" + encodeURIComponent(f_name)\r\n                                    + \"&trigger_print=1\"\r\n                                    + \"&format=\" + print_format\r\n                                    + \"&no_letterhead=0\"\r\n                                    + \"&letterhead=\" + encodeURIComponent\r\n                                ));\r\n            \t\t        })\r\n            \t\t        }\r\n            \t\t        else if (r.message == \"With PF\"){\r\n            \t\t            console.log(\"Hi2\")\r\n            \t\t            frm.add_custom_button(__(\"Print PAYSLIP\"), function () {\r\n                                var f_name = frm.doc.name;\r\n                                var print_format =\"PAYSLIP - Apprentice PF\";\r\n                                 window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\r\n                                    + \"doctype=\" + encodeURIComponent(\"Salary Slip\")\r\n                                    + \"&name=\" + encodeURIComponent(f_name)\r\n                                    + \"&trigger_print=1\"\r\n                                    + \"&format=\" + print_format\r\n                                    + \"&no_letterhead=0\"\r\n                                    + \"&letterhead=\" + encodeURIComponent\r\n                            ));\r\n            \t\t        })\r\n            \t\t        }\r\n            \t\t    }\r\n\t\t            })\r\n\t\t        }\r\n\t\t    }\r\n\t    })\r\n\t},\r\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Attendance Request",
  "enabled": 1,
  "modified": "2025-09-22 10:50:17.275495",
  "module": "ONEGENE",
  "name": "Attendance Request",
  "script": "frappe.ui.form.on('Attendance Request', {\n\trefresh: function(frm) {\n\t\tfrm.trigger(\"set_employee\");\n\t},\n    onload(frm){\n        frm.set_query(\"shift\", function() {\n            return {\n                filters: {\n                    custom_disabled: 0\n                }\n            };\n        });\n    }, \n\n\tasync set_employee(frm) {\n\t\tif (frm.doc.employee) return;\n\n\t\tconst employee = await hrms.get_current_employee(frm);\n\t\tif (employee) {\n\t\t\tfrm.set_value(\"employee\", employee);\n\t\t}\n\t},\n\tcustom_to_time(frm) {\n\t\tif(frm.doc.custom_to_time && frm.doc.custom_from_time){\n\t\t    frappe.call({\n\t\t        method:\"onegene.onegene.custom.att_req_hours\",\n\t\t        args:{\n\t\t            'custom_session':frm.doc.custom_session,\n\t\t            'custom_shift':frm.doc.custom_shift,\n\t\t            'f_time' :frm.doc.custom_from_time,\n\t\t            't_time' :frm.doc.custom_to_time,\n\t\t        },\n\t\t        callback(r){\n\t\t            if(r.message){\n\t\t                frm.set_value(\"custom_total_hours\",r.message)\n\t\t            }\n\t\t        }\n\t\t    })\n        }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Resignation Form",
  "enabled": 1,
  "modified": "2024-01-23 23:23:27.178813",
  "module": "ONEGENE",
  "name": "Resignation Form",
  "script": "frappe.ui.form.on('Resignation Form', {\n\trefresh(frm) {\n\t    if(!frm.doc.__islocal){\n\t        if (frm.doc.workflow_state == \"Approved\"){\n        \t    frm.add_custom_button(__('Full and Final Statement'),function(){\n                frappe.db.get_value('Full and Final Statement', {'employee': frm.doc.employee,'custom_resignation_form':frm.doc.name, 'docstatus': ('!=', 2)}, 'name')\n        \t\t.then(r => {\n        \t\t\tif (r.message && Object.entries(r.message).length === 0) {\n        \t\t\t\tfrappe.route_options = { 'employee': frm.doc.employee, 'custom_resignation_form': frm.doc.name };\n        \t\t\t\tfrappe.set_route('Form', 'Full and Final Statement', 'new');\n        \t\t\t}\n        \t\t\telse {\n        \t\t\t\tfrappe.set_route('Form', 'Full and Final Statement', r.message.name);\n                        frappe.model.set_value('Rejoining Form', r.message.name, 'custom_resignation_form', frm.doc.name);\n        \t\t\t}\n        \t\t});\n                });\n\t        }\n\t    }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Separation",
  "enabled": 1,
  "modified": "2024-01-23 23:25:30.367225",
  "module": "ONEGENE",
  "name": "Employee Separation",
  "script": "frappe.ui.form.on('Employee Separation', {\n\trefresh(frm) {\n\t    if(!frm.doc.__islocal){\n\t        if (frm.doc.workflow_state == \"Approved\" && frm.doc.type == \"Termination\"){\n        \t    frm.add_custom_button(__('Full and Final Statement'),function(){\n                frappe.db.get_value('Full and Final Statement', {'employee': frm.doc.employee,'custom_termination_form':frm.doc.name, 'docstatus': ('!=', 2)}, 'name')\n        \t\t.then(r => {\n        \t\t\tif (r.message && Object.entries(r.message).length === 0) {\n        \t\t\t\tfrappe.route_options = { 'employee': frm.doc.employee, 'custom_termination_form': frm.doc.name };\n        \t\t\t\tfrappe.set_route('Form', 'Full and Final Statement', 'new');\n        \t\t\t}\n        \t\t\telse {\n        \t\t\t\tfrappe.set_route('Form', 'Full and Final Statement', r.message.name);\n                        frappe.model.set_value('Rejoining Form', r.message.name, 'custom_termination_form', frm.doc.name);\n        \t\t\t}\n        \t\t});\n                });\n\t        }\n\t    }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Manpower Plan",
  "enabled": 1,
  "modified": "2024-01-23 23:27:53.867726",
  "module": "ONEGENE",
  "name": "Manpower Plan",
  "script": "frappe.ui.form.on('Manpower Plan', {\n\tsetup: function(frm){\n\t    frm.set_query(\"department\", function() {\n\t\t\treturn {\n\t\t\t\tfilters: {\n\t\t\t\t\t\"is_group\":0,\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Reports Dashboard",
  "enabled": 1,
  "modified": "2024-06-24 18:08:03.195098",
  "module": "ONEGENE",
  "name": "Reports Dashboard",
  "script": "frappe.ui.form.on('Reports Dashboard', {\n\tfrom_date: function(frm) {\n\t    if (frm.doc.report == 'Bulk Salary Slip Report'){\n\n    \t\tif (frm.doc.from_date) {\n    \t\t\tvar a_year_from_start = frappe.datetime.add_months(frm.doc.from_date, 1);\n    \t\t\tfrm.set_value(\"to_date\", frappe.datetime.add_days(a_year_from_start, -1));\n    \t\t}\n\t    }\n\t    \n\t\tif (frm.doc.report != 'Bulk Salary Slip Report'){\n\t\t    frm.set_df_property('to_date', 'read_only', 0);\n\t\t}\n\t\telse{\n\t\t    frm.set_df_property('to_date', 'read_only', 1);\n\t\t    \n\t\t}\n\n\t},\n\tdate(frm){\n\t    today = frappe.datetime.get_today();\n\t    if(frm.doc.date > today){\n\t        frappe.msgprint('You can not select future dates');\n\t    }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Checkin",
  "enabled": 1,
  "modified": "2024-04-30 11:54:59.020646",
  "module": "ONEGENE",
  "name": "Employee Checkin - List",
  "script": "frappe.listview_settings[\"Employee Checkin\"] = {\nhide_name_column : true,\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payroll Entry",
  "enabled": 0,
  "modified": "2024-05-06 19:38:20.708326",
  "module": "ONEGENE",
  "name": "Payroll Entry",
  "script": "frappe.ui.form.on('Payroll Entry', {\n\trefresh(frm) {\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Compensatory Leave Request",
  "enabled": 1,
  "modified": "2024-09-21 11:19:07.907280",
  "module": "ONEGENE",
  "name": "Compensatory Leave Request",
  "script": "frappe.ui.form.on('Compensatory Leave Request', {\n    work_end_date(frm) {\n        console.log(\"HI\");\n        const thresholdDate = new Date(\"2024-04-30\"); // Corrected the month and date\n        if (frm.doc.work_from_date && new Date(frm.doc.work_from_date) > thresholdDate) {\n            console.log(\"HI\");\n            frappe.call({\n\t\t\tmethod:'onegene.onegene.utils.get_details_for_ot_coff',\n\t\t\targs:{\n\t\t\t\temployee:frm.doc.employee,\n\t\t\t\twork_from_date:frm.doc.work_from_date,\n\t\t\t\twork_end_date:frm.doc.work_end_date\n\t\t\t},\n\t\t\tcallback(r){\n                frm.set_value('custom_total_ot_hours',r.message[0]);\n                frm.set_value('custom_used_ot_hours_',r.message[1]);\n\t\t\t\tfrm.set_value('custom_available_ot_hours',r.message[2]);\n\t\t\t\tfrm.set_value('custom_available_coff_days',r.message[3]);\n\t\t\t\tfrm.set_value('custom_available_ot_hours_excluded_available_coff',r.message[4]);\n            }\n        });\n        }\n    },\n    employee(frm){\n        console.log(\"hi\")\n        if (frm.doc.custom_employee_category!=\"Staff\" && frm.doc.custom_employee_category!=\"Sub Staff\"){\n            frappe.throw('Staff and sub-staff are only eligible to raise a compensatory off request.')\n        }\n    },\n    validate(frm){\n        console.log(\"hi\")\n        if (frm.doc.custom_employee_category!=\"Staff\" && frm.doc.custom_employee_category!=\"Sub Staff\"){\n            frappe.throw('Staff and sub-staff are only eligible to raise a compensatory off request.')\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-06-21 12:01:10.067170",
  "module": "ONEGENE",
  "name": "Purchase Order List",
  "script": "frappe.listview_settings['Purchase Order'] = {\r\n    onload: function(listview) {\r\n        if (frappe.user.has_role(\"Purchase Manager\") || frappe.user.has_role(\"System Manager\")) {\r\n            listview.page.add_inner_button(\"Import Schedule\", function() {\r\n                frappe.set_route('purchase-order-schedule-settings')\r\n            });\r\n        }\r\n        if (frappe.user.has_role(\"Supplier\")) {\r\n             if (!frappe.user.has_role(\"System Manager\")) {\r\n                listview.filter_area.add([[ \r\n                                        \"Purchase Order\", \"docstatus\", \"=\", 1\r\n                                    ]]);\r\n                frappe.after_ajax(() => {\r\n                    $('.filter-selector').hide();\r\n    \r\n                    $('.btn-filter-add').hide();\r\n                    $('.btn-remove').hide();\r\n                })\r\n             }\r\n        }\r\n        else {\r\n            if (!frappe.user.has_role(\"System Manager\")) {\r\n                frappe.after_ajax(() => {\r\n                    // Hide the filter selector\r\n                    $('.filter-selector').show();\r\n    \r\n                    // show the 'Add Filter' and 'Remove' buttons\r\n                    $('.btn-filter-add').show();\r\n                    $('.btn-remove').show();\r\n                });\r\n            }\r\n        }\r\n    },\r\n    // refresh: function(listview) {\r\n    //     $(`.list-row-col:contains(Grand Total)`).hide();\r\n    // }\r\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order Schedule",
  "enabled": 1,
  "modified": "2025-11-22 10:35:35.264279",
  "module": "ONEGENE",
  "name": "Purchase Order Schedule List",
  "script": "let core_settings = frappe.listview_settings['Purchase Order Schedule'] || {};\nfrappe.listview_settings['Purchase Order Schedule'] = {\n    ...core_settings,\n    onload: function(listview) {\n\n        listview.filter_area.clear().then(r => {\n\n            const currentMonth = new Date().toLocaleString('default', {\n                month: 'short'\n            }).toUpperCase();\n\n\n            listview.filter_area.add([\n                [\n                    \"Purchase Order Schedule\", \"schedule_month\", \"=\", currentMonth\n                ]\n            ]);\n\n            if (frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System Manager\")) {\n                listview.page.add_inner_button(\"Import Schedule\", function() {\n                    frappe.set_route('purchase-order-schedule-settings')\n                });\n            }\n\n\n\n            if (frappe.user.has_role(\"Supplier\")) {\n                if (!frappe.user.has_role(\"System Manager\")) {\n                    listview.filter_area.clear();\n                    listview.filter_area.add([\n                        [\n                            \"Purchase Order Schedule\", \"docstatus\", \"=\", 1\n                        ]\n                    ]);\n\n                    frappe.after_ajax(() => {\n\n\n\n                        const allowed_filters = [\"docstatus\"];\n\n                        // Remove any existing filters that are not allowed\n                        listview.filter_area.filter_list.get_filters().forEach(f => {\n                            const fieldname = f[1];\n                            const operator = f[2];\n                            const value = f[3];\n\n                            if (!allowed_filters.includes(fieldname)) {\n                                listview.filter_area.remove(fieldname, operator, value);\n                            }\n                        });\n\n\n\n\n\n\n\n                        // Hide the filter selector\n                        $('.filter-selector').hide();\n\n                        // Hide the 'Add Filter' and 'Remove' buttons\n                        $('.btn-filter-add').hide();\n                        $('.btn-remove').hide();\n                    });\n                }\n            }\n\n\n        })\n\n\n\n    },\n\n    refresh: function(listview) {\n        if (frappe.user.has_role(\"Supplier\")) {\n            if (!frappe.user.has_role(\"System Manager\")) {\n                //  listview.filter_area.clear();\n                //   listview.filter_area.add([[ \n                //                     \"Purchase Order Schedule\", \"docstatus\", \"=\", 1\n                //                 ]]);\n\n\n                frappe.after_ajax(() => {\n\n\n\n                    const allowed_filters = [\"name\", \"docstatus\"];\n\n                    // Remove any existing filters that are not allowed\n\n                    listview.filter_area.filter_list.get_filters().forEach(f => {\n                        const fieldname = f[1];\n                        const operator = f[2];\n                        const value = f[3];\n\n                        if (!allowed_filters.includes(fieldname)) {\n                            listview.filter_area.remove(fieldname, operator, value);\n                        }\n                    });\n\n\n\n\n\n\n                    // Hide the filter selector\n                    $('.filter-selector').hide();\n\n                    // Hide the 'Add Filter' and 'Remove' buttons\n                    $('.btn-filter-add').hide();\n                    $('.btn-remove').hide();\n                });\n            }\n        }\n        \n        listview.page.add_inner_button(__('Supplier Wise'), function() {\n            const filters = listview.filter_area.get();\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\n\n            const year = new Date().getFullYear().toString().slice(-2);\n\n            if (!mon) {\n                mon = new Date().toLocaleString('default', {\n                    month: 'short'\n                }).toUpperCase();\n            }\n\n            frappe.call({\n                method: \"onegene.onegene.custom.supplier_wise_plan_summary\",\n                args: {\n                    month: mon,\n                    year: year\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        tableHTML = r.message\n                        let dialog = new frappe.ui.Dialog({\n                            title: __(\"Supplier Wise Purchase Plan\"),\n                            size: \"extra-large\", // Correct usage\n                            fields: [{\n                                fieldtype: \"HTML\",\n                                fieldname: \"department_wise_table\",\n                                options: tableHTML\n                            }]\n                        });\n\n                        dialog.show();\n                    }\n                }\n            });\n        }, __('Summary Value'));\n        \n        listview.page.add_inner_button(__('Department Wise'), function() {\n            const filters = listview.filter_area.get();\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\n\n            const year = new Date().getFullYear().toString().slice(-2);\n\n            if (!mon) {\n                mon = new Date().toLocaleString('default', {\n                    month: 'short'\n                }).toUpperCase();\n            }\n\n            frappe.call({\n                method: \"onegene.onegene.custom.department_wise_plan_pos\",\n                args: {\n                    month: mon\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        const groupedData = r.message;\n                        const departments = Object.keys(groupedData) // sorted for clarity\n                        let grandTotal = 0;\n\n                        let tableHTML = `\n                    <style>\n                        table {\n                            width: 100%;\n                            border-collapse: collapse;\n                            font-size: 13px;\n                        }\n                        th, td {\n                            border: 1px solid #000;\n                            padding: 8px;\n                            text-align: left;\n                        }\n                        th {\n                            background-color: #ffc000;\n                            color: black;\n                            text-align: center;\n                        }\n                        .title-row td {\n                            font-size: 18px;\n                            font-weight: bold;\n                            text-align: center;\n                            border: none;\n                            padding: 12px 0;\n                        }\n                        .total-row {\n                            background-color: #ffff00;\n                            font-weight: bold;\n                        }\n                        .right-align {\n                            text-align: right;\n                        }\n                    </style>\n\n                    <table>\n                        \n                        <thead>\n                        <tr >\n                            <td colspan=\"2\" style=\"text-align:center; font-size:20px; font-weight:bold; color:black;\">Department Wise Purchase Plan - ${mon}'${year}</td>\n                        </tr>\n                            <tr>\n                                <th style=\"color:black;\">Department</th>\n                                <th style=\"color:#2206f6;\">Schedule Value</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                `;\n\n                        departments.forEach(dep => {\n                            let amount = groupedData[dep] || 0;\n                            amount = Math.round(amount);\n                            grandTotal += amount;\n\n                            tableHTML += `\n                        <tr>\n                            <td style=\"color:black;\">${dep}</td>\n                            <td class=\"right-align\" style=\"color:black;\">${amount === 0 ? \"-\" : \"₹ \" + amount.toLocaleString()}</td>\n                        </tr>\n                    `;\n                        });\n\n                        // Add TOTAL row\n                        tableHTML += `\n                    <tr class=\"total-row\">\n                        <td style=\"color:black;\">TOTAL</td>\n                        <td class=\"right-align;\" style=\" text-align:right; color:black;\">₹ ${grandTotal.toLocaleString()}</td>\n                    </tr>\n                `;\n\n                        tableHTML += `</tbody></table>`;\n\n                        let dialog = new frappe.ui.Dialog({\n                            title: __(\"Department Wise Purchase Plan\"),\n                            fields: [{\n                                fieldtype: \"HTML\",\n                                fieldname: \"department_wise_table\",\n                                options: tableHTML\n                            }],\n                            size: 'medium'\n                        });\n\n                        dialog.show();\n                    }\n                }\n            });\n        }, __('Summary Value'));\n\n        listview.page.add_inner_button(__('Supplier Group Wise'), function() {\n            const filters = listview.filter_area.get();\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\n\n            const year = new Date().getFullYear().toString().slice(-2);\n\n            if (!mon) {\n                mon = new Date().toLocaleString('default', {\n                    month: 'short'\n                }).toUpperCase();\n            }\n\n            frappe.call({\n                method: \"onegene.onegene.custom.supplier_group_wise\",\n                args: {\n                    month: mon\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        const groupedData = r.message;\n                        const departments = Object.keys(groupedData) // sorted for clarity\n                        let grandTotal = 0;\n\n                        let tableHTML = `\n                    <style>\n                        table {\n                            width: 100%;\n                            border-collapse: collapse;\n                            font-size: 13px;\n                        }\n                        th, td {\n                            border: 1px solid #000;\n                            padding: 8px;\n                            text-align: left;\n                        }\n                        th {\n                            background-color: #ffc000;\n                            color: black;\n                            text-align: center;\n                        }\n                        .title-row td {\n                            font-size: 18px;\n                            font-weight: bold;\n                            text-align: center;\n                            border: none;\n                            padding: 12px 0;\n                        }\n                        .total-row {\n                            background-color: #ffff00;\n                            font-weight: bold;\n                        }\n                        .right-align {\n                            text-align: right;\n                        }\n                    </style>\n\n                    <table>\n                        \n                        <thead>\n                        <tr >\n                            <td colspan=\"2\" style=\"text-align:center; font-size:20px; font-weight:bold; color:black;\">Supplier Group Wise Purchase Plan - ${mon}'${year}</td>\n                        </tr>\n                            <tr>\n                                <th style=\"color:black;\">Supplier Group</th>\n                                <th style=\"color:#2206f6;\">Schedule Value</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                `;\n\n                        departments.forEach(dep => {\n                            let amount = groupedData[dep] || 0;\n                            amount = Math.round(amount);\n                            grandTotal += amount;\n\n                            tableHTML += `\n                        <tr>\n                            <td style=\"color:black;\">${dep}</td>\n                            <td class=\"right-align\" style=\"color:black;\">${amount === 0 ? \"-\" : \"₹ \" + amount.toLocaleString()}</td>\n                        </tr>\n                    `;\n                        });\n\n                        // Add TOTAL row\n                        tableHTML += `\n                    <tr class=\"total-row\">\n                        <td style=\"color:black;\">TOTAL</td>\n                        <td class=\"right-align;\" style=\" text-align:right; color:black;\">₹ ${grandTotal.toLocaleString()}</td>\n                    </tr>\n                `;\n\n                        tableHTML += `</tbody></table>`;\n\n                        let dialog = new frappe.ui.Dialog({\n                            title: __(\"Supplier Group Wise Purchase Plan\"),\n                            fields: [{\n                                fieldtype: \"HTML\",\n                                fieldname: \"department_wise_table\",\n                                options: tableHTML\n                            }],\n                            size: 'medium'\n                        });\n\n                        dialog.show();\n                    }\n                }\n            });\n        }, __('Summary Value'));\n\n        \n\n\n\n\n\n\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Advance Shipping Note",
  "enabled": 0,
  "modified": "2025-11-18 12:30:37.666248",
  "module": "ONEGENE",
  "name": "Supplier Delivery Note List",
  "script": "frappe.listview_settings['Advance Shipping Note'] = {\r\n    onload: function(listview) {\r\n        \r\n        var currentMonth = new Date().toLocaleString('default', { month: 'short' }).toUpperCase();\r\n        var currentUrl = new URL(window.location.href);\r\n        const user = frappe.session.user;\r\n        if (frappe.user.has_role(\"Security\")) {\r\n            if (!frappe.user.has_role(\"System Manager\")) {\r\n                listview.filter_area.clear();\r\n                // listview.filter_area.add([\r\n                //     [\"Supplier Delivery Note\", \"workflow_state\", \"not in\", [\"Draft\", \"Cancelled\"]],\r\n                // ]);\r\n                var targetUrl = `https://erp.onegeneindia.in/app/advance-shipping-note?workflow_state=%5B%22not+in%22%2C%5B%22Draft%22%2C%22Cancelled%22%5D%5D&month=${currentMonth}`;\r\n                if (currentUrl.href != targetUrl) {\r\n                    window.location.href = targetUrl;\r\n                }\r\n                frappe.after_ajax(() => {\r\n                    $('.filter-selector').hide();\r\n                });\r\n            }\r\n        }\r\n        \r\n         if (frappe.user.has_role(\"SDN User\")) {\r\n             if (!frappe.user.has_role(\"System Manager\")) {\r\n                if (listview.page.fields_dict.workflow_state) {\r\n        \t\t\tlistview.page.fields_dict.workflow_state.get_query = function() {\r\n        \t\t\t\treturn {\r\n        \t\t\t\t\t\"filters\": {\r\n        \t\t\t\t\t\t\"name\": [\"in\", [\"Gate Received\", \"Material Received\"]],\r\n        \t\t\t\t\t}\r\n        \t\t\t\t};\r\n        \t\t\t};\r\n        \t\t}\r\n             }\r\n        }\r\n        if (frappe.user.has_role(\"Security\")) {\r\n             if (!frappe.user.has_role(\"System Manager\")) {\r\n                if (listview.page.fields_dict.workflow_state) {\r\n        \t\t\tlistview.page.fields_dict.workflow_state.get_query = function() {\r\n        \t\t\t\treturn {\r\n        \t\t\t\t\t\"filters\": {\r\n        \t\t\t\t\t\t\"name\": [\"in\", [\"In Transit\"]],\r\n        \t\t\t\t\t}\r\n        \t\t\t\t};\r\n        \t\t\t};\r\n        \t\t}\r\n             }\r\n        }\r\n        else {\r\n            \r\n            targetUrl = `https://erp.onegeneindia.in/app/advance-shipping-note?month=${currentMonth}`;\r\n            if (currentUrl.href != targetUrl) {\r\n                window.location.href = targetUrl;\r\n            }\r\n            if (listview.page.fields_dict.workflow_state) {\r\n    \t\t\tlistview.page.fields_dict.workflow_state.get_query = function() {\r\n    \t\t\t\treturn {\r\n    \t\t\t\t\t\"filters\": {\r\n    \t\t\t\t\t\t\"name\": [\"in\", [\"Draft\", \"In Transit\", \"Gate Received\", \"Material Received\"]],\r\n    \t\t\t\t\t}\r\n    \t\t\t\t};\r\n    \t\t\t};\r\n    \t\t}\r\n        }\r\n        \r\n    },\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM",
  "enabled": 0,
  "modified": "2025-05-05 15:43:31.876557",
  "module": "ONEGENE",
  "name": "BOM - List",
  "script": "\nfrappe.listview_settings['BOM'] = {\n    onload: function(listview) {\n        listview.page.add_action_item(__(\"Next Action\"), () => {\n            const docnames = listview.get_checked_items(true);\n\t\t\t\t\tif (docnames.length > 0) {\n\t\t\t\t\t\tfrappe.confirm(\n\t\t\t\t\t\t\t__(\n\t\t\t\t\t\t\t\t\"Submit {0} documents?\",\n\t\t\t\t\t\t\t\t[docnames.length],\n\t\t\t\t\t\t\t\t\"Title of confirmation dialog\"\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t    frappe.call({\n                    \t\t\t\tmethod: \"onegene.onegene.custom.submit_cancel_or_update_docs\",\n                    \t\t\t\targs: {\n                    \t\t\t\t\tdoctype: 'BOM',\n                    \t\t\t\t\taction: 'submit',\n                    \t\t\t\t\tdocnames: docnames,\n                    \t\t\t\t},\n                    \t\t\t})\n                    \t\t\t.then((r) => {\n                    \t\t\t\tlet failed = r.message;\n                    \t\t\t\tif (!failed) failed = [];\n                    \n                    \t\t\t\tif (failed.length && !r._server_messages) {\n                    \t\t\t\t\tfrappe.throw(\n                    \t\t\t\t\t\t__(\"Cannot {0} {1}\", [action, failed.map((f) => f.bold()).join(\", \")])\n                    \t\t\t\t\t);\n                    \t\t\t\t}\n                    \t\t\t\tif (failed.length < docnames.length) {\n                    \t\t\t\t\tfrappe.utils.play_sound(action);\n                    \t\t\t\t\tif (done) done();\n                    \t\t\t\t}\n                    \t\t\t});\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n        })\n    }\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-11-26 16:17:00.680869",
  "module": "ONEGENE",
  "name": "Sales Invoice",
  "script": "frappe.ui.form.on('Sales Invoice', {\n    validate(frm) {\n        if (frm.doc.custom_tentative_production_completion_date && (frm.doc.custom_tentative_production_completion_date <= frm.doc.posting_date)) {\n            frappe.msgprint(\"Tentative Production Completion Date cannot be less than the Invoice Date\")\n            frappe.msgprint(\"Tentative Production Completion Date, Invoice Date-ஐவிட குறைவாக இருக்க முடியாது\")\n            frappe.validated = false\n        }\n        frm.trigger('calculate_total_cbm');\n        // frm.trigger('calculate_container_occupancy');\n\n    },\n    custom_tentative_production_completion_date(frm) {\n        if (frm.doc.custom_tentative_production_completion_date && (frm.doc.custom_tentative_production_completion_date <= frm.doc.posting_date)) {\n            frappe.msgprint(\"Tentative Production Completion Date cannot be less than the Invoice Date\")\n            frappe.msgprint(\"Tentative Production Completion Date, Invoice Date-ஐவிட குறைவாக இருக்க முடியாது\")\n\n        }\n    },\n    refresh(frm) {\n         let max_boxes_per_pallet = 0;\n        let min_boxes_per_pallet = Infinity;   \n        \n        (frm.doc.items || []).forEach(row => {\n            let pallets = row.custom_no_of_pallets || 1;\n            let boxes = row.custom_no_of_boxes || 1;\n        \n            let boxes_per_pallet = Math.ceil(boxes / pallets);\n        \n            if (boxes_per_pallet > max_boxes_per_pallet) {\n                max_boxes_per_pallet = boxes_per_pallet;\n            }\n        \n            if (boxes_per_pallet < min_boxes_per_pallet) {\n                min_boxes_per_pallet = boxes_per_pallet;\n            }\n        });\n\n\n\n\n\n        // correct condition\n        if (min_boxes_per_pallet <= 20 && max_boxes_per_pallet > 20) {\n\n            frm.add_custom_button(\"Pallet Landscape\", function () {\n\n                let url = \"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    \"doctype=Sales%20Invoice\" +\n                    \"&name=\" + encodeURIComponent(frm.doc.name) +\n                    \"&trigger_print=1\" +\n                    \"&format=Pallet%20Landscape\" +\n                    \"&no_letterhead=0\";\n\n                window.open(frappe.urllib.get_full_url(url));\n            }, __(\"Print\"));\n\n        }\n        if (max_boxes_per_pallet > 20) {\n\n            frm.add_custom_button(\"Pallet Portrait\", function () {\n\n                let url = \"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    \"doctype=Sales%20Invoice\" +\n                    \"&name=\" + encodeURIComponent(frm.doc.name) +\n                    \"&trigger_print=1\" +\n                    \"&format=Pallet%20Portrait\" +\n                    \"&no_letterhead=0\";\n\n                window.open(frappe.urllib.get_full_url(url));\n            }, __(\"Print\"));\n\n        }\n        // QID data will be loaded from the Quality Inspection which are went to Store Receipt\n        if (frm.fields_dict['custom_scan_qid']) {\n            frm.fields_dict['custom_scan_qid'].input.onfocus = function() {\n                const exclude_qids = (frm.doc.items || []).map(row => row.custom_qid).filter(Boolean);\n                // Fetch options excluding those QIDs\n                let result = exclude_qids\n                    .flatMap(item => item.split(',')); \n                frappe.call({\n                    method: \"onegene.onegene.custom.get_inspection_ids\",\n                    args: {\n                        \"exclude_qids\": result,\n                        \"customer\": frm.doc.customer,\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            frm.fields_dict.custom_scan_qid.set_data(r.message);\n                        }\n                    }\n                });\n            }\n        }\n        set_required_fields(frm)\n        refresh_stock_pick_list(frm);\n        setTimeout(() => {\n            frm.remove_custom_button('Quality Inspection(s)', 'Create');\n        }, 50);\n\n        if (!frm.doc.__islocal && frm.doc.docstatus == 1 && frm.doc.custom_invoice_type == \"Tax Invoice\") {\n            var f_name = frm.doc.name;\n            frm.add_custom_button(__(\"Tax Invoice\"), function() {\n                var print_format = \"Tax Invoice Print format\";\n                window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                    \"&name=\" + encodeURIComponent(f_name) +\n                    \"&trigger_print=1\" +\n                    \"&format=\" + print_format +\n                    \"&no_letterhead=0\"\n                ));\n            }, __('Print'));\n        }\n        if (!frm.doc.__islocal && frm.doc.docstatus != 2 && frm.doc.custom_invoice_type == \"Tax Invoice\") {\n            frm.add_custom_button(__(\"Tax Invoice\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_view_tax\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n        }\n\n        // frm.page.clear_primary_action(); \n        frm.remove_custom_button('Fetch Timesheet');\n        if (frm.doc.workflow_state !== 'Approved' || frm.doc.workflow_state != 'Dispatched') {\n            $(\"button[data-original-title='Print']\").hide();\n\n        }\n\n\n\n        update_fields_based_on_items(frm);\n        if (frm.doc.custom_invoice_type != \"Tax Invoice\") {\n            frm.add_custom_button(__(\"Export Invoice\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_EI\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Annexure\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_annexure\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Pallet\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_pallet\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Address\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_address\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"80%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n        }\n\n        if (frm.doc.docstatus == 0 && frappe.user.has_role(\"System Manager\")) {\n            frm.set_df_property(\"set_posting_time\", \"hidden\", 0)\n        } else {\n            frm.set_df_property(\"set_posting_time\", \"hidden\", 1)\n        }\n\n        // $( \".transactions .document-link .icon-btn  \" ).hide();\n        frm.trigger('container_occupancy_html')\n        if (frm.doc.custom_scope_of_delivery) {\n            frm.set_query(\"incoterm\", function() {\n                return {\n                    filters: {\n                        \"custom_type\": frm.doc.custom_scope_of_delivery\n                    }\n                }\n            })\n        }\n        if (frm.doc.custom_total_cbm > 76.4) {\n            frm.set_df_property('seacontainertype', 'read_only', 0)\n            frm.set_df_property('custom_no_of_containers', 'hidden', 0)\n        } else {\n            frm.set_df_property('custom_no_of_containers', 'hidden', 1)\n        }\n        if (!frm.doc.__islocal && frm.doc.docstatus == 0 && frm.doc.custom_invoice_type == \"Export Invoice\" && ['Waiting for LR Request'].includes(frm.doc.workflow_state)) {\n            if (frappe.user.has_role(\"Sales User\") || frappe.user.has_role(\"Sales Manager\") || frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System manager\")) {\n\n                frm.add_custom_button(__('Logistics Request'), function() {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.logistics_request.logistics_request.get_box_summary\",\n                        args: {\n                            sales_invoice: frm.doc.name\n                        },\n                        callback: function(r) {\n                            if (r.message) {\n\n                                frappe.db.get_value(\"Logistics Request\", {\n                                    \"order_no\": frm.doc.name\n                                }, \"name\").then(i => {\n                                    if (i && i.message.name) {\n                                        frappe.msgprint(__('Logistic Request already created <b>{0}</b>', [i.message.name]));\n                                        frappe.msgprint(__('Logistic Request <b>{0}</b> ஏற்கனவே உருவாக்கப்பட்டுள்ளது', [i.message.name]));\n                                    } else {\n\n\n\n                                        const [box_data, pallet_data] = r.message;\n                                        frappe.model.with_doctype('Logistics Request', function() {\n                                            let doc = frappe.model.get_new_doc('Logistics Request');\n                                            doc.logistic_type = \"Export\";\n                                            doc.po_so = \"Sales Invoice\";\n                                            doc.cargo_type = frm.doc.custom_cargo_mode;\n                                            doc.shipping_line = frm.doc.custom_cargo_mode;\n                                            doc.order_no = frm.doc.name;\n                                            doc.customer = frm.doc.customer;\n                                            doc.tentative_production_completion = frm.doc.custom_tentative_production_completion_date;\n                                            doc.gross_wt = frm.doc.custom_total_gross_weight;\n                                            doc.net_wt = frm.doc.total_net_weight;\n                                            doc.seacontainertype = frm.doc.seacontainertype;\n                                            doc.scope_of_delivery = frm.doc.custom_scope_of_delivery;\n                                            doc.cbm = frm.doc.custom_total_cbm;\n                                            doc.inventory_destination = \"Direct to Customer\";\n                                            (frm.doc.items || []).forEach(item => {\n                                                let child = frappe.model.add_child(doc, \"product_description_so\");\n\n                                                Object.keys(item).forEach(field => {\n                                                    if (![\"doctype\", \"name\", \"parent\", \"parentfield\", \"parenttype\", \"__unsaved\", \"idx\"].includes(field)) {\n                                                        child[field] = item[field];\n                                                    }\n                                                });\n                                            });\n\n                                            (box_data || []).forEach(row => {\n                                                let child = frappe.model.add_child(doc, \"box_summary_table\");\n                                                child.box = row.box;\n                                                child.total_no_of_box = row.total_no_of_box;\n                                                child.weight_per_unit = row.weight_per_unit;\n                                                child.total_weight = row.total_weight;\n                                                child.total_length = row.total_length;\n                                                child.total_breadth = row.total_breadth;\n                                                child.total_height = row.total_height;\n                                            });\n                                            (pallet_data || []).forEach(pal => {\n                                                let child = frappe.model.add_child(doc, \"pallet_summary\");\n                                                child.pallet = pal.box;\n                                                child.total_no_of_pallet = pal.total_no_of_box;\n                                                child.weight_per_unit = pal.weight_per_unit;\n                                                child.total_weight = pal.total_weight;\n                                                child.total_length = pal.total_length;\n                                                child.total_breadth = pal.total_breadth;\n                                                child.total_height = pal.total_height;\n                                            });\n\n                                            // frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n                                            frappe.db.insert(doc).then(new_doc => {\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} is created`);\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} உருவாக்கப்பட்டுள்ளது`);\n                                                frm.reload_doc()\n                                            });\n                                        });\n\n\n\n                                    }\n                                })\n\n\n                            } else {\n\n\n\n                                frappe.db.get_value(\"Logistics Request\", {\n                                    \"order_no\": frm.doc.name\n                                }, \"name\").then(i => {\n                                    if (i && i.message.name) {\n\n\n                                        frappe.set_route(\"Form\", \"Logistics Request\", i.message.name);\n                                    } else {\n\n\n\n                                        frappe.model.with_doctype('Logistics Request', function() {\n                                            let doc = frappe.model.get_new_doc('Logistics Request');\n                                            doc.logistic_type = \"Export\";\n                                            doc.po_so = \"Sales Invoice\";\n                                            doc.cargo_type = frm.doc.custom_cargo_mode;\n                                            doc.shipping_line = frm.doc.custom_cargo_mode;\n                                            doc.order_no = frm.doc.name;\n                                            doc.gross_wt = frm.doc.custom_total_gross_weight;\n                                            doc.net_wt = frm.doc.total_net_weight;\n                                            doc.seacontainertype = frm.doc.seacontainertype;\n                                            doc.cbm = frm.doc.custom_total_cbm;\n                                            doc.tentative_production_completion = frm.doc.custom_tentative_production_completion_date;\n                                            doc.scope_of_delivery = frm.doc.custom_scope_of_delivery;\n                                            doc.inventory_destination = \"Direct to Customer\";\n\n                                            // frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n\n                                            frappe.db.insert(doc).then(new_doc => {\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} is created`);\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} உருவாக்கப்பட்டுள்ளது`);\n                                            });\n                                        });\n\n                                    }\n                                })\n                            }\n                        }\n                    });\n\n\n                }, __('Create'))\n\n            }\n        }\n\n\n\n        if (frm.doc.docstatus != 2 && frm.doc.custom_invoice_type == \"Export Invoice\") {\n            var f_name = frm.doc.name;\n            frappe.db.get_value(\"Logistics Request\", {\n                \"order_no\": frm.doc.name\n            }, \"name\").then(r => {\n                if (frm.doc.docstatus == 1) {\n                    frm.add_custom_button(__(\"Export Invoice\"), function() {\n                        var print_format = \"Export Invoice Print New\";\n                        window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                            \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                            \"&name=\" + encodeURIComponent(f_name) +\n                            \"&trigger_print=1\" +\n                            \"&format=\" + print_format +\n                            \"&no_letterhead=0\"\n                        ));\n                    }, __('Print'));\n                }\n\n                if (r.message && r.message.name) {\n                    frm.add_custom_button(__(\"Packing List\"), function() {\n                        var print_format = \"Packing List\";\n                        window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                            \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                            \"&name=\" + encodeURIComponent(f_name) +\n                            \"&trigger_print=1\" +\n                            \"&format=\" + print_format +\n                            \"&no_letterhead=0\"\n                        ));\n                    }, __('Print'));\n                    frm.add_custom_button(__(\"Packing List\"), function() {\n                        frappe.call({\n                            method: \"onegene.onegene.custom.create_html_packing\",\n                            args: {\n                                doc: frm.doc\n                            },\n                            callback: function(r) {\n                                if (r.message && r.message.html) {\n                                    let d = new frappe.ui.Dialog({\n\n                                        size: \"large\",\n                                        primary_action_label: __(\"Close\"),\n                                        primary_action: function() {\n                                            d.hide();\n                                        }\n                                    });\n                                    d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                                    d.$body.html(r.message.html);\n                                    d.show();\n                                } else {\n                                    frappe.msgprint(__(\"Unable to load preview\"));\n                                    frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                                }\n                            }\n                        });\n                    }, __(\"Report View\"));\n\n                }\n\n                frm.add_custom_button(__(\"Annexure\"), function() {\n                    var print_format = \"Annexure Print\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n\n                frm.add_custom_button(__(\"Pallet\"), function() {\n                    var print_format = \"Pallet\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n                \n\n       \n    \n            \n\n                frm.add_custom_button(__(\"Address\"), function() {\n                    var print_format = \"Address Print\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n            });\n        }\n\n\n\n\n\n\n\n\n\n        // frm.add_custom_button(__(\"Packing List\"), function() {\n        //     var f_name = frm.doc.name\n        //     var print_format = \"Packing List\";\n        //     window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n        //         \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n        //         \"&name=\" + encodeURIComponent(f_name) +\n        //         \"&trigger_print=1\" +\n        //         \"&format=\" + print_format +\n        //         \"&no_letterhead=0\"\n        //     ));\n        // });\n        frm.fields_dict.items.grid.get_field('custom_box').get_query = function(doc, cdt, cdn) {\n            let row = locals[cdt][cdn];\n            return {\n                filters: {\n                    \"name\": [\"in\", get_boxes(row.item_code)]\n                }\n            };\n        };\n        frm.fields_dict.items.grid.get_field('custom_pallet').get_query = function(doc, cdt, cdn) {\n            let row = locals[cdt][cdn];\n            return {\n                filters: {\n                    \"name\": [\"in\", get_pallets(row.item_code)]\n                }\n            };\n        };\n        // if (frm.doc.docstatus == 1 && frm.doc.custom_invoice_type == \"Export Invoice\") {\n        //     frm.add_custom_button(__('Logistics Request'), function() {\n        //         frappe.call({\n        //             method: \"onegene.onegene.doctype.logistics_request.logistics_request.get_box_summary\",\n        //             args: {\n        //                 sales_invoice: frm.doc.name\n        //             },\n        //             callback: function(r) {\n        //                 if (r.message) {\n\n\n        //                     frappe.db.get_value(\"Logistics Request\",{\"order_no\":frm.doc.name},\"name\").then(i=>{\n        //                         if (i && i.message.name) {\n\n\n        //                             frappe.set_route(\"Form\", \"Logistics Request\", i.message.name);\n        //                         }\n\n        //                         else{\n\n\n        //                     const [box_data, pallet_data] = r.message;\n        //                     frappe.model.with_doctype('Logistics Request', function() {\n        //                         let doc = frappe.model.get_new_doc('Logistics Request');\n        //                         doc.logistic_type = \"Export\";\n        //                         doc.po_so = \"Sales Invoice\";\n        //                         doc.cargo_type = frm.doc.custom_cargo_mode;\n        //                         doc.order_no = frm.doc.name;\n        //                         doc.gross_wt = frm.doc.custom_total_gross_weight;\n        //                         doc.net_wt = frm.doc.total_net_weight;\n        //                         doc.seacontainertype = frm.doc.seacontainertype;\n        //                         doc.cbm = frm.doc.custom_total_cbm;\n        //                         (box_data || []).forEach(row => {\n        //                             let child = frappe.model.add_child(doc, \"box_summary_table\");\n        //                             child.box = row.box;\n        //                             child.total_no_of_box = row.total_no_of_box;\n        //                             child.weight_per_unit = row.weight_per_unit;\n        //                             child.total_weight = row.total_weight;\n        //                             child.total_length = row.total_length;\n        //                             child.total_breadth = row.total_breadth;\n        //                             child.total_height = row.total_height;\n        //                         });\n        //                         (pallet_data || []).forEach(pal => {\n        //                             let child = frappe.model.add_child(doc, \"pallet_summary\");\n        //                             child.pallet = pal.box;\n        //                             child.total_no_of_pallet = pal.total_no_of_box;\n        //                             child.weight_per_unit = pal.weight_per_unit;\n        //                             child.total_weight = pal.total_weight;\n        //                             child.total_length = pal.total_length;\n        //                             child.total_breadth = pal.total_breadth;\n        //                             child.total_height = pal.total_height;\n        //                         });\n\n        //                         frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n        //                     });\n\n        //                         }\n        //                     })\n\n        //                 } else {\n\n\n        //                     frappe.db.get_value(\"Logistics Request\",{\"order_no\":frm.doc.name},\"name\").then(i=>{\n        //                         if (i && i.message.name) {\n\n\n        //                             frappe.set_route(\"Form\", \"Logistics Request\", i.message.name);\n        //                         }\n        //                         else{\n\n\n\n        //                     frappe.model.with_doctype('Logistics Request', function() {\n        //                         let doc = frappe.model.get_new_doc('Logistics Request');\n        //                         doc.logistic_type = \"Export\";\n        //                         doc.po_so = \"Sales Invoice\";\n        //                         doc.cargo_type = frm.doc.custom_cargo_mode;\n        //                         doc.order_no = frm.doc.name;\n        //                         doc.gross_wt = frm.doc.custom_total_gross_weight;\n        //                         doc.net_wt = frm.doc.total_net_weight;\n        //                         doc.seacontainertype = frm.doc.seacontainertype;\n        //                         doc.cbm = frm.doc.custom_total_cbm;\n        //                         frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n        //                     });\n\n        //                         }\n        //                     })\n        //                 }\n        //             }\n        //         });\n\n\n        //     }, __('Create'))\n        // }\n    },\n    custom_scan_qid(frm) {\n        let qid = frm.doc.custom_scan_qid\n        if (!qid) return;\n\n        frappe.call({\n            method: \"onegene.onegene.custom.get_quality_inspection_data_for_si\",\n            args: {\n                qid: qid\n            },\n            callback: function(r) {\n                if (r.message) {\n                    if (r.message == \"not found\") {\n                        frappe.msgprint({\n                            message: \"The QID you entered is not valid.\",\n                            title: \"Invalid QID\",\n                            indicator: \"red\"\n                        });\n                        frappe.msgprint({\n                            message: \"நீங்கள் உள்ளிட்ட QID சரியில்லை.\",\n                            title: \"Invalid QID\",\n                            indicator: \"red\"\n                        });\n                        frm.set_value(\"custom_scan_qid\", \"\");\n                    } else {\n\n                        let {\n                            0: item_code = \"\",\n                            1: accepted_qty = 0,\n                            2: rack = \"\",\n                            3: location = \"\",\n                            4: uom = \"\",\n                            5: item_name = \"\",\n                            6: quality_inspection = \"\"\n                        } = r.message;\n\n                        // Check duplicate QID child table\n                        let exists = frm.doc.items?.some(row =>\n                            (row.custom_qid || \"\")\n                                .split(\",\")\n                                .map(q => q.trim())\n                                .includes(qid)\n                        );\n\n                        if (exists) {\n                            frappe.msgprint(\"QID \" + qid + \" already added in the list.\");\n                            frappe.msgprint(\"QID \" + qid + \" ஏற்கனவே list-ல் சேர்க்கப்பட்டுள்ளது.\");\n                            frm.set_value(\"custom_scan_qid\", \"\");\n                            return;\n                        }\n\n                        let existing_row = frm.doc.items?.find(row => row.item_code === item_code);\n                        if (existing_row) {\n\n                            existing_row.qty = flt(existing_row.qty) + flt(accepted_qty);\n                            existing_row.quality_inspection = quality_inspection;\n\n                            // append comma-separated qid\n                            if (existing_row.custom_qid) {\n                                let qids = existing_row.custom_qid.split(',');\n                                if (!qids.includes(qid)) {\n                                    existing_row.custom_qid = existing_row.custom_qid + ',' + qid;\n                                }\n                            } else {\n                                existing_row.custom_qid = qid;\n                            }\n\n                            frm.refresh_field(\"items\");\n                            frm.set_value(\"custom_scan_qid\", \"\");\n                            return;\n                        }\n\n                        // Add NEW row\n                        let child = frm.add_child(\"items\");\n                        frappe.model.set_value(child.doctype, child.name, \"item_code\", item_code);\n\n                        setTimeout(() => {\n                            child.qty = accepted_qty;\n                            child.quality_inspection = quality_inspection;\n                            child.custom_qid = qid; // <----- FIXED HERE\n                            \n                            frm.refresh_field(\"items\");\n                        }, 900);\n\n                        frm.refresh_field(\"items\");\n                        frm.set_value(\"custom_scan_qid\", \"\");\n                        frm.refresh_field(\"custom_scan_qid\");\n                    }\n                }\n            }\n        });\n\n    },\n    container_occupancy_html(frm) {\n        if (!frm.doc.__islocal) {\n            let occupancy = Math.round((frm.doc.custom_container_occupancy || 0) * 100) / 100;\n            if (occupancy >= 60) {\n                frm.fields_dict.custom_container_occupancy_html.$wrapper.html(`\n    \t            <p>Container Occupancy</p>\n                    <div style=\"width: 100%; background-color: #f3f3f3; border-radius: 10px; margin-bottom: 10px;\">\n                    <p style=\"color: white;text-align: center; position: absolute; left: 45%;\">${occupancy} %</p>\n                        <div style=\"width: ${occupancy}%; max-width: 100%; background-color: #59ba8b; border-radius: 10px; text-align: center; color: white\">\n                            <p>&nbsp;</p>\n                        </div>\n                    </div>\n                `);\n            } else {\n                frm.fields_dict.custom_container_occupancy_html.$wrapper.html(`\n    \t            <p>Container Occupancy</p>\n                    <div style=\"width: 100%; background-color: #f3f3f3; border-radius: 10px; margin-bottom: 10px;\">\n                    <p style=\"color: black;text-align: center; position: absolute; left: 45%;\">${occupancy} %</p>\n                        <div style=\"width: ${occupancy}%; max-width: 100%; background-color: #59ba8b; border-radius: 10px; text-align: center; color: white\">\n                            <p>&nbsp;</p>\n                        </div>\n                    </div>\n                `);\n            }\n        }\n    },\n    customer_set_query(frm) {\n        if (frm.doc.custom_invoice_type == \"Export Invoice\") {\n            frm.set_query(\"customer\", function() {\n                return {\n                    filters: {\n                        \"customer_group\": \"Export\"\n                    }\n                }\n            })\n        } else if (frm.doc.custom_invoice_type == \"Tax Invoice\") {\n            frm.set_query(\"customer\", function() {\n                return {\n                    filters: {\n                        \"customer_group\": \"Domestic\"\n                    }\n                }\n            })\n        } else {\n            frm.set_query(\"customer\", function() {\n                return {}\n            })\n        }\n    },\n    custom_scope_of_delivery(frm) {\n        if (frm.doc.custom_scope_of_delivery) {\n            frm.set_query(\"incoterm\", function() {\n                return {\n                    filters: {\n                        \"custom_type\": frm.doc.custom_scope_of_delivery\n                    }\n                }\n            })\n        }\n    },\n    custom_invoice_type(frm) {\n        frm.set_value('customer', '');\n\n        frm.clear_table('items');\n\n        frm.refresh_field('customer');\n        frm.refresh_field('items');\n        set_required_fields(frm);\n        if (frm.doc.custom_invoice_type == \"Credit Note\") {\n            frm.set_value(\"is_return\", 1);\n        } else {\n            frm.set_value(\"is_return\", 0);\n        }\n        if (frm.doc.__islocal) {\n\n            const today = new Date();\n            let currentYear = today.getFullYear() % 100;\n            let nextYear = (currentYear + 1) % 100;\n            let year_format = `${currentYear}${nextYear}`;\n            frm.set_value('custom_fiscal_year', year_format);\n\n\n            let prefix = \"\";\n            switch (frm.doc.custom_invoice_type) {\n                case \"Tax Invoice\":\n                    prefix = \"D\";\n                    break;\n                case \"Export Invoice\":\n                    prefix = \"E\";\n                    break;\n                case \"Supplementary Invoice\":\n                    prefix = \"SI\";\n                    break;\n                case \"Non Commercial Invoice\":\n                    prefix = \"NCI\";\n                    break;\n                case \"Tooling Invoice\":\n                    prefix = \"TI\";\n                    break;\n                case \"Scrap Invoice\":\n                    prefix = \"SCR\";\n                    break;\n                case \"Tooling Invoice - Exp\":\n                    prefix = \"TI\";\n                    break;\n            }\n\n            if (prefix) {\n                frm.set_value(\"naming_series\", `.${prefix}..${year_format}..#####.`);\n            }\n        }\n\n\n\n\n        frm.trigger('customer_set_query')\n        if (frm.doc.custom_invoice_type == \"Export Invoice\") {\n            frm.set_value(\"is_export_with_gst\", 1)\n            frm.refresh_field('is_export_with_gst');\n            frm.reload_doc()\n\n        }\n        if (frm.doc.custom_invoice_type != \"Export Invoice\") {\n            frm.set_value(\"is_export_with_gst\", 0)\n            frm.refresh_field('is_export_with_gst');\n            frm.reload_doc()\n        }\n\n\n    },\n    // \tcustom_invoice_type(frm){\n    // \t    if(frm.doc.custom_invoice_type == \"Export Invoice\"){\n    // \t        frm.set_value(\"is_export_with_gst\",1)\n    // \t        frm.refresh_field('is_export_with_gst');\n    // \t        frm.reload_doc()\n\n    // \t    }\n    // \t    if(frm.doc.custom_invoice_type != \"Export Invoice\"){\n    // \t        frm.set_value(\"is_export_with_gst\",0)\n    // \t        frm.refresh_field('is_export_with_gst');\n    // \t        frm.reload_doc()\n    // \t    }\n\n\n    // \t},\n\n    custom_total_cbm(frm) {\n        frm.trigger('calculate_container_occupancy');\n    },\n    seacontainertype(frm) {\n        // frm.trigger('calculate_container_occupancy');\n        let cbm_value;\n        switch (frm.doc.seacontainertype) {\n            case 'LCL':\n                cbm_value = 15;\n                break;\n            case '20Ft.Container':\n                cbm_value = 33.2;\n                break;\n            case '40Ft.Container':\n                cbm_value = 67.7;\n                break;\n            default:\n                cbm_value = 76.4;\n        }\n        let occupancy = (frm.doc.custom_total_cbm / cbm_value) * 100;\n        if (frm.doc.custom_total_cbm > cbm_value) {\n            let no_of_containers = Math.ceil(frm.doc.custom_total_cbm / cbm_value);\n            frm.set_value(\"custom_no_of_containers\", no_of_containers);\n            frm.set_df_property('seacontainertype', 'read_only', 0)\n        }\n    },\n    calculate_container_occupancy(frm) {\n        if (frm.doc.custom_total_cbm && frm.doc.seacontainertype) {\n            let cbm_value;\n            switch (frm.doc.seacontainertype) {\n                case 'LCL':\n                    cbm_value = 15;\n                    break;\n                case '20Ft.Container':\n                    cbm_value = 33.2;\n                    break;\n                case '40Ft.Container':\n                    cbm_value = 67.7;\n                    break;\n                default:\n                    cbm_value = 76.4;\n            }\n            let occupancy = (frm.doc.custom_total_cbm / cbm_value) * 100;\n            if (frm.doc.custom_total_cbm > 76.4) {\n                let no_of_containers = Math.ceil(frm.doc.custom_total_cbm / cbm_value);\n                occupancy = (frm.doc.custom_total_cbm / (cbm_value * no_of_containers)) * 100\n                frm.set_value(\"custom_no_of_containers\", no_of_containers);\n                frm.set_df_property('seacontainertype', 'read_only', 0)\n            }\n            frm.set_value('custom_container_occupancy', occupancy);\n        }\n    },\n\n    calculate_total_cbm(frm) {\n        if (frm.doc.custom_invoice_type == \"Export Invoice\") {\n            let total_cbm = 0;\n            let total_gross_weight = 0;\n            let total_packing_weight = 0;\n            let custom_total_no_of_boxes = 0;\n            let custom_total_no_of_pallets = 0;\n\n            for (let i = 0; i < frm.doc.items.length; i++) {\n                total_cbm += frm.doc.items[i].custom_cbm || 0;\n                total_packing_weight += frm.doc.items[i].custom_packing_weight || 0;\n                total_gross_weight += frm.doc.items[i].custom_gross_weight || 0;\n                custom_total_no_of_boxes += frm.doc.items[i].custom_no_of_boxes || 0;\n                custom_total_no_of_pallets += frm.doc.items[i].custom_no_of_pallets || 0;\n            }\n\n            frm.set_value(\"custom_total_cbm\", total_cbm);\n            frm.set_value(\"custom_total_packing_weight\", total_packing_weight);\n            frm.set_value(\"custom_total_gross_weight\", total_gross_weight);\n            frm.set_value(\"custom_total_no_of_boxes\", custom_total_no_of_boxes);\n            frm.set_value(\"custom_total_no_of_pallets\", custom_total_no_of_pallets);\n\n            if (frm.doc.custom_cargo_mode === \"Sea\") {\n                if (total_cbm > 0 && total_cbm <= 15) {\n                    frm.set_value(\"seacontainertype\", \"LCL\");\n                } else if (total_cbm > 15 && total_cbm <= 33.2) {\n                    frm.set_value(\"seacontainertype\", \"20Ft.Container\");\n                } else if (total_cbm > 33.2 && total_cbm <= 67.7) {\n                    frm.set_value(\"seacontainertype\", \"40Ft.Container\");\n                } else if (total_cbm > 67.7) {\n                    frm.set_value(\"seacontainertype\", \"40(HC)\");\n                } else {\n                    frm.set_value(\"seacontainertype\", \"\");\n                }\n            }\n        }\n\n    },\n\n    onload(frm) {\n        setTimeout(() => {\n            frm.remove_custom_button('Quality Inspection(s)', 'Create');\n        }, 50);\n\n        if (!frm.doc.__islocal && frm.doc.docstatus == 1 && frm.doc.custom_invoice_type == \"Tax Invoice\") {\n            var f_name = frm.doc.name;\n            frm.add_custom_button(__(\"Tax Invoice\"), function() {\n                var print_format = \"Tax Invoice Print format\";\n                window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                    \"&name=\" + encodeURIComponent(f_name) +\n                    \"&trigger_print=1\" +\n                    \"&format=\" + print_format +\n                    \"&no_letterhead=0\"\n                ));\n            }, __('Print'));\n        }\n        if (!frm.doc.__islocal && frm.doc.docstatus != 2 && frm.doc.custom_invoice_type == \"Tax Invoice\") {\n            frm.add_custom_button(__(\"Tax Invoice\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_view_tax\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n        }\n\n        // frm.page.clear_primary_action(); \n        frm.remove_custom_button('Fetch Timesheet');\n        if (frm.doc.workflow_state !== 'Approved' || frm.doc.workflow_state != 'Dispatched') {\n            $(\"button[data-original-title='Print']\").hide();\n\n        }\n\n\n\n        update_fields_based_on_items(frm);\n        if (frm.doc.custom_invoice_type != \"Tax Invoice\") {\n            frm.add_custom_button(__(\"Export Invoice\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_EI\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Annexure\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_annexure\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Pallet\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_pallet\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Address\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_address\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"80%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n        }\n         if (!frm.doc.__islocal && frm.doc.docstatus == 0 && frm.doc.custom_invoice_type == \"Export Invoice\" && ['Waiting for LR Request'].includes(frm.doc.workflow_state)) {\n            if (frappe.user.has_role(\"Sales User\") || frappe.user.has_role(\"Sales Manager\") || frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System manager\")) {\n\n                frm.add_custom_button(__('Logistics Request'), function() {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.logistics_request.logistics_request.get_box_summary\",\n                        args: {\n                            sales_invoice: frm.doc.name\n                        },\n                        callback: function(r) {\n                            if (r.message) {\n\n                                frappe.db.get_value(\"Logistics Request\", {\n                                    \"order_no\": frm.doc.name\n                                }, \"name\").then(i => {\n                                    if (i && i.message.name) {\n                                        frappe.msgprint(__('Logistic Request already created <b>{0}</b>', [i.message.name]));\n                                        frappe.msgprint(__('Logistic Request <b>{0}</b> ஏற்கனவே உருவாக்கப்பட்டுள்ளது', [i.message.name]));\n                                    } else {\n\n\n\n                                        const [box_data, pallet_data] = r.message;\n                                        frappe.model.with_doctype('Logistics Request', function() {\n                                            let doc = frappe.model.get_new_doc('Logistics Request');\n                                            doc.logistic_type = \"Export\";\n                                            doc.po_so = \"Sales Invoice\";\n                                            doc.cargo_type = frm.doc.custom_cargo_mode;\n                                            doc.shipping_line = frm.doc.custom_cargo_mode;\n                                            doc.order_no = frm.doc.name;\n                                            doc.customer = frm.doc.customer;\n                                            doc.tentative_production_completion = frm.doc.custom_tentative_production_completion_date;\n                                            doc.gross_wt = frm.doc.custom_total_gross_weight;\n                                            doc.net_wt = frm.doc.total_net_weight;\n                                            doc.seacontainertype = frm.doc.seacontainertype;\n                                            doc.scope_of_delivery = frm.doc.custom_scope_of_delivery;\n                                            doc.cbm = frm.doc.custom_total_cbm;\n                                            doc.inventory_destination = \"Direct to Customer\";\n                                            (frm.doc.items || []).forEach(item => {\n                                                let child = frappe.model.add_child(doc, \"product_description_so\");\n\n                                                Object.keys(item).forEach(field => {\n                                                    if (![\"doctype\", \"name\", \"parent\", \"parentfield\", \"parenttype\", \"__unsaved\", \"idx\"].includes(field)) {\n                                                        child[field] = item[field];\n                                                    }\n                                                });\n                                            });\n\n                                            (box_data || []).forEach(row => {\n                                                let child = frappe.model.add_child(doc, \"box_summary_table\");\n                                                child.box = row.box;\n                                                child.total_no_of_box = row.total_no_of_box;\n                                                child.weight_per_unit = row.weight_per_unit;\n                                                child.total_weight = row.total_weight;\n                                                child.total_length = row.total_length;\n                                                child.total_breadth = row.total_breadth;\n                                                child.total_height = row.total_height;\n                                            });\n                                            (pallet_data || []).forEach(pal => {\n                                                let child = frappe.model.add_child(doc, \"pallet_summary\");\n                                                child.pallet = pal.box;\n                                                child.total_no_of_pallet = pal.total_no_of_box;\n                                                child.weight_per_unit = pal.weight_per_unit;\n                                                child.total_weight = pal.total_weight;\n                                                child.total_length = pal.total_length;\n                                                child.total_breadth = pal.total_breadth;\n                                                child.total_height = pal.total_height;\n                                            });\n\n                                            // frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n                                            frappe.db.insert(doc).then(new_doc => {\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} is created`);\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} உருவாக்கப்பட்டுள்ளது`);\n                                                frm.reload_doc()\n                                            });\n                                        });\n\n\n\n                                    }\n                                })\n\n\n                            } else {\n\n\n\n                                frappe.db.get_value(\"Logistics Request\", {\n                                    \"order_no\": frm.doc.name\n                                }, \"name\").then(i => {\n                                    if (i && i.message.name) {\n\n\n                                        frappe.set_route(\"Form\", \"Logistics Request\", i.message.name);\n                                    } else {\n\n\n\n                                        frappe.model.with_doctype('Logistics Request', function() {\n                                            let doc = frappe.model.get_new_doc('Logistics Request');\n                                            doc.logistic_type = \"Export\";\n                                            doc.po_so = \"Sales Invoice\";\n                                            doc.cargo_type = frm.doc.custom_cargo_mode;\n                                            doc.shipping_line = frm.doc.custom_cargo_mode;\n                                            doc.order_no = frm.doc.name;\n                                            doc.gross_wt = frm.doc.custom_total_gross_weight;\n                                            doc.net_wt = frm.doc.total_net_weight;\n                                            doc.seacontainertype = frm.doc.seacontainertype;\n                                            doc.cbm = frm.doc.custom_total_cbm;\n                                            doc.tentative_production_completion = frm.doc.custom_tentative_production_completion_date;\n                                            doc.scope_of_delivery = frm.doc.custom_scope_of_delivery;\n                                            doc.inventory_destination = \"Direct to Customer\";\n\n                                            // frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n\n                                            frappe.db.insert(doc).then(new_doc => {\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} is created`);\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} உருவாக்கப்பட்டுள்ளது`);\n                                            });\n                                        });\n\n                                    }\n                                })\n                            }\n                        }\n                    });\n\n\n                }, __('Create'))\n\n            }\n        }\n\n\n\n        if (frm.doc.docstatus != 2 && frm.doc.custom_invoice_type == \"Export Invoice\") {\n            var f_name = frm.doc.name;\n            frappe.db.get_value(\"Logistics Request\", {\n                \"order_no\": frm.doc.name\n            }, \"name\").then(r => {\n                if (frm.doc.docstatus == 1) {\n                    frm.add_custom_button(__(\"Export Invoice\"), function() {\n                        var print_format = \"Export Invoice Print New\";\n                        window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                            \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                            \"&name=\" + encodeURIComponent(f_name) +\n                            \"&trigger_print=1\" +\n                            \"&format=\" + print_format +\n                            \"&no_letterhead=0\"\n                        ));\n                    }, __('Print'));\n                }\n\n                if (r.message && r.message.name) {\n                    frm.add_custom_button(__(\"Packing List\"), function() {\n                        var print_format = \"Packing List\";\n                        window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                            \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                            \"&name=\" + encodeURIComponent(f_name) +\n                            \"&trigger_print=1\" +\n                            \"&format=\" + print_format +\n                            \"&no_letterhead=0\"\n                        ));\n                    }, __('Print'));\n                    frm.add_custom_button(__(\"Packing List\"), function() {\n                        frappe.call({\n                            method: \"onegene.onegene.custom.create_html_packing\",\n                            args: {\n                                doc: frm.doc\n                            },\n                            callback: function(r) {\n                                if (r.message && r.message.html) {\n                                    let d = new frappe.ui.Dialog({\n\n                                        size: \"large\",\n                                        primary_action_label: __(\"Close\"),\n                                        primary_action: function() {\n                                            d.hide();\n                                        }\n                                    });\n                                    d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                                    d.$body.html(r.message.html);\n                                    d.show();\n                                } else {\n                                    frappe.msgprint(__(\"Unable to load preview\"));\n                                    frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                                }\n                            }\n                        });\n                    }, __(\"Report View\"));\n\n                }\n\n                frm.add_custom_button(__(\"Annexure\"), function() {\n                    var print_format = \"Annexure Print\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n\n                frm.add_custom_button(__(\"Pallet\"), function() {\n                    var print_format = \"Pallet\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n\n                frm.add_custom_button(__(\"Address\"), function() {\n                    var print_format = \"Address Print\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n            });\n        }\n\n\n\n        frm.fields_dict.custom_pick_list.$wrapper.empty();\n        update_fields_based_on_items(frm);\n\n        if (frm.doc.docstatus == 0 && frappe.user.has_role(\"System Manager\")) {\n            frm.set_df_property(\"set_posting_time\", \"hidden\", 0)\n        } else {\n            frm.set_df_property(\"set_posting_time\", \"hidden\", 1)\n        }\n\n\n\n        if (frm.doc.__islocal) {\n\n            const today = new Date();\n            let currentYear = today.getFullYear() % 100;\n            let nextYear = (currentYear + 1) % 100;\n            let year_format = `${currentYear}${nextYear}`;\n            frm.set_value('custom_fiscal_year', year_format);\n\n            let prefix = \"\";\n            switch (frm.doc.custom_invoice_type) {\n                case \"Tax Invoice\":\n                    prefix = \"D\";\n                    break;\n                case \"Export Invoice\":\n                    prefix = \"E\";\n                    break;\n                case \"Supplementary Invoice\":\n                    prefix = \"SI\";\n                    break;\n                case \"Non Commercial Invoice\":\n                    prefix = \"NCI\";\n                    break;\n                case \"Tooling Invoice\":\n                    prefix = \"TI\";\n                    break;\n                case \"Scrap Invoice\":\n                    prefix = \"SCR\";\n                    break;\n                case \"Tooling Invoice - Exp\":\n                    prefix = \"TI\";\n                    break;\n            }\n\n            if (prefix) {\n                frm.set_value(\"naming_series\", `.${prefix}..${year_format}..#####.`);\n            }\n\n            // Credit Note Invoice\n            if (frm.doc.is_return == 1) {\n                frm.set_value(\"custom_invoice_type\", \"Credit Note\")\n            }\n        }\n\n\n        frm.fields_dict.items.grid.get_field('custom_box').get_query = function(doc, cdt, cdn) {\n            let row = locals[cdt][cdn];\n            return {\n                filters: {\n                    \"name\": [\"in\", get_boxes(row.item_code)]\n                }\n            };\n        };\n        frm.fields_dict.items.grid.get_field('custom_pallet').get_query = function(doc, cdt, cdn) {\n            let row = locals[cdt][cdn];\n            return {\n                filters: {\n                    \"name\": [\"in\", get_pallets(row.item_code)]\n                }\n            };\n        };\n        frm.fields_dict.items.grid.get_field('sales_order').get_query = function(doc, cdt, cdn) {\n            const row = locals[cdt][cdn];\n\n            if (!row.item_code || !doc.customer) {\n                return {\n                    filters: {\n                        name: \"\"\n                    }\n                };\n            }\n\n            return {\n                query: \"onegene.onegene.custom.get_so_for_sii\",\n                filters: {\n                    item_code: row.item_code,\n                    customer: doc.customer\n                }\n            };\n        };\n        frm.fields_dict.items.grid.get_field('custom_customers_po_number').get_query = function(doc, cdt, cdn) {\n            const row = locals[cdt][cdn];\n\n            if (!row.item_code || !doc.customer) {\n                return {\n                    filters: {\n                        name: \"\"\n                    }\n                };\n            }\n\n            return {\n                query: \"onegene.onegene.custom.get_customer_po_query\",\n                filters: {\n                    item_code: row.item_code,\n                    customer: doc.customer\n                }\n            };\n        };\n        setTimeout(() => {\n            frm.fields_dict.items.grid.get_field('item_code').get_query = function(doc, cdt, cdn) {\n                const row = locals[cdt][cdn];\n\n                if (!doc.customer) {\n                    frappe.msgprint(\"Please select a Customer first.\");\n                    frappe.msgprint(\"முதலில் ஒரு Customer-ஐ தேர்ந்தெடுக்கவும்.\")\n                    return;\n                }\n\n                return {\n                    query: \"onegene.onegene.custom.get_items_for_sii\",\n                    filters: {\n                        customer: doc.customer,\n                        invoice_type: doc.custom_invoice_type\n                    }\n                };\n            };\n        }, 100); // Delay in milliseconds (100 ms = 0.1 second)\n\n\n    }\n})\n\nfunction update_fields_based_on_items(frm) {\n    let has_item_code = false;\n\n    if (frm.doc.items && frm.doc.items.length > 0) {\n        for (let row of frm.doc.items) {\n            if (row.item_code) {\n                has_item_code = true;\n                break;\n            }\n        }\n    }\n\n    frm.set_df_property('customer', 'read_only', has_item_code ? 1 : 0);\n\n\n}\n\nfunction get_boxes(item_code) {\n    let boxes = [];\n\n    // Fetch the item document to get the list of supplier names from Supplier Item child table\n    frappe.call({\n        method: \"frappe.client.get\",\n        args: {\n            doctype: \"Item\",\n            name: item_code\n        },\n        async: false, // Ensure the call completes before proceeding\n        callback: function(response) {\n            let item_doc = response.message;\n            if (item_doc && item_doc.custom_box) {\n                boxes = item_doc.custom_box.map(box => box.box);\n            }\n        }\n    });\n\n    return boxes;\n}\n\nfunction get_pallets(item_code) {\n    let pallets = [];\n\n    // Fetch the item document to get the list of supplier names from Supplier Item child table\n    frappe.call({\n        method: \"frappe.client.get\",\n        args: {\n            doctype: \"Item\",\n            name: item_code\n        },\n        async: false, // Ensure the call completes before proceeding\n        callback: function(response) {\n            let item_doc = response.message;\n            if (item_doc && item_doc.custom_pallet) {\n                pallets = item_doc.custom_pallet.map(pallet => pallet.pallet);\n            }\n        }\n    });\n\n    return pallets;\n}\n\n\n\n\nfrappe.ui.form.on('Sales Invoice Item', {\n\n    item_code: function(frm, cdt, cdn) {\n        row = locals[cdt][cdn];\n        refresh_stock_pick_list(frm);\n        if (!row.item_code) {\n            row.rate = 0;\n            row.custom_customers_po_number = '';\n            row.sales_order = '';\n            row.description = '';\n            row.warehouse = '';\n\n            frm.fields_dict['items'].grid.refresh_row(row);\n        }\n        validate_and_set_customers_po(frm, cdt, cdn);\n        // validate_and_set_sales_order(frm, cdt, cdn);\n        update_fields_based_on_items(frm);\n        handlePalletBoxData(frm, cdt, cdn);\n        frappe.model.set_value(cdt, cdn, 'warehouse', \"Finished Goods - WAIP\");\n        frappe.model.set_value(cdt, cdn, 'qty', '');\n        frappe.call({\n            method: \"onegene.onegene.custom.si_qty_warehouse_qty_validation\",\n            args: {\n                \"item_code\": row.item_code,\n                \"name\": frm.doc.name,\n            },\n            callback: function(r) {\n                if (r.message) {\n                    frappe.model.set_value(cdt, cdn, 'custom_available_qty_at_warehouse', r.message);\n                }\n            }\n        })\n        // setTimeout(() => {\n        //     row = locals[cdt][cdn]\n        //     frappe.model.set_value(row.doctype, row.name, \"qty\", '');\n        // }, 1000);\n\n        let current_row = locals[cdt][cdn];\n        if (current_row.item_code) {\n            frappe.db.get_value('Item', current_row.item_code, 'gst_hsn_code')\n                .then(r => {\n                    const hsn_code = r.message.gst_hsn_code;\n                    current_row.gst_hsn_code = hsn_code;\n                    frm.refresh_field('items');\n\n                    // Find index of current row\n                    let current_index = frm.doc.items.findIndex(row => row.name === current_row.name);\n                    // selecting gst and adding tax template\n                    if (current_index == 0) {\n                        if (current_row.gst_hsn_code && frm.doc.customer && frm.doc.company) {\n                            frappe.call({\n                                method: \"onegene.utils.get_item_tax_and_sales_template\",\n                                args: {\n                                    hsn_code: current_row.gst_hsn_code,\n                                    customer: frm.doc.customer,\n                                    company: frm.doc.company\n                                },\n                                freeze: true,\n                                freeze_message: __(\"Fetching Tax...\"),\n                                callback: function(r) {\n                                    if (r.message) {\n                                        frappe.model.set_value(cdt, cdn, \"item_tax_template\", r.message.item_tax_template);\n                                        frm.set_value(\"taxes_and_charges\", r.message.sales_taxes_and_charges_template);\n                                    }\n                                    // frappe.model.set_value(cdt, cdn, 'qty', '');\n                                }\n                            });\n                        }\n\n                    }\n                    if (current_index > 0) {\n                        let previous_row = frm.doc.items[current_index - 1];\n\n                        if (previous_row.gst_hsn_code && previous_row.gst_hsn_code !== hsn_code) {\n                            let msg = frappe.msgprint({\n                                title: __(\"Removing Current Row\"),\n                                message: __(\"HSN Code mismatch: <b>{0}</b> (Previous) vs <b>{1}</b> (Current)\",\n                                    [previous_row.gst_hsn_code, hsn_code]),\n                                indicator: 'orange'\n                            });\n\n                            frm.get_field('items').grid.grid_rows_by_docname[cdn].remove();\n                            frm.refresh_field('items');\n                            setTimeout(() => {\n                                if (msg && msg.hide) msg.hide();\n                            }, 1000);\n                        }\n                    }\n                });\n        }\n\n        frm.refresh_field('item');\n        setTimeout(() => {\n            if (row.item_code && row.custom_customers_po_number) {\n                frappe.call({\n                    method: \"onegene.onegene.custom.get_rate_from_sales_order\",\n                    args: {\n                        item_code: row.item_code,\n                        customer_po: row.custom_customers_po_number\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.model.set_value(cdt, cdn, \"rate\", r.message);\n                        }\n                    }\n                });\n            }\n        }, 500);\n\n\n    },\n    items_remove: function(frm, cdt, cdn) {\n        // update_pick_list(frm);\n        refresh_stock_pick_list(frm);\n    },\n    items_add: function(frm) {\n        refresh_stock_pick_list(frm);\n    },\n    custom_customers_po_number: function(frm, cdt, cdn) {\n        const row = locals[cdt][cdn];\n\n        if (frm.doc.customer && row.item_code) {\n            frappe.call({\n                method: \"onegene.onegene.custom.get_customer_po_number\",\n                args: {\n                    customer: frm.doc.customer,\n                    item_code: row.item_code\n                },\n                callback: function(r) {\n                    if (r.message && Array.isArray(r.message)) {\n                        const valid_po_nos = r.message;\n                        row._valid_po_nos = valid_po_nos;\n\n                        if (valid_po_nos.length === 1) {\n                            frappe.model.set_value(cdt, cdn, \"custom_customers_po_number\", valid_po_nos[0]);\n                        }\n\n                        if (\n                            row.custom_customers_po_number &&\n                            !valid_po_nos.includes(row.custom_customers_po_number)\n                        ) {\n                            frappe.model.set_value(cdt, cdn, \"custom_customers_po_number\", \"\");\n                            frappe.model.set_value(cdt, cdn, \"sales_order\", \"\");\n                            return;\n                        }\n\n                        if (row.custom_customers_po_number) {\n                            frappe.db.get_value('Sales Order', {\n                                po_no: row.custom_customers_po_number,\n                                customer: frm.doc.customer\n                            }, 'name').then(r => {\n                                if (r && r.message && r.message.name) {\n                                    frappe.model.set_value(cdt, cdn, 'sales_order', r.message.name);\n                                }\n                            });\n                        }\n                    }\n                }\n            });\n        }\n        setTimeout(() => {\n            if (row.item_code && row.custom_customers_po_number) {\n                frappe.call({\n                    method: \"onegene.onegene.custom.get_rate_from_sales_order\",\n                    args: {\n                        item_code: row.item_code,\n                        customer_po: row.custom_customers_po_number\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.model.set_value(cdt, cdn, \"rate\", r.message);\n                        }\n                    }\n                });\n            }\n        }, 500);\n    },\n    sales_order: function(frm, cdt, cdn) {\n        const row = locals[cdt][cdn];\n        if (!row.sales_order) return;\n        // read only\n        const read_only = row.sales_order && frm.doc.custom_invoice_type != \"Credit Note\";\n\n        frm.fields_dict['items'].grid.update_docfield_property(\n            'rate', // field to make read-only\n            'read_only', // property\n            read_only, // value\n            row.name // specific row\n        );\n        frappe.call({\n            method: \"onegene.onegene.custom.get_so_for_sii\",\n            args: {\n                doctype: \"Sales Order\",\n                txt: \"\",\n                searchfield: \"name\",\n                start: 0,\n                page_len: 5,\n                filters: {\n                    item_code: row.item_code,\n                    customer: frm.doc.customer,\n                }\n            },\n            callback: function(r) {\n                const so_list = r.message.map(row => row[0]);\n                if (!so_list.includes(row.sales_order)) {\n                    frappe.model.set_value(cdt, cdn, 'sales_order', '');\n                    return;\n                }\n            }\n        });\n\n        let sales_order = row.sales_order;\n        if (sales_order) {\n            frappe.call({\n                method: \"onegene.onegene.custom.get_so_item_details\",\n                args: {\n                    sales_order: sales_order,\n                    item_code: row.item_code,\n                },\n                freeze: true,\n                freeze_message: \"Loading SO Details...\",\n                callback: function(r) {\n                    if (!r.message) return;\n                    // row.qty = r.message[0];\n                    row.so_detail = r.message[1];\n                    row.rate = r.message[2];\n                    row.amount = r.message[0] * r.message[2];\n                    frm.refresh_field(\"items\");\n                }\n            });\n            // Duplicate Items Valdiation\n            setTimeout(() => {\n                let duplicate_found = frm.doc.items.some(\n                    item => item.item_code === row.item_code && item.name !== row.name && item.sales_order === row.sales_order\n\n                );\n\n                if (duplicate_found) {\n                    let d = frappe.msgprint({\n                        title: __(\"Removing Duplicate Entry\"),\n                        message: __(\"Item Code <b>{0}</b> is already added.\", [row.item_code]),\n                        indicator: 'red'\n                    });\n                    frm.get_field('items').grid.grid_rows_by_docname[cdn].remove();\n                    frm.refresh_field('items');\n                    setTimeout(() => {\n                        if (d && d.hide) d.hide();\n                    }, 2000);\n                }\n            }, 500);\n        }\n        handlePalletBoxData(frm, cdt, cdn)\n    },\n\n    custom_no_of_boxes: function(frm, cdt, cdn) {\n        var child = locals[cdt][cdn];\n        if (child.custom_pallet && child.custom_no_of_boxes && child.item_code && child.custom_box) {\n            frappe.call({\n                method: 'onegene.onegene.custom.set_pallet_weight',\n                args: {\n                    item: child.item_code,\n                    box: child.custom_box,\n                    pallet: child.custom_pallet,\n                    box_qty: child.custom_no_of_boxes\n                },\n            }).then(r => {\n                if (r.message) {\n                    child.custom_no_of_pallets = r.message[0];\n                    child.custom_total_weight_of_pallets = r.message[1];\n                    child.custom_pallet_length = r.message[2];\n                    child.custom_pallet_breadth = r.message[3];\n                    child.custom_pallet_height = r.message[4];\n                    child.custom_cbm = (r.message[0] * r.message[2] * r.message[3] * r.message[4]) / 1000000000;\n                }\n                child.custom_packing_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets;\n                child.custom_gross_weight = child.custom_packing_weight + child.total_weight;\n                frm.refresh_field(\"items\");\n            });\n            frm.trigger('calculate_total_cbm')\n        }\n    },\n    qty: function(frm, cdt, cdn) {\n\n        let child = locals[cdt][cdn];\n\n\n        let date_obj = new Date(frm.doc.posting_date);\n        let month_str = date_obj.toLocaleString('en-us', {\n            month: 'short'\n        }).toUpperCase();\n        let year = date_obj.getFullYear();\n        if (child.qty === 0) return;\n\n        if (child.sales_order) {\n            frappe.call({\n                method: \"onegene.onegene.custom.set_qty_sales_invoice\",\n                args: {\n                    item_code: child.item_code,\n                    sales_order: child.sales_order,\n                    schedule_month: month_str,\n                    schedule_year: year,\n                    qty: child.qty\n                },\n                callback: function(r) {\n\n\n                    const scheduled_qty = Number(r.message);\n\n                    if (scheduled_qty) {\n\n                        if (!isNaN(scheduled_qty) && child.qty > scheduled_qty) {\n\n                            frappe.msgprint(`${r.message}`)\n\n                            frappe.model.set_value(child.doctype, child.name, \"qty\", 0);\n\n                            frm.refresh_field(\"items\");\n\n\n                        }\n\n                    }\n\n\n                }\n\n            });\n        }\n\n        if (child.custom_available_qty_at_warehouse < child.qty) {\n\n            // frappe.msgprint(`Quantity should not be greater than the stock Qty. Available Qty is ${child.custom_available_qty_at_warehouse}`)\n            // frappe.model.set_value(child.doctype, child.name, \"qty\", 0);\n        }\n\n        if (frm.doc.custom_invoice_type != \"Export Invoice\") {\n            if (child.qty > 0 && child.custom_pack_size > 0) {\n                child.custom_no_of_boxes = Math.ceil(child.qty / child.custom_pack_size)\n            } else {\n                child.custom_no_of_boxes = 1\n            }\n        }\n\n\n\n\n        if (child.item_code && child.custom_box && child.qty && frm.doc.custom_invoice_type == \"Export Invoice\") {\n            frappe.call({\n                method: 'onegene.onegene.custom.set_box_weight',\n                args: {\n                    'item': child.item_code,\n                    'box': child.custom_box,\n                    'item_qty': child.qty\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        child.custom_no_of_boxes = r.message[0]\n                        child.custom_total_weight_of_boxes = r.message[1]\n                        child.custom_box_length = r.message[2]\n                        child.custom_box_breadth = r.message[3]\n                        child.custom_box_height = r.message[4]\n                    }\n                    if (child.custom_pallet && child.custom_no_of_boxes && child.item_code && child.custom_box) {\n                        frappe.call({\n                            method: 'onegene.onegene.custom.set_pallet_weight',\n                            args: {\n                                item: child.item_code,\n                                box: child.custom_box,\n                                pallet: child.custom_pallet,\n                                box_qty: child.custom_no_of_boxes\n                            },\n                        }).then(r => {\n                            if (r.message) {\n                                child.custom_no_of_pallets = r.message[0];\n                                child.custom_total_weight_of_pallets = r.message[1];\n                                child.custom_pallet_length = r.message[2];\n                                child.custom_pallet_breadth = r.message[3];\n                                child.custom_pallet_height = r.message[4];\n                                child.custom_cbm = (r.message[0] * r.message[2] * r.message[3] * r.message[4]) / 1000000000;\n                            }\n                            child.custom_packing_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets;\n                            child.custom_gross_weight = child.custom_packing_weight + child.total_weight;\n                            frm.refresh_field(\"items\");\n                        });\n                        frm.trigger('calculate_total_cbm')\n\n\n                    }\n                    child.custom_packing_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets\n                    child.custom_gross_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets + child.total_weight\n                    frm.refresh_field(\"items\");\n                }\n            });\n            frm.trigger('calculate_total_cbm');\n\n        }\n\n        if (child.qty && frm.doc.custom_invoice_type != \"Credit Note\") {\n            frappe.call({\n                method: 'onegene.onegene.custom.validate_qty_in_sales_invoice',\n                args: {\n                    'item_code': child.item_code,\n                    'sales_order': child.sales_order,\n                    'qty': child.qty,\n                    'idx': child.idx,\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        frappe.model.set_value(child.doctype, child.name, \"qty\", 0);\n                        if (child.delivery_note) {\n                            frappe.msgprint(\n                                __(`<b>Row ${child.idx}</b>: Cannot invoice more than the quantity available in Delivery Note <b>${child.delivery_note}</b> for Item <b>${child.item_code}</b>. Available Quantity: <b>${r.message}</b>`),\n                                __(\"Quantity Exceeds Delivery Note Limit\")\n                            );\n                            frappe.msgprint(\n                                __(`<b>Row ${child.idx}</b>: Delivery Note <b>${child.delivery_note}</b> இல் உள்ள அளவை விட Item <b>${child.item_code}</b> க்கு invoice செய்ய முடியாது. கிடைக்கும் அளவு: <b>${r.message}</b>`),\n                                __(\"Quantity Exceeds Delivery Note Limit\")\n                            );\n\n                        } else {\n                            frappe.msgprint(\n                                __(`<b>Row ${child.idx}</b>: Cannot invoice more than the quantity available in Sales Order <b>${child.sales_order}</b> for Item <b>${child.item_code}</b>. Available Quantity: <b>${r.message}</b>`),\n                                __(\"Quantity Exceeds Sales Order Limit\")\n                            );\n                            frappe.msgprint(\n                                __(`<b>Row ${child.idx}</b>: Sales Order <b>${child.sales_order}</b> இல் உள்ள அளவை விட Item <b>${child.item_code}</b> க்கு invoice செய்ய முடியாது. கிடைக்கும் அளவு: <b>${r.message}</b>`),\n                                __(\"Quantity Exceeds Sales Order Limit\")\n                            );\n\n                        }\n                    }\n\n                    frm.refresh_field(\"items\");\n                }\n\n\n            });\n        }\n        handlePalletBoxData(frm, cdt, cdn)\n    },\n\n\n\n\n    custom_box: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn];\n        if (child.custom_box && child.qty) {\n            frappe.call({\n                method: 'onegene.onegene.custom.set_box_weight',\n                args: {\n                    'item': child.item_code,\n                    'box': child.custom_box,\n                    'item_qty': child.qty\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        child.custom_no_of_boxes = r.message[0]\n                        child.custom_total_weight_of_boxes = r.message[1]\n                        child.custom_box_length = r.message[2]\n                        child.custom_box_breadth = r.message[3]\n                        child.custom_box_height = r.message[4]\n                    }\n                    child.custom_packing_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets\n                    child.custom_gross_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets + child.total_weight\n                    frm.refresh_field(\"items\");\n                }\n            });\n            frm.trigger('calculate_total_cbm');\n\n        }\n    },\n    custom_pallet: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn];\n        if (child.qty && child.custom_pallet && child.custom_no_of_boxes && child.item_code && child.custom_box) {\n            frappe.call({\n                method: 'onegene.onegene.custom.set_pallet_weight',\n                args: {\n                    item: child.item_code,\n                    box: child.custom_box,\n                    pallet: child.custom_pallet,\n                    box_qty: child.custom_no_of_boxes\n                },\n            }).then(r => {\n                if (r.message) {\n                    child.custom_no_of_pallets = r.message[0];\n                    child.custom_total_weight_of_pallets = r.message[1];\n                    child.custom_pallet_length = r.message[2];\n                    child.custom_pallet_breadth = r.message[3];\n                    child.custom_pallet_height = r.message[4];\n                    child.custom_cbm = (r.message[0] * r.message[2] * r.message[3] * r.message[4]) / 1000000000;\n                }\n                child.custom_packing_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets;\n                child.custom_gross_weight = child.custom_packing_weight + child.total_weight;\n                frm.refresh_field(\"items\");\n            });\n            frm.trigger('calculate_total_cbm')\n\n\n        }\n    },\n    // custom_total_weight_of_boxes: function(frm, cdt, cdn) {\n    //     let child = locals[cdt][cdn];\n    //     child.custom_packing_weight = child.custom_total_weight_of_boxes+child.custom_total_weight_of_pallets+child.total_weight\n    //     frm.refresh_field(\"items\");\n    // },\n    // custom_total_weight_of_pallets: function(frm, cdt, cdn) {\n    //     let child = locals[cdt][cdn];\n    //     child.custom_packing_weight = child.custom_total_weight_of_boxes+child.custom_total_weight_of_pallets+child.total_weight\n    //     frm.refresh_field(\"items\");\n    // }\n\n\n})\n\nasync function handlePalletBoxData(frm, cdt, cdn) {\n    if (frm.doc.custom_invoice_type == \"Export Invoice\") {\n        const row = locals[cdt][cdn];\n        if (!row.item_code || !frm.doc.customer) return;\n\n        try {\n\n            // 3. Box filters and defaults\n            const boxes = get_boxes(row.item_code);\n            frm.fields_dict.items.grid.get_field('custom_box').get_query = function(doc) {\n                return {\n                    filters: {\n                        \"name\": [\"in\", boxes]\n                    }\n                };\n            };\n            if (boxes.length === 1) {\n                await frappe.model.set_value(cdt, cdn, 'custom_box', boxes[0]);\n            }\n\n            // 4. Pallet filters and defaults\n            const pallets = get_pallets(row.item_code);\n            frm.fields_dict.items.grid.get_field('custom_pallet').get_query = function(doc) {\n                return {\n                    filters: {\n                        \"name\": [\"in\", pallets]\n                    }\n                };\n            };\n            if (pallets.length === 1) {\n                await frappe.model.set_value(cdt, cdn, 'custom_pallet', pallets[0]);\n            }\n\n            // 5. Box weight and packing calculations\n            if (row.custom_box && row.qty) {\n                const boxRes = await frappe.call({\n                    method: 'onegene.onegene.custom.set_box_weight',\n                    args: {\n                        'item': row.item_code,\n                        'box': row.custom_box,\n                        'item_qty': row.qty\n                    }\n                });\n\n                if (boxRes.message) {\n                    row.custom_no_of_boxes = boxRes.message[0];\n                    row.custom_total_weight_of_boxes = boxRes.message[1];\n                    row.custom_box_length = boxRes.message[2];\n                    row.custom_box_breadth = boxRes.message[3];\n                    row.custom_box_height = boxRes.message[4];\n                }\n\n                // 6. Pallet weight calculations\n                if (row.custom_pallet && row.custom_no_of_boxes && row.item_code && row.custom_box) {\n                    const palletRes = await frappe.call({\n                        method: 'onegene.onegene.custom.set_pallet_weight',\n                        args: {\n                            item: row.item_code,\n                            box: row.custom_box,\n                            pallet: row.custom_pallet,\n                            box_qty: row.custom_no_of_boxes\n                        }\n                    });\n\n                    if (palletRes.message) {\n                        row.custom_no_of_pallets = palletRes.message[0];\n                        row.custom_total_weight_of_pallets = palletRes.message[1];\n                        row.custom_pallet_length = palletRes.message[2];\n                        row.custom_pallet_breadth = palletRes.message[3];\n                        row.custom_pallet_height = palletRes.message[4];\n                        row.custom_cbm = (palletRes.message[0] * palletRes.message[2] * palletRes.message[3] * palletRes.message[4]) / 1000000000;\n                    }\n\n                    row.custom_packing_weight = row.custom_total_weight_of_boxes + row.custom_total_weight_of_pallets;\n                    row.custom_gross_weight = row.custom_packing_weight + row.total_weight;\n                    frm.refresh_field(\"items\");\n                    frm.trigger('calculate_total_cbm');\n                } else {\n                    row.custom_packing_weight = row.custom_total_weight_of_boxes + row.custom_total_weight_of_pallets;\n                    row.custom_gross_weight = row.custom_packing_weight + row.total_weight;\n                    frm.refresh_field(\"items\");\n                    frm.trigger('calculate_total_cbm');\n                }\n            }\n        } catch (err) {\n            console.error(\"Error during item processing:\", err);\n        }\n    }\n\n}\n\nfunction validate_and_set_customers_po(frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n\n    frm.fields_dict[\"items\"].grid.get_field(\"custom_customers_po_number\").get_query = function(doc, cdt, cdn) {\n        let child = locals[cdt][cdn];\n        return {\n            query: \"onegene.onegene.custom.get_customer_po_query\",\n            filters: {\n                customer: frm.doc.customer,\n                item_code: child.item_code\n            }\n        };\n    };\n\n    if (frm.doc.customer && row.item_code) {\n        frappe.call({\n            method: \"onegene.onegene.custom.get_customer_po_number\",\n            args: {\n                customer: frm.doc.customer,\n                item_code: row.item_code\n            },\n            callback: function(r) {\n                if (r.message && Array.isArray(r.message)) {\n                    row._valid_po_nos = r.message;\n                    if (r.message.length === 1) {\n                        frappe.model.set_value(cdt, cdn, \"custom_customers_po_number\", r.message[0]);\n                        frappe.call({\n                            method: \"onegene.onegene.custom.get_balance_schedule\",\n                            args: {\n                                pdate: frm.doc.posting_date,\n                                item_code: row.item_code,\n                                po_no: r.message[0]\n                            },\n                            callback: function(res) {\n                                if (res.message && res.message.pending_qty) {\n\n                                    frappe.model.set_value(cdt, cdn, \"custom_schedule_balance_qty\", res.message.pending_qty);\n                                }\n                            }\n                        });\n                    }\n                }\n            }\n        });\n    }\n}\n\nasync function validate_and_set_sales_order(frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n    if (!row.item_code || !frm.doc.customer) return;\n\n    try {\n        // 1. Validate item against allowed list\n        const itemResult = await frappe.call({\n            method: \"onegene.onegene.custom.get_items_for_sii\",\n            args: {\n                doctype: \"Sales Order\",\n                txt: \"\",\n                searchfield: \"name\",\n                start: 0,\n                page_len: 5,\n                filters: {\n                    item_code: row.item_code,\n                    customer: frm.doc.customer,\n                    invoice_type: frm.doc.custom_invoice_type,\n                }\n            }\n        });\n\n        const item_list = itemResult.message.map(r => r[0]);\n        if (!item_list.includes(row.item_code)) {\n            frappe.msgprint({\n                title: __(\"Invalid Item\"),\n                message: __(\"Item <b>{0}</b> is not allowed for the selected customer.\", [row.item_code]),\n                indicator: \"red\"\n            });\n            frm.get_field(\"items\").grid.grid_rows_by_docname[cdn].remove();\n            frm.refresh_field(\"items\");\n            return;\n        }\n\n        // 2. Auto-set sales order if only one match\n        const soResult = await frappe.call({\n            method: \"onegene.onegene.custom.get_so_for_sii\",\n            args: {\n                doctype: \"Sales Order\",\n                txt: \"\",\n                searchfield: \"name\",\n                start: 0,\n                page_len: 5,\n                filters: {\n                    item_code: row.item_code,\n                    customer: frm.doc.customer,\n                }\n            }\n        });\n\n        if (soResult.message && soResult.message.length === 1) {\n            await frappe.model.set_value(cdt, cdn, \"sales_order\", soResult.message[0][0]);\n        }\n\n    } catch (err) {\n        console.error(\"Error during validation and SO setting:\", err);\n    }\n}\n\n\nfunction set_required_fields(frm) {\n    const is_credit_note = frm.doc.custom_invoice_type === 'Credit Note';\n\n    // Make 'sales_order' mandatory only if NOT Credit Note\n    frm.fields_dict['items'].grid.update_docfield_property(\n        'sales_order',\n        'reqd',\n        !is_credit_note\n    );\n\n    // Make 'custom_customers_po_number' mandatory only if NOT Credit Note\n    frm.fields_dict['items'].grid.update_docfield_property(\n        'custom_customers_po_number',\n        'reqd',\n        !is_credit_note\n    );\n}\n\n\n\nfunction refresh_stock_pick_list(frm) {\n    // Collect unique item codes from the child table\n    const item_codes = (frm.doc.items || [])\n        .map(row => row.item_code)\n        .filter(Boolean)\n        .filter((value, index, self) => self.indexOf(value) === index); // Ensures uniqueness\n\n    if (!item_codes.length) {\n        frm.fields_dict.custom_pick_list.$wrapper.empty();\n        return;\n    }\n\n    // Make the API call to get stock data\n    frappe.call({\n        method: 'onegene.onegene.custom.sales_invoice_pick_list_all',\n        args: {\n            item_codes_json: JSON.stringify(item_codes)\n        },\n        callback: function(r) {\n            if (!r.message || !r.message.length) {\n                return;\n            }\n\n            let html = `\n                <table style=\"border:1px solid black;\" class=\"table table-bordered table-sm\">\n                    <thead style=\"border:1px solid black;\">\n                        <tr style=\"border:1px solid black;\">\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">S.NO</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Item Code</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Item Name</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Warehouse</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Rack</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Location</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Available Quantity</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n            `;\n\n            let seen = new Set();\n            let sr = 1;\n\n            r.message.forEach(row => {\n                if (row.available_qty && Number(row.available_qty) > 0) {\n                    const isFirst = !seen.has(row.item_code);\n                    if (isFirst) seen.add(row.item_code);\n\n                    html += `\n                    <tr style=\"border:1px solid black;\">\n                        <td style=\"border:1px solid black; text-align:center; line-height:1;\">${sr}</td>\n                        <td style=\"border:1px solid black; text-align:left; line-height:1;\">${row.item_code || ''}</td>\n                        <td style=\"border:1px solid black; text-align:left; line-height:1;\">${row.item_name || ''}</td>\n                        <td style=\"border:1px solid black; text-align:left; line-height:1;\">${row.warehouse || '-'}</td>\n                        <td style=\"border:1px solid black; text-align:left; line-height:1;\">${row.rack || '-'}</td>\n                        <td style=\"border:1px solid black; text-align:left; line-height:1;\">${row.location || '-'}</td>\n                        <td style=\"border:1px solid black; text-align:right; line-height:1;\">${row.available_qty || 0}</td>\n                    </tr>\n                `;\n\n                    sr++;\n\n                }\n            });\n\n            html += `</tbody></table>`;\n            frm.fields_dict.custom_pick_list.$wrapper.html(html);\n        }\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-06-21 12:00:40.229072",
  "module": "ONEGENE",
  "name": "Sales Order List",
  "script": "frappe.listview_settings['Sales Order'] = {\r\n    onload: function(listview) {\r\n        if (frappe.user.has_role(\"Sales Manager\") || frappe.user.has_role(\"System Manager\")) {\r\n            listview.page.add_inner_button(\"Import Schedule\", function() {\r\n                frappe.set_route('sales-order-schedule-settings')\r\n            });\r\n        }\r\n        \r\n    }\r\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Attendance Tool",
  "enabled": 1,
  "modified": "2025-08-08 20:40:10.113861",
  "module": "ONEGENE",
  "name": "Employee Attendance Tool",
  "script": "frappe.ui.form.on('Employee Attendance Tool', {\n\tonload(frm){\n        frm.set_query(\"shift\", function() {\n            return {\n                filters: {\n                    custom_disabled: 0\n                }\n            };\n        });\n    },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Shift Request",
  "enabled": 1,
  "modified": "2025-08-08 20:41:51.996561",
  "module": "ONEGENE",
  "name": "Shift Request",
  "script": "frappe.ui.form.on('Shift Request', {\n\tonload(frm){\n        frm.set_query(\"shift_type\", function() {\n            return {\n                filters: {\n                    custom_disabled: 0\n                }\n            };\n        });\n    },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 1,
  "modified": "2025-08-26 20:32:22.549323",
  "module": "ONEGENE",
  "name": "Work Order List",
  "script": "let core_settings = frappe.listview_settings['Work Order'] || {};\r\n\r\nfrappe.listview_settings['Work Order'] = {\r\n    ...core_settings,\r\n    onload(listview) {\r\n       \r\n        \r\n        listview.filter_area.add([[listview.doctype, 'custom_is_queued', '=', 0]]);\r\n    }\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Tool",
  "enabled": 1,
  "modified": "2025-08-28 19:56:53.387312",
  "module": "ONEGENE",
  "name": "Tool",
  "script": "frappe.ui.form.on('Tool', {\n// \ttool_name(frm) {\n// \t    frm.set_value('title', frm.doc.tool_name)\n// \t}\n\nrefresh(frm){\n    if (!frm.doc.__islocal) {\n        frm.set_df_property(\"tool_life\", \"read_only\", 1);\n        frm.set_df_property(\"total_processed_qty\", \"read_only\", 1);\n        frm.set_df_property(\"custom_balance_life\", \"read_only\", 1);\n    }\n    if(frm.doc.custom_balance_life == 0){\n        \n        frm.add_custom_button(\"Refurbish\",()=>{\n            frappe.confirm(\"Do you want to refurbish the tool?\",\n            ()=>{\n                \n                frm.set_value(\"total_processed_qty\",0)\n                frm.save()\n                .then(()=>{\n                    \n                    \n                    frm.add_child('custom_refurbishment_log', {\n                \"date\":frappe.datetime.get_today(),\n                \"approval\":frappe.session.user,\n                // \"balance_life\": frm.doc.custom_balance_life\n                });\n\n                frm.refresh_field('custom_refurbishment_log');\n                \n                frm.save()\n                    \n                    \n                    \n                })\n                \n                \n            \n\n                \n\n            },\n            \n            \n            \n            \n            )\n            \n        })\n        \n    }\n    \n    if(frm.doc.status != \"Scrap\"){\n    frm.add_custom_button(\"Scrap\",()=>{\n        frappe.confirm(\"Do you want to mark the tool as Scrap?\",\n        ()=>{\n            \n            frm.set_value(\"custom_scrapbox\",1)\n            frm.set_value(\"status\",\"Scrap\")\n            \n            frm.save()\n        }\n        )\n    })\n    \n    }\n    \n    \n    \n    \n},\n\n// custom_balance_life(frm){\n    \n//     if (frm.doc.status === \"Scrap\") {\n//     return;\n//   }\n\n    \n    \n    \n//     if(frm.doc.custom_balance_life==0){\n//         frm.set_value(\"status\",\"Inactive\")\n//     }\n//     else{\n//       frm.set_value(\"status\",\"Active\") \n//     }\n//     },\n\ntool_life(frm){\n    \n    frm.trigger(\"calculate_balance_life\")\n},\n\ntotal_processed_qty(frm){\n    \n    frm.trigger(\"calculate_balance_life\")\n    \n},\n\ncalculate_balance_life(frm){\n    \n    frm.set_value(\"custom_balance_life\",frm.doc.tool_life - frm.doc.total_processed_qty)\n}\n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quality Inspection",
  "enabled": 1,
  "modified": "2025-11-07 16:27:23.287981",
  "module": "ONEGENE",
  "name": "Quality Inspection",
  "script": "frappe.ui.form.on('Quality Inspection', {\n    setup(frm) {\n        frm.set_indicator_formatter('specification', function(doc) {\n            let readings = [\n                doc.reading_1,\n                doc.reading_2,\n                doc.reading_3,\n                doc.reading_4,\n                doc.reading_5\n            ];\n\n            let has_readings = readings.some(r => r && r !== 0);\n\n            if (!has_readings) {\n                return \"grey\";\n            }\n\n            if (doc.status === \"Accepted\") {\n                return \"green\";\n            } else {\n                return \"red\";\n            }\n        });\n        if (frm.doc.custom_inspection_type === \"Incoming\") {\n            frm.set_df_property(\"reference_type\", \"options\", [\n                \"\",\n                \"Purchase Receipt\",\n                \"Purchase Invoice\",\n                \"Subcontracting Receipt\"\n            ]);\n        } else if (frm.doc.custom_inspection_type === \"In Process\") {\n            frm.set_df_property(\"reference_type\", \"options\", [\n                \"\",\n                \"Job Card\",\n            ]);\n            frm.set_value(\"reference_type\", \"Job Card\");\n        } else if (frm.doc.custom_inspection_type === \"Outgoing\") {\n            frm.set_df_property(\"reference_type\", \"options\", [\n                \"\",\n                \"Delivery Note\",\n                \"Sales Invoice\",\n                \"Stock Entry\"\n            ]);\n        } else {\n            // reset / default\n            frm.set_df_property(\"reference_type\", \"options\", [\"\"]);\n        }\n        if(frm.doc.reference_type){\n            frm.set_query(\"reference_name\", function() {\n    \t\t\tlet filters = {};\n    \t\t\tif (frm.doc.reference_type == 'Purchase Receipt') {\n    \t\t\t\tfilters= {\n    \t\t\t\t\t\"docstatus\": [\"=\", 1],\n    \t\t\t\t\t\n    \t\t\t\t};\n    \t\t\t}\n    \t\t\telse if(frm.doc.reference_type == 'Job Card'){\n    \t\t\t    return{\n    \t\t\t\t    query:\"onegene.onegene.quality_inspection.ref_name_job_card\",\n    \t\t\t    }\n    \t\t\t}\n    \t\t\telse{\n    \t\t\t    filters= {\n    \t\t\t\t\t\"docstatus\": [\"=\", 1],\n    \t\t\t\t};\n    \t\t\t}\n\t\t\treturn { filters: filters };\t\n\t\t});\n        }\n        if (frm.doc.reference_name) {\n            frm.set_query(\"custom_quality_pending\", () => ({\n                filters: {\n                    status: \"Inspection Pending\",\n                    reference_type: frm.doc.reference_type,\n                    reference_name: frm.doc.reference_name\n                }\n            }));\n        }\n\n    },\n    custom_inspection_type:function(frm){\n        if (frm.doc.custom_inspection_type === \"Incoming\") {\n                frm.set_df_property(\"reference_type\", \"options\", [\n                    \"\",\n                    \"Purchase Receipt\",\n                    \"Purchase Invoice\",\n                    \"Subcontracting Receipt\"\n                ]);\n            } else if (frm.doc.custom_inspection_type === \"In Process\") {\n                frm.set_df_property(\"reference_type\", \"options\", [\n                    \"\",\n                    \"Job Card\",\n                ]);\n                frm.set_value(\"reference_type\", \"Job Card\");\n            } else if (frm.doc.custom_inspection_type === \"Outgoing\") {\n                frm.set_df_property(\"reference_type\", \"options\", [\n                    \"\",\n                    \"Delivery Note\",\n                    \"Sales Invoice\",\n                    \"Stock Entry\"\n                ]);\n            } else {\n                // reset / default\n                frm.set_df_property(\"reference_type\", \"options\", [\"\"]);\n            }\n        if(frm.doc.custom_inspection_type){\n        frm.set_value(\"inspection_type\",frm.doc.custom_inspection_type)\n        }\n        \n        \n    },\n    item_code(frm) {\n        if (frm.doc.item_code) {\n            frappe.db.get_value(\"Item\", frm.doc.item_code, \"pack_size\").then(res => {\n                if (res.message && res.message.pack_size) {\n                    frm.set_value(\"custom_pack_size\", res.message.pack_size);\n                } else {\n                    frm.set_value(\"custom_pack_size\", 0);\n                }\n            });\n            frappe.db.get_value(\"Item\", frm.doc.item_code, \"item_group\").then(res => {\n                if (res.message && res.message.item_group) {\n                    frm.set_value(\"custom_item_group\", res.message.item_group);\n                } else {\n                    frm.set_value(\"custom_item_group\", 0);\n                }\n            });\n            frappe.db.get_value(\"Item\", frm.doc.item_code, \"item_name\").then(res => {\n                if (res.message && res.message.item_name) {\n                    frm.set_value(\"item_name\", res.message.item_name);\n                } else {\n                    frm.set_value(\"item_name\", 0);\n                }\n            });\n        } else {\n            frm.set_value(\"custom_pack_size\", 0);\n        }\n        if (frm.doc.custom_quality_pending && frm.doc.item_code && frm.doc.custom_item_billing_type && frm.doc.reference_type) {\n            let inspection_template = \"\";\n            setTimeout(function() {\n                if (frm.doc.reference_type == \"Job Card\") {\n                    if (frm.doc.custom_item_billing_type == \"Billing\") {\n                        inspection_template = frm.doc.item_code + \"-Final\";\n                    }\n                    else {\n                        inspection_template = frm.doc.item_code + \"-Process\";\n                    }\n                    frm.set_value(\"quality_inspection_template\", inspection_template);    \n                }\n            }, 500);\n        }\n    },\n    custom_quality_pending(frm) {\n        if (frm.doc.custom_quality_pending && frm.doc.item_code && frm.doc.custom_item_billing_type && frm.doc.reference_type) {\n            let inspection_template = \"\";\n            setTimeout(function() {\n                if (frm.doc.reference_type == \"Job Card\") {\n                    if (frm.doc.custom_item_billing_type == \"Billing\") {\n                        inspection_template = frm.doc.item_code + \"-Final\";\n                    }\n                    else {\n                        inspection_template = frm.doc.item_code + \"-Process\";\n                    }\n                    frm.set_value(\"quality_inspection_template\", inspection_template);    \n                }\n            }, 500);\n        }\n    },\n\n    inspection_type: function(frm) {\n        if (!frm.doc.inspection_type) {\n            frm.set_value(\"reference_type\", \"\");\n            frm.set_value(\"reference_name\", \"\");\n            frm.set_value(\"custom_quality_pending\", \"\");\n            frm.set_value(\"item_code\", \"\");\n            frm.set_value(\"custom_no_of_bins\", \"\");\n            frm.set_value(\"custom_pending_qty\", \"\");\n            frm.set_value(\"custom_possible_inspection_qty\", \"\");\n            frm.set_value(\"custom_accepted_qty\", \"\");\n            frm.set_value(\"quality_inspection_template\", \"\");\n            frm.set_value(\"custom_inspected_qty\", \"\");\n            frm.set_value(\"custom_rejected_qty\", \"\");\n            frm.set_value(\"custom_rework_qty\", \"\");\n            frm.set_value(\"readings\", \"\");\n            frm.set_value(\"custom_rejection_category\", \"\");\n            frm.set_value(\"custom_rework_category\", \"\");\n            frm.set_value(\"custom_rejection_reason\", \"\");\n            frm.set_value(\"custom_rework_reason\", \"\");\n            frm.set_value(\"custom_item_group\", \"\")\n        }\n        if (frm.doc.inspection_type === \"Incoming\") {\n            frm.set_df_property(\"reference_type\", \"options\", [\n                \"\",\n                \"Purchase Receipt\",\n                \"Purchase Invoice\",\n                \"Subcontracting Receipt\"\n            ]);\n            if ([\"Job Card\", \"Delivery Note\", \"Sales Invoice\", \"Stock Entry\"].includes(frm.doc.reference_type)) {\n                frm.set_value(\"reference_type\", \"\");\n                frm.set_value(\"reference_name\", \"\");\n                frm.set_value(\"custom_quality_pending\", \"\");\n                frm.set_value(\"item_code\", \"\");\n                frm.set_value(\"custom_no_of_bins\", \"\");\n                frm.set_value(\"custom_pending_qty\", \"\");\n                frm.set_value(\"custom_possible_inspection_qty\", \"\");\n                frm.set_value(\"custom_accepted_qty\", \"\");\n                frm.set_value(\"quality_inspection_template\", \"\");\n                frm.set_value(\"custom_inspected_qty\", \"\");\n                frm.set_value(\"custom_rejected_qty\", \"\");\n                frm.set_value(\"custom_rework_qty\", \"\");\n                frm.set_value(\"readings\", \"\");\n                frm.set_value(\"custom_rejection_category\", \"\");\n                frm.set_value(\"custom_rework_category\", \"\");\n                frm.set_value(\"custom_rejection_reason\", \"\");\n                frm.set_value(\"custom_rework_reason\", \"\");\n                frm.set_value(\"custom_item_group\", \"\")\n            }\n        } else if (frm.doc.inspection_type === \"In Process\") {\n            frm.set_df_property(\"reference_type\", \"options\", [\n                \"\",\n                \"Job Card\",\n            ]);\n            frm.set_value(\"reference_type\", \"Job Card\")\n            if ([\"Delivery Note\", \"Sales Invoice\", \"Stock Entry\", \"Purchase Receipt\", \"Purchase Invoice\", \"Subcontracting Receipt\"].includes(frm.doc.reference_type)) {\n                frm.set_value(\"reference_type\", \"\");\n                frm.set_value(\"reference_name\", \"\");\n                frm.set_value(\"custom_quality_pending\", \"\");\n                frm.set_value(\"item_code\", \"\");\n                frm.set_value(\"custom_no_of_bins\", \"\");\n                frm.set_value(\"custom_pending_qty\", \"\");\n                frm.set_value(\"custom_possible_inspection_qty\", \"\");\n                frm.set_value(\"custom_accepted_qty\", \"\");\n                frm.set_value(\"quality_inspection_template\", \"\");\n                frm.set_value(\"custom_inspected_qty\", \"\");\n                frm.set_value(\"custom_rejected_qty\", \"\");\n                frm.set_value(\"custom_rework_qty\", \"\");\n                frm.set_value(\"readings\", \"\");\n                frm.set_value(\"custom_rejection_category\", \"\");\n                frm.set_value(\"custom_rework_category\", \"\");\n                frm.set_value(\"custom_rejection_reason\", \"\");\n                frm.set_value(\"custom_rework_reason\", \"\");\n                frm.set_value(\"custom_item_group\", \"\")\n            }\n        } else if (frm.doc.inspection_type === \"Outgoing\") {\n            frm.set_df_property(\"reference_type\", \"options\", [\n                \"\",\n                \"Delivery Note\",\n                \"Sales Invoice\",\n                \"Stock Entry\"\n            ]);\n            if ([\"Job Card\", \"Purchase Receipt\", \"Purchase Invoice\", \"Subcontracting Receipt\"].includes(frm.doc.reference_type)) {\n                frm.set_value(\"reference_type\", \"\");\n                frm.set_value(\"reference_name\", \"\");\n                frm.set_value(\"custom_quality_pending\", \"\");\n                frm.set_value(\"item_code\", \"\");\n                frm.set_value(\"custom_no_of_bins\", \"\");\n                frm.set_value(\"custom_pending_qty\", \"\");\n                frm.set_value(\"custom_possible_inspection_qty\", \"\");\n                frm.set_value(\"custom_accepted_qty\", \"\");\n                frm.set_value(\"quality_inspection_template\", \"\");\n                frm.set_value(\"custom_inspected_qty\", \"\");\n                frm.set_value(\"custom_rejected_qty\", \"\");\n                frm.set_value(\"custom_rework_qty\", \"\");\n                frm.set_value(\"readings\", \"\");\n                frm.set_value(\"custom_rejection_category\", \"\");\n                frm.set_value(\"custom_rework_category\", \"\");\n                frm.set_value(\"custom_rejection_reason\", \"\");\n                frm.set_value(\"custom_rework_reason\", \"\");\n                frm.set_value(\"custom_item_group\", \"\")\n            }\n        } else {\n            // reset / default\n            frm.set_df_property(\"reference_type\", \"options\", [\"\"]);\n        }\n    },\n\n    before_workflow_action: async (frm) => {\n        if (frm.doc.workflow_state == \"Pending For HOD\") {\n            if (frm.selected_workflow_action == \"Approve\") {\n                // $.each(frm.doc.readings, function(i, j) {\n                //     j.status = 'Accepted';\n                // });\n                // frm.set_value('status','Accepted');\n                // await frm.save();\n                await frappe.call({\n                    method: \"erpnext.stock.doctype.quality_inspection.quality_inspection.inspect_and_set_status_new\",\n                    args: {\n                        \"doc\": frm.doc.name,\n                    }\n                });\n                // $.each(frm.doc.readings, function(i, j) {\n                //     j.status = 'Approved'\n                // })\n\n            }\n        }\n    },\n\n    reference_name(frm) {\n\n        if (frm.doc.reference_type && frm.doc.reference_type == \"Job Card\") {\n            if (frm.doc.reference_name) {\n                frappe.db.get_value(\"Job Card\", {\n                    \"name\": frm.doc.reference_name\n                }, \"production_item\").then(r => {\n\n                    if (r.message && r.message.production_item) {\n                        frm.set_value(\"item_code\", r.message.production_item)\n                    } else {\n                        frm.set_value(\"item_code\", \"\")\n                    }\n                })\n                \n                if (frm.doc.reference_type == \"Job Card\" && frm.doc.reference_name) {\n            frappe.call({\n                method: \"onegene.onegene.quality_inspection.get_quality_pending\",\n                args: {\n                    job_card: frm.doc.reference_name\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        frm.set_value(\"custom_quality_pending\", r.message[0]);\n                        frm.set_value(\"custom_pending_qty\", r.message[1]);\n                        frm.set_value(\"custom_possible_inspection_qty\", r.message[1]);\n                        frm.refresh_field(\"custom_quality_pending\");\n                    } else {\n                        frm.set_value(\"custom_quality_pending\", \"\");\n                        frm.set_value(\"custom_pending_qty\", 0);\n                        frm.set_value(\"custom_possible_inspection_qty\", 0);\n                        frappe.msgprint({\n                            message: `<span style=\"color:red;\">${__(\"No Quality Pending available for this Job Card.\")}</span>`,\n                            indicator: \"red\"\n                        });\n\n                    }\n                }\n            });\n        }\n            } else {\n                frm.set_value(\"item_code\", \"\")\n            }\n        }\n    },\n\n    refresh(frm) {\n        \n        \n         if(frappe.user.has_role(\"Quality User\")){\n            \n            if(!(frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System Manager\") || frappe.user.has_role(\"Quality Manager\") || frappe.user.has_role(\"Quality Engineer\"))){\n             \n             let allowed = [\"reference_name\",\"readings\"];\n             \n             frm.fields.forEach(field => {\n                if (!allowed.includes(field.df.fieldname)) {\n                    frm.set_df_property(field.df.fieldname, \"read_only\", 1);\n                } \n            });\n            \n            \n            //  const grid = frm.get_field(\"readings\").grid;\n                \n                \n            //     grid.cannot_add_rows = true;\n\n               \n            //     grid.wrapper.find('.grid-remove-row').hide();\n\n                \n            //     frm.fields_dict[\"readings\"].$wrapper.find('.grid-add-row').hide();\n            \n            \n            const grid = frm.get_field(\"readings\").grid;\n                grid.cannot_add_rows = true;\n\n                \n                frm.fields_dict[\"readings\"].$wrapper.find('.grid-add-row').hide();\n\n               \n                frm.fields_dict[\"readings\"].$wrapper.find('.grid-remove-rows').hide();\n\n                \n                frm.fields_dict[\"readings\"].$wrapper.find('.grid-row-check').hide();\n\n                \n                frm.fields_dict[\"readings\"].$wrapper.find('input[type=\"checkbox\"]').prop(\"disabled\", true);\n\n                \n                frm.fields_dict[\"readings\"].$wrapper.find('.grid-header .grid-row-check').hide();\n            \n            \n                \n            }\n        }\n        \n        \n        \n        // frm.add_custom_button(__(\"View\"), function() {\n        //     frappe.call({\n        //         method: \"onegene.onegene.custom.create_html_QID\",\n        //         args: {\n        //             doc: frm.doc\n        //         },\n        //         callback: function(r) {\n        //             if (r.message && r.message.html) {\n        //                 let d = new frappe.ui.Dialog({\n\n        //                     size: \"large\",\n        //                     primary_action_label: __(\"Close\"),\n        //                     primary_action: function() {\n        //                         d.hide();\n        //                     }\n        //                 });\n        //                 d.$body.html(r.message.html);\n        //                 d.show();\n        //             } else {\n        //                 frappe.msgprint(__(\"Unable to load preview\"));\n        //             }\n        //         }\n        //     });\n        // });\n        \n        \n        \tfrm.set_query(\"reference_name\", function() {\n\t\t\tlet filters = {};\n\t\t\tif (frm.doc.reference_type != 'Job Card') {\n\t\t\t    \n\t\t\t    \n                \n\t\t\t\tfilters= {\n\t\t\t\t\t\"docstatus\": [\"!=\", 2],\n\t\t\t\t};\n                \n\t\t\t}\n\t\t\t\n\t\t\telse if(frm.doc.reference_type == 'Job Card'){\n\t\t\t    \n\t\t\t    return{\n\n\t\t\t\tquery:\"onegene.onegene.quality_inspection.ref_name_job_card\",\n\t\t\t\t\n\t\t\t}\n\t\t\t}\n\t\t\t    \n\t\t\t\n\t\t\t\n\t\t\treturn { filters: filters };\t\n\t\t});\n\t\t\n\n\n\n        frm.set_query(\"reference_type\", function() {\n            return {\n                filters: {\n                    inspection_type: frm.doc.inspection_type\n                }\n            }\n        })\n\n        frm.trigger('set_reading_list_view');\n        frm.fields_dict[\"readings\"].grid.update_docfield_property('custom_send_for_approval', 'hidden', 1);\n        frm.refresh_field(\"readings\");\n            if (frm.doc.docstatus == 0 && frm.doc.workflow_state == \"Draft\") {\n                frm.add_custom_button(__(\"Inspection Entry\"), () => {\n                    \n                    if (!frm.doc.readings || frm.doc.readings.length === 0) {\n                        frappe.msgprint(__('No parameters found to mark readings'));\n                        return;\n                    }\n                    \n                    let all_filled = true;\n                    (frm.doc.readings || []).forEach(row => {\n                        if (!(row.reading_1 && row.reading_2 && row.reading_3 && row.reading_4 && row.reading_5)) {\n                            all_filled = false;\n                        }\n                    });\n                    if (!all_filled) {\n                        frappe.msgprint(__('Please fill all readings (1–5) for every Paramters.'));\n                        frappe.msgprint(__('எல்லா Parameter-களுக்கும் அனைத்து (1–5)  reading-களையும் நிரப்பவும்.'));\n                        return;\n                    }\n                    \n                    let d = new frappe.ui.Dialog({\n                        title: 'Enter details',\n                        fields: [{\n                                fieldtype: 'Section Break'\n                            },\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            {\n                                label: 'Employee',\n                                fieldname: 'employee',\n                                fieldtype: 'Link',\n                                options: 'Employee',\n                                reqd: 1,\n                                change: function() {\n                                    getEmployeeName();\n                                    getUserId();\n                                }\n                            },\n                            {\n                                label: 'User ID',\n                                fieldname: 'inspected_by',\n                                fieldtype: 'Link',\n                                options: 'User',\n                                reqd: 1,\n                                read_only: 1\n                            },\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            {\n                                label: 'Employee Name',\n                                fieldname: 'employee_name',\n                                fieldtype: 'Data',\n                                read_only: 1\n                            },\n                            {\n                                label: 'Shift Type',\n                                fieldname: 'shift_type',\n                                fieldtype: 'Link',\n                                options: 'Shift Type',\n                                reqd: 1,\n                                change: function() {\n                                    validateShift();\n                                }\n                            },\n                            {\n                                fieldtype: 'Section Break'\n                            },\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            {\n                                label: '<b style=\"color: #4169e1;\">Possible Inspection Qty</b>',\n                                fieldname: 'possible_inspection_qty',\n                                fieldtype: 'Int',\n                                read_only: 1,\n                                default: flt(frm.doc.custom_possible_inspection_qty) || 0\n                            },\n                            {\n                                label: 'Inspected Qty',\n                                fieldname: 'inspected_qty',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_inspected_qty) || 0,\n                                reqd: 1\n                            },\n                            {\n                                label: 'Pack Size',\n                                fieldname: 'pack_size',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_pack_size) || 0,\n                                read_only: 1\n                            },\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            {\n                                label: 'Inspection Pending Qty',\n                                fieldname: 'pending_qty',\n                                fieldtype: 'Int',\n                                read_only: 1,\n                                default: flt(frm.doc.custom_pending_qty) || 0\n                            },\n                            {\n                                label: '<span style=\"color: green;\">Accepted Qty</span>',\n                                fieldname: 'accepted_qty',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_accepted_qty) || 0,\n                            },\n                            {\n                                label: 'No. of Bins',\n                                fieldname: 'no_of_bins',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_no_of_bins) || 0,\n                                read_only: 1\n                            },\n\n                            {\n                                fieldtype: 'Section Break'\n                            },\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            // {\n                            //     label: '<span style=\"color: red;\">Rejected Qty</span>',\n                            //     fieldname: 'rejected_qty',\n                            //     fieldtype: 'Int',\n                            //     default: flt(frm.doc.custom_rejected_qty) || 0\n                            // },\n                            {\n                                label: '<span style=\"color: red;\">Rejected Qty</span>',\n                                fieldname: 'rejected_qty',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_rejected_qty) || 0,\n                                change: function() {\n                                    let rejected_qty = this.get_value() || 0;\n                                    let rework_qty = d.get_value('rework_qty') || 0;\n                                    let accepted_qty = d.get_value('accepted_qty') || 0;\n                                    let inspected_qty = d.get_value('inspected_qty') || 0;\n\n                                    if (rejected_qty > 0 && (rejected_qty + rework_qty + accepted_qty !== inspected_qty)) {\n                                        // frappe.msgprint(\"Sum of Rejected, Rework and Accepted Qty should match Inspected Qty\");\n                                        d.set_value('rework_qty') = inspected_qty - accepted_qty - rejected_qty\n                                        this.set_value(0); // Reset field to 0\n                                    }\n                                }\n                            },\n                            {\n                                label: 'Rejection Category',\n                                fieldname: 'rejection_category',\n                                fieldtype: 'Link',\n                                options: 'Rejection Category',\n                                depends_on: 'eval: doc.rejected_qty',\n                                mandatory_depends_on: 'eval: doc.rejected_qty'\n                            },\n                            {\n                                label: 'Rejection Reason',\n                                fieldname: 'rejection_reason',\n                                fieldtype: 'Link',\n                                options: 'Rejection Reason',\n                                depends_on: 'eval: doc.rejected_qty',\n                                mandatory_depends_on: 'eval: doc.rejected_qty'\n                            },\n\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            // {\n                            //     label: '<span style=\"color: orange;\">Rework Qty</span>',\n                            //     fieldname: 'rework_qty',\n                            //     fieldtype: 'Int',\n                            //     default: flt(frm.doc.custom_rework_qty) || 0\n                            // },\n                            {\n                                label: '<span style=\"color: orange;\">Rework Qty</span>',\n                                fieldname: 'rework_qty',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_rework_qty) || 0,\n                                change: function() {\n                                    let rejected_qty = d.get_value('rejected_qty') || 0;\n                                    let rework_qty = this.get_value() || 0;\n                                    let accepted_qty = d.get_value('accepted_qty') || 0;\n                                    let inspected_qty = d.get_value('inspected_qty') || 0;\n\n                                    if (rework_qty > 0 && (rejected_qty + rework_qty + accepted_qty !== inspected_qty)) {\n                                        // frappe.msgprint(\"Sum of Rejected, Rework and Accepted Qty should match Inspected Qty\");\n                                        d.set_value('rejected_qty') = inspected_qty - accepted_qty - rework_qty\n                                        this.set_value(0); // Reset field to 0\n                                    }\n                                }\n                            },\n                            {\n                                label: 'Rework Category',\n                                fieldname: 'rework_category',\n                                fieldtype: 'Link',\n                                options: 'Rework Category',\n                                depends_on: 'eval: doc.rework_qty',\n                                mandatory_depends_on: 'eval: doc.rework_qty'\n                            },\n                            {\n                                label: 'Rework Reason',\n                                fieldname: 'rework_reason',\n                                fieldtype: 'Link',\n                                options: 'Rework Reason',\n                                depends_on: 'eval: doc.rework_qty',\n                                mandatory_depends_on: 'eval: doc.rework_qty'\n                            }\n                        ],\n                        size: 'large',\n                        primary_action_label: 'Submit',\n                        primary_action(values) {\n                            let rejected_qty = values.rejected_qty || 0;\n                            let rework_qty = values.rework_qty || 0;\n                            let inspected_qty = values.inspected_qty || 0;\n                            let accepted_qty = values.accepted_qty || 0;\n                            let pending_qty = values.pending_qty || 0;\n\n                            if (rejected_qty === 0 && rework_qty === 0 && inspected_qty !== accepted_qty) {\n                                frappe.msgprint({\n                                    message: `<span style=\"color: red;\">Rejected Qty and Rework Qty are not Present. Please adjust your Inspected Qty</span>`\n                                });\n\n                                return;\n                            }\n\n                            if ((rejected_qty > 0 || rework_qty > 0) && (rejected_qty + rework_qty + accepted_qty !== inspected_qty)) {\n                                frappe.msgprint({\n                                    message: `<span style=\"color: red;\">Sum of Rejected, Rework and Accepted Qty should match Inspected Qty</span>`,\n                                    indicator: \"red\"\n                                });\n\n                                return;\n                            }\n                            \n                            \n                             if (frm.__confirmed) {\n                                    \n                                    return;\n                                }\n                        \n                                if (frm.doc.readings && frm.doc.readings.length > 0) {\n                                    for (let row of frm.doc.readings) {\n                                        for (let i = 1; i <= 10; i++) {\n                                            const reading_value = row[`reading_${i}`];\n                                            if (reading_value < row.min_value || reading_value > row.max_value) {\n                                                frappe.confirm(\n                                                    '<p style=\"color:red;\">Some readings are mismatched. Do you still want to save?</p>',\n                                                    () => {\n                                                        \n                                                        \n                             if ((rejected_qty + rework_qty + accepted_qty) == inspected_qty) {\n                                 let rejection_reason = values.rejection_reason;\n                                let rejection_category = values.rejection_category;\n                                let rework_reason = values.rework_reason;\n                                let rework_category = values.rework_category;\n                                \n                                if (rejected_qty === 0) {\n                                    rejection_reason = \"\";\n                                    rejection_category = \"\"; // optional if you want to reset category too\n                                }\n                                \n                                if (rework_qty === 0) {\n                                    rework_reason = \"\";\n                                    rework_category = \"\"; // optional if you want to reset category too\n                                }\n                                frm.set_value('custom_employee', values.employee);\n                                frm.set_value('custom_accepted_qty', accepted_qty);\n                                frm.set_value('custom_pending_qty', values.pending_qty);\n                                frm.set_value('custom_rejected_qty', rejected_qty);\n                                frm.set_value('custom_rework_qty', rework_qty);\n                                frm.set_value('custom_rejection_category', rejection_category);\n                                frm.set_value('custom_rework_category', rework_category);\n                                frm.set_value('custom_rejection_reason', rejection_reason);\n                                frm.set_value('custom_rework_reason', rework_reason);\n                                frm.set_value('custom_inspected_qty', inspected_qty);\n                                frm.set_value('custom_no_of_bins', values.no_of_bins);\n                                frm.set_value('inspected_by', values.inspected_by);\n                                frm.set_value('custom_shift', values.shift_type);\n                                frm.save().then(() => {\n                                    // Trigger your server-side call here\n                                    frappe.call({\n                                        method: \"onegene.onegene.custom.quality_inspection_state_change\", // replace with your method\n                                        args: {\n                                            quality_inspection: frm.doc.name // passing the saved doc name\n                                        },\n                                        callback: function(r) {\n                                            if (r.message) {\n                                                frm.reload_doc()\n                                            }\n                                        }\n                                    });\n                                });\n\n                                d.hide();\n                            }\n                                                        \n                                                        \n                                                        frm.__confirmed = true;\n                                                        frm.save(); \n                                                    },\n                                                    () => {\n                                                        \n                                                    }\n                                                );\n                                                throw \"Waiting for user confirmation...\";\n                                            }\n                                        }\n                                    }\n                                }\n\n\n\n                            if ((rejected_qty + rework_qty + accepted_qty) == inspected_qty) {\n                                let rejection_reason = values.rejection_reason;\n                                let rejection_category = values.rejection_category;\n                                let rework_reason = values.rework_reason;\n                                let rework_category = values.rework_category;\n                                \n                                if (rejected_qty === 0) {\n                                    rejection_reason = \"\";\n                                    rejection_category = \"\"; // optional if you want to reset category too\n                                }\n                                \n                                if (rework_qty === 0) {\n                                    rework_reason = \"\";\n                                    rework_category = \"\"; // optional if you want to reset category too\n                                }\n\n                                frm.set_value('custom_employee', values.employee);\n                                frm.set_value('custom_accepted_qty', accepted_qty);\n                                frm.set_value('custom_pending_qty', values.pending_qty);\n                                frm.set_value('custom_rejected_qty', rejected_qty);\n                                frm.set_value('custom_rework_qty', rework_qty);\n                                frm.set_value('custom_rejection_category', rejection_category);\n                                frm.set_value('custom_rework_category', rework_category);\n                                frm.set_value('custom_rejection_reason', rejection_reason);\n                                frm.set_value('custom_rework_reason', rework_reason);\n                                frm.set_value('custom_inspected_qty', inspected_qty);\n                                frm.set_value('custom_no_of_bins', values.no_of_bins);\n                                frm.set_value('inspected_by', values.inspected_by);\n                                frm.set_value('custom_shift', values.shift_type);\n                                frm.save().then(() => {\n                                    // Trigger your server-side call here\n                                    frappe.call({\n                                        method: \"onegene.onegene.custom.quality_inspection_state_change\", // replace with your method\n                                        args: {\n                                            quality_inspection: frm.doc.name // passing the saved doc name\n                                        },\n                                        callback: function(r) {\n                                            if (r.message) {\n                                                frm.reload_doc()\n                                            }\n                                        }\n                                    });\n                                });\n\n                                d.hide();\n                            }\n                            // else {\n                            //     frappe.msgprint(\"The Inspected Qty should be equal to the sum of Accepted Qty, Rejected Qty and Rework Qty\")\n                            // }\n                            // if (values.rejected_qty) {\n                            //     if (values.rejected)\n                            // }\n                        }\n                    });\n\n                    // --- Helpers ---\n                    function getEmployeeName() {\n                        frappe.db.get_value(\"Employee\", {\n                                \"name\": d.get_value(\"employee\")\n                            }, \"employee_name\")\n                            .then(r => {\n                                d.set_value(\"employee_name\", r.message ? r.message.employee_name : '');\n                            });\n                    }\n                    \n                    function getUserId() {\n                        frappe.db.get_value(\"Employee\", {\n                                \"name\": d.get_value(\"employee\")\n                            }, \"user_id\")\n                            .then(r => {\n                                d.set_value(\"inspected_by\", r.message ? r.message.user_id : '');\n                            });\n                    }\n                    \n                    function validateInspectedQty() {\n                        const possible = flt(d.get_value(\"possible_inspection_qty\")) || 0;\n                        const inspected = flt(d.get_value(\"inspected_qty\")) || 0;\n                        if (inspected > possible) {\n                            frappe.msgprint(\"Inspected Qty cannot be greater than the Possible Production Quantity\")\n                            d.set_value('inspected_qty', 0);\n                        }\n                    }\n\n                    function validateAcceptedQty() {\n                        const inspected = flt(d.get_value(\"inspected_qty\")) || 0;\n                        const accepted = flt(d.get_value(\"accepted_qty\")) || 0;\n                        if (accepted > inspected) {\n                            frappe.msgprint({\n                                message: `<span style=\"color: red;\">Accepted Qty cannot be greater than the Inspected Qty</span>`,\n                                indicator: \"red\"\n                            });\n                            d.set_value('accepted_qty', 0);\n                            d.set_value('no_of_bins', 0);\n                        }\n                    }\n\n                    function recalculatePendingQty() {\n                        const possible = flt(d.get_value(\"possible_inspection_qty\")) || 0;\n                        const inspected = flt(d.get_value(\"inspected_qty\")) || 0;\n                        const pending = possible - inspected;\n                        d.set_value(\"pending_qty\", pending >= 0 ? pending : 0);\n                        // d.set_value(\"accepted_qty\", inspected >= 0 ? inspected : 0);\n                    }\n\n                    function recalculateBinCount() {\n                        const accepted = flt(d.get_value(\"accepted_qty\")) || 0;\n                        let pack_size = flt(d.get_value(\"pack_size\")) || 0;\n                        if (pack_size > 0) {\n                            bin_count = Math.ceil(accepted / pack_size);\n                            remainder = accepted % pack_size;\n                            if (remainder > 0) {\n                                const accepted = flt(d.get_value(\"accepted_qty\")) || 0;\n                                let pack_size = flt(d.get_value(\"pack_size\")) || 0;\n                                // d.set_value('accepted_qty', accepted - remainder);\n                                d.set_value('accepted_qty', 0)\n                                frappe.msgprint(\"<b style='color: red'>The Accepted Quantity should be in the multiples of Pack Size</b>\")\n                            }\n                        } else {\n                            bin_count = accepted;\n                        }\n                        d.set_value(\"no_of_bins\", bin_count)\n                    }\n\n                    function recalculateRejectedQty() {\n                        const inspected = flt(d.get_value(\"inspected_qty\")) || 0;\n                        const accepted = flt(d.get_value(\"accepted_qty\")) || 0;\n                        const rework = flt(d.get_value(\"rework_qty\")) || 0;\n                        let rejected = inspected - accepted - rework;\n                        if (rejected < 0) rejected = 0;\n                        d.set_value(\"rejected_qty\", rejected);\n                    }\n\n                    function recalculateReworkQty() {\n                        const inspected = flt(d.get_value(\"inspected_qty\")) || 0;\n                        const accepted = flt(d.get_value(\"accepted_qty\")) || 0;\n                        const rejected = flt(d.get_value(\"rejected_qty\")) || 0;\n                        let rework = inspected - accepted - rejected;\n                        if (rework < 0) rework = 0;\n                        d.set_value(\"rework_qty\", rework);\n                    }\n                    \n                    function validateShift() {\n                        let shift = d.get_value(\"shift_type\");\n                        if (shift) {\n                            frappe.call({\n                                method: \"onegene.onegene.custom.get_shift_for_current_time\",\n                                callback: function(r) {\n                                    if (r.message) {\n                                        const shift_list = r.message\n                                            .map(s => s[0])\n                                            .filter(v => v);\n                                        if (shift && !shift_list.includes(shift)) {\n                                            d.set_value(\"shift_type\", \"\");\n                                        }\n                                    }\n                                }\n                            });\n                        }\n                    }\n\n\n                    // --- Bind Changes ---\n                    d.fields_dict.inspected_qty.df.onchange = () => {\n                        validateInspectedQty();\n                        recalculatePendingQty();\n                        recalculateBinCount();\n                    };\n\n                    d.fields_dict.accepted_qty.df.onchange = () => {\n                        validateAcceptedQty();\n                        recalculateBinCount();\n                        // recalculateRejectedQty();\n                        // recalculateReworkQty();\n                    };\n                    \n                    d.fields_dict.shift_type.get_query = () => {\n                        return {\n                            query: \"onegene.onegene.custom.get_shift_for_current_time\",\n                        };\n                    };\n\n                    // d.get_field(\"rejected_qty\").$input.on(\"input\", recalculateReworkQty);\n                    // d.get_field(\"rework_qty\").$input.on(\"input\", recalculateRejectedQty);\n\n                    d.fields_dict.rejection_reason.get_query = () => {\n                        return {\n                            query: \"onegene.onegene.custom.get_rejection_reason\",\n                            filters: {\n                                rejection_category: d.get_value('rejection_category')\n                            }\n                        };\n                    };\n                    d.fields_dict.rework_reason.get_query = () => {\n                        return {\n                            query: \"onegene.onegene.custom.get_rework_reason\",\n                            filters: {\n                                rework_category: d.get_value('rework_category')\n                            }\n                        };\n                    };\n\n                    d.show();\n                }).css({\n                    'color': 'white',\n                    'background-color': \"#000000\"\n                });\n            } else {\n                //     frm.add_custom_button(__(\"Generate QR\"), function () {\n                //     var letter_head = frm.doc.letter_head;\n                //     var f_name = frm.doc.name;\n                //     var print_format =\"Quality Inspection QID\";\n                //      window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                //         + \"doctype=\" + encodeURIComponent(\"Quality Inspection\")\n                //         + \"&name=\" + encodeURIComponent(f_name)\n                //         + \"&trigger_print=1\"\n                //         + \"&format=\" + print_format\n                //         + \"&no_letterhead=0\"\n                //         + \"&letterhead=\" + encodeURIComponent(letter_head) \n                //       ));\n                // }).css({ 'color': 'white', 'background-color': \"#000000\" });\n                if (frm.doc.docstatus == 1 && frm.doc.status == \"Accepted\") {\n\n                    frm.add_custom_button(__(\"Generate QR\"), function() {\n                        frappe.call({\n                            method: \"onegene.onegene.quality_inspection.get_qid_for_quality_inspection_html\",\n                            args: {\n                                quality_inspection: frm.doc.name,\n                            },\n                            callback(r) {\n                                if (r.message) {\n                                    let d = new frappe.ui.Dialog({\n                                        title: 'Generate QR',\n                                        size: \"large\",\n                                        fields: [{\n                                            label: 'QR Preview',\n                                            fieldname: 'html',\n                                            fieldtype: 'HTML',\n                                            options: r.message // set HTML from backend\n                                        }, ],\n                                        primary_action_label: 'Download',\n                                        primary_action(values) {\n                                            frappe.call({\n                                                method: \"onegene.onegene.quality_inspection.get_qid_for_quality_inspection\",\n                                                args: {\n                                                    quality_inspection: frm.doc.name,\n                                                },\n                                                callback(res) {\n                                                    if (res.message) {\n                                                        window.open(res.message); // open PDF link\n                                                    }\n                                                }\n                                            });\n                                            d.hide();\n                                        }\n                                    });\n\n                                    d.show();\n                                }\n                            }\n                        });\n                    }).css({\n                        'color': 'white',\n                        'background-color': \"#000000\"\n                    });\n\n                }\n            }\n    },\n    \n    \n      onload(frm){\n        \n        \n          if(frappe.user.has_role(\"Quality User\")){\n            \n            if(!(frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System Manager\") || frappe.user.has_role(\"Quality Manager\") || frappe.user.has_role(\"Quality Engineer\"))){\n             \n             let allowed = [\"custom_inspection_type\",\"reference_type\",\"reference_name\",\"readings\"];\n             \n             frm.fields.forEach(field => {\n                if (!allowed.includes(field.df.fieldname)) {\n                    frm.set_df_property(field.df.fieldname, \"read_only\", 1);\n                } \n            });\n             \n                \n            }\n        }\n        \n        \n    },\n    \n   \n    \n    show_approval_btn(frm) {\n        frm.fields_dict[\"readings\"].grid.update_docfield_property('dis_qty', 'hidden', 0);\n    },\n    hide_approval_btn(frm) {\n        frm.fields_dict[\"readings\"].grid.update_docfield_property('dis_qty', 'hidden', 1);\n    },\n    // set_reading_list_view(frm) {\n    //     let grid = frm.fields_dict.readings.grid;\n\n    //     // Example: Show reading_1 in list view if majority of rows have numeric = 1\n    //     let numeric_count = frm.doc.readings.filter(row => row.numeric).length;\n    //     let show_reading_1 = numeric_count >= frm.doc.readings.length / 2;\n\n    //     grid.update_docfield_property(\"reading_1\", \"in_list_view\", show_reading_1 ? 1 : 0);\n    //     grid.update_docfield_property(\"reading\", \"in_list_view\", show_reading_1 ? 0 : 1);\n\n    //     grid.refresh();\n    // }\n});\n\n\nfrappe.ui.form.on('Quality Inspection Reading', {\n    \n    numeric(frm, cdt, cdn) {\n        // frm.trigger('set_reading_list_view');\n    },\n    reading_1: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_1 >= child.min_value && child.reading_1 <= child.max_value){\n        trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 1 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_2: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_2 >= child.min_value && child.reading_2 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 2 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_3: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_3 >= child.min_value && child.reading_3 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 3 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_4: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_4 >= child.min_value && child.reading_4 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 4 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_5: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_5 >= child.min_value && child.reading_5 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 5 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_6: function(frm, cdt, cdn) {\n         let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_6 >= child.min_value && child.reading_6 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 6 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_7: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_7 >= child.min_value && child.reading_7 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 7 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_8: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_8 >= child.min_value && child.reading_8 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 8 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_9: function(frm, cdt, cdn) {\n         let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_9 >= child.min_value && child.reading_9 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 9 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_10: function(frm, cdt, cdn) {\n         let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_10 >= child.min_value && child.reading_10 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 10 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n\n    // reading_1: check_readings,\n    // reading_2: check_readings,\n    // reading_3: check_readings,\n    // reading_4: check_readings,\n    // reading_5: check_readings,\n    // reading_6: check_readings,\n    // reading_7: check_readings,\n    // reading_8: check_readings,\n    // reading_9: check_readings,\n    // reading_10: check_readings\n});\n\nfunction trigger_inspect_status(frm) {\n    if (!frm.doc.readings || frm.doc.readings.length === 0) return;\n    if (!frm.doc.__islocal) {\n        frappe.call({\n            method: \"erpnext.stock.doctype.quality_inspection.quality_inspection.inspect_and_set_status_new\",\n            args: {\n                doc: frm.doc.name\n            },\n            callback: function(r) {\n                if (!r.exc) {\n                    frm.refresh_field('readings');\n                    frm.refresh_field('status');\n                    frm.save()\n                }\n            }\n        });\n    }\n    else {\n        check_readings(frm)\n    }\n}\n\nfunction check_readings(frm) {\n    let rejected = false;\n\n    frm.doc.readings.forEach(row => {\n        for (let i = 1; i <= 5; i++) {\n            let reading = row[`reading_${i}`];\n            if (reading && (reading < row.min_value || reading > row.max_value)) {\n                rejected = true;\n            }\n        }\n    });\n    if (!rejected) {\n        frm.set_value(\"status\", \"Accepted\")\n    }\n    else {\n        frm.set_value(\"status\", \"Rejected\")\n    }\n    // frm.fields_dict[\"readings\"].grid.update_docfield_property('custom_send_for_approval', 'hidden', !show_approval);\n    frm.refresh_field(\"readings\");\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Card",
  "enabled": 0,
  "modified": "2025-09-18 12:25:56.188666",
  "module": "ONEGENE",
  "name": "Job Card List",
  "script": "let core_settings = frappe.listview_settings['Job Card'] || {};\r\n\r\nfrappe.listview_settings['Job Card'] = {\r\n    ...core_settings,\r\n    onload(listview) {\r\n       \r\n        \r\n        listview.filter_area.add([[listview.doctype, 'status', '!=', 'Completed']]);\r\n        listview.filter_area.add([[\r\n            \"Job Card\",\r\n            \"posting_date\",\r\n            \"=\",\r\n            frappe.datetime.get_today()\r\n        ]]);\r\n        listview.filter_area.add([[listview.doctype, 'custom_is_queued', '=', 0]]);\r\n    }\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-10-31 11:52:24.458271",
  "module": "ONEGENE",
  "name": "Material Request List",
  "script": "let core_settings = frappe.listview_settings['Material Request'] || {};\n\nfrappe.listview_settings['Material Request'] = {\n    ...core_settings,\n\n    onload: function(listview) {\n        \n        //  if (frappe.user.has_role('Stock User')) {\n        //     // force ignore_user_permissions for filters\n        //     listview.page.fields_dict['custom_department'] &&\n        //         (listview.page.fields_dict['custom_department'].df.ignore_user_permissions = 1);\n\n        //     listview.page.fields_dict['custom_requested_by'] &&\n        //         (listview.page.fields_dict['custom_requested_by'].df.ignore_user_permissions = 1);\n        // }\n        \n        \n        if (frappe.user.has_role('Stock User')) {\n            // Disable user permission filters for custom fields\n            if (listview.page.fields_dict['custom_department']) {\n                listview.page.fields_dict['custom_department'].df.ignore_user_permissions = 1;\n                listview.page.fields_dict['custom_department'].refresh();\n            }\n            if (listview.page.fields_dict['custom_requested_by']) {\n                listview.page.fields_dict['custom_requested_by'].df.ignore_user_permissions = 1;\n                listview.page.fields_dict['custom_requested_by'].refresh();\n            }\n        }\n        \n        \n        \n        \n        \n        \n        listview.filter_area.clear().then(r=>{\n            \n            \n            listview.filter_area.add([[\n            \"Material Request\",\n            \"transaction_date\",\n            \"=\",\n            frappe.datetime.get_today()\n        ]]);\n            \n            \n        });\n        \n    },\n    \n    refresh : function(listview){\n        \n        \n        //  if (frappe.user.has_role('Stock User')) {\n        //     // force ignore_user_permissions for filters\n        //     listview.page.fields_dict['custom_department'] &&\n        //         (listview.page.fields_dict['custom_department'].df.ignore_user_permissions = 1);\n\n        //     listview.page.fields_dict['custom_requested_by'] &&\n        //         (listview.page.fields_dict['custom_requested_by'].df.ignore_user_permissions = 1);\n        // }\n        \n        \n        if (frappe.user.has_role('Stock User')) {\n            // Disable user permission filters for custom fields\n            if (listview.page.fields_dict['custom_department']) {\n                listview.page.fields_dict['custom_department'].df.ignore_user_permissions = 1;\n                listview.page.fields_dict['custom_department'].refresh();\n            }\n            if (listview.page.fields_dict['custom_requested_by']) {\n                listview.page.fields_dict['custom_requested_by'].df.ignore_user_permissions = 1;\n                listview.page.fields_dict['custom_requested_by'].refresh();\n            }\n        }\n        \n        \n        listview.page.add_inner_button(__('Requested vs Actual'), function () {\n            let tableHTML = \"\";\n\n            let d = new frappe.ui.Dialog({\n                title: __(\"Requested vs Actual Qty\"),\n                fields: [\n                    {\n                        fieldtype: \"Date\",\n                        fieldname: \"from_date\",\n                        label: \"From Date\",\n                        reqd: 1\n                    },\n                    {\n                        fieldtype: 'Column Break',\n                    },\n                    {\n                        fieldtype: \"Date\",\n                        fieldname: \"to_date\",\n                        label: \"To Date\",\n                        reqd: 1\n                    },\n                    {\n                        fieldtype: 'Section Break',\n                    },\n                    {\n                        fieldtype: \"HTML\",\n                        fieldname: \"requested_vs_actual_table\",\n                        options: tableHTML\n                    }\n                ],\n                size: 'large',\n                primary_action_label: __('View'),\n                primary_action(values) {\n                    let from_date = values.from_date;\n                    let to_date = values.to_date;\n\n                    frappe.call({\n                        method: \"onegene.onegene.custom.request_vs_actual_mt\",\n                        args: {\n                            from_date: from_date,\n                            to_date: to_date\n                        },\n                        callback: function(response) {\n                            let data = response.message;\n                            console.log(data);\n                            if (data && data.length > 0) {\n                                console.log(data);\n                                \n                                let tableRows = '';\n                                let total_requested = 0;\n                                let total_completed = 0;\n\n                                data.forEach(row => {\n                                    // Only include rows where requested_qty > 0\n                                    if (row.requested_qty > 0) {\n                                        total_requested += row.requested_qty;\n                                        total_completed += row.completed_qty;\n\n                                        tableRows += `\n                                            <tr style=\"border:1px solid black;\"> \n                                                <td style=\"text-align:left; border:1px solid black;\">${row.item_code}</td>\n                                                <td style=\"text-align:left; border:1px solid black;\">${row.item_name}</td>\n                                                <td style=\"text-align:right; border:1px solid black;\">${row.requested_qty.toFixed(2)}</td>\n                                                <td style=\"text-align:right; border:1px solid black;\">${row.completed_qty > 0 ? row.completed_qty.toFixed(2) : \"-\"}</td>\n                                            </tr>\n                                        `;\n                                    }\n                                });\n\n                                // Format totals to two decimal places\n                                total_requested = total_requested.toFixed(2);\n                                total_completed = total_completed.toFixed(2);\n\n                                let tableHTML = `\n                                    <table class=\"table table-bordered\" style=\"border:1px solid black;\">\n                                        <thead>\n                                            <tr style=\"border:1px solid black;\">\n                                                <th style=\"text-align:center; background-color:orange; border:1px solid black;\">Item Code</th>\n                                                <th style=\"text-align:center; background-color:orange; border:1px solid black;\">Item Name</th>\n                                                <th style=\"text-align:center; background-color:orange; border:1px solid black;\">Requested</th>\n                                                <th style=\"text-align:center; background-color:orange; border:1px solid black;\">Issued</th>\n                                            </tr>\n                                        </thead>\n                                        <tbody>\n                                            ${tableRows}\n                                            <tr style=\"background-color:yellow; font-weight:bold; border:1px solid black;\">\n                                                <td colspan=\"2\" style=\"border:1px solid black;\">Total</td>\n                                                <td colspan=\"1\" style=\"border:1px solid black; text-align:right;\">${total_requested}</td>\n                                                <td colspan=\"1\" style=\"border:1px solid black; text-align:right;\">${total_completed}</td>\n                                            </tr>\n                                        </tbody>\n                                    </table>\n                                `;\n                                d.fields_dict['requested_vs_actual_table'].$wrapper.html(tableHTML);\n                            } else {\n                                d.fields_dict['requested_vs_actual_table'].$wrapper.html(\"<p>No data available</p>\");\n                            }\n                        }\n                    });\n                }\n            });\n\n            d.show();\n        });\n        \n        \n        \n        \n    }\n};\n\n\n\n\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-10-10 08:46:41.453729",
  "module": "ONEGENE",
  "name": "Stock Entry",
  "script": "// frappe.ui.form.on('Stock Entry', {\n//     refresh(frm) {\n//         // frm.add_custom_button(__(\"Entry\"), function() {\n//         //     let d = new frappe.ui.Dialog({\n//         //         title: __('Enter Details'),\n//         //         fields: [{\n//         //                 fieldtype: 'Link',\n//         //                 label: __('Inspection ID'),\n//         //                 fieldname: 'quality_inspection',\n//         //                 options: 'Quality Inspection',\n//         //                 reqd: 1,\n//         //                 change: function() {\n//         //                     getQualityInspectionData();\n//         //                 }\n//         //             },\n//         //             {\n//         //                 fieldtype: 'Link',\n//         //                 label: __('Item Code'),\n//         //                 fieldname: 'item_code',\n//         //                 options: 'Item',\n//         //                 reqd: 1,\n//         //                 read_only: 1,\n//         //             },\n//         //             {\n//         //                 fieldtype: 'Int',\n//         //                 label: __('Receiving Qty'),\n//         //                 fieldname: 'accepted_qty',\n//         //                 reqd: 1,\n//         //                 read_only: 1,\n//         //             },\n//         //             {\n//         //                 fieldtype: 'Link',\n//         //                 label: __('Rack'),\n//         //                 fieldname: 'rack',\n//         //                 options: 'Rack',\n//         //                 reqd: 1\n//         //             },\n//         //             {\n//         //                 fieldtype: 'Link',\n//         //                 label: __('Location'),\n//         //                 fieldname: 'location',\n//         //                 options: 'Rack Location',\n//         //                 reqd: 1\n//         //             },\n//         //             {\n//         //                 fieldtype: 'Link',\n//         //                 label: __('UOM'),\n//         //                 fieldname: 'uom',\n//         //                 options: 'UOM',\n//         //                 hidden: 1\n//         //             },\n//         //         ],\n//         //         primary_action_label: __('Submit'),\n//         //         primary_action(values) {\n//         //             // frm.set_value(\"from_warehouse\", \"Quality Outward - WAIP\");\n//         //             // frm.set_value(\"to_warehouse\", \"Finished Goods - WAIP\");\n//         //             frm.doc.items = frm.doc.items.filter(row => row.item_code);\n//         //             let child = frm.add_child(\"items\", {\n//         //                 item_code: values.item_code, // Or fetch item_code linked to this inspection\n//         //                 qty: values.accepted_qty,\n//         //                 s_warehouse: \"Quality Outward - WAIP\",\n//         //                 t_warehouse: \"Finished Goods - WAIP\",\n//         //                 custom_rack: values.rack,\n//         //                 custom_location: values.location,\n//         //                 uom: values.uom,\n//         //                 conversion_factor: 1,\n//         //                 transfer_qty: values.accepted_qty,\n//         //             });\n\n//         //             frm.refresh_field(\"items\");\n//         //             d.hide();\n//         //         }\n//         //     });\n\n//         //     function getQualityInspectionData() {\n//         //         let quality_inspection = d.get_value(\"quality_inspection\");\n//         //         if (!quality_inspection) return;\n\n//         //         frappe.call({\n//         //             method: \"onegene.onegene.custom.get_quality_inspection_data\",\n//         //             args: {\n//         //                 quality_inspection: quality_inspection\n//         //             },\n//         //             callback: function(r) {\n//         //                 if (r.message) {\n//         //                     let accepted_qty = r.message[1] || 0;\n//         //                     let rack = r.message[2] || \"\";\n//         //                     let location = r.message[3] || \"\";\n//         //                     let item_code = r.message[0] || \"\";\n//         //                     let uom = r.message[4] || \"\";\n\n//         //                     d.set_value(\"item_code\", item_code);\n//         //                     d.set_value(\"accepted_qty\", accepted_qty);\n//         //                     d.set_value(\"uom\", uom);\n//         //                     d.set_value(\"rack\", rack);\n//         //                     d.set_value(\"location\", location);\n//         //                 }\n//         //             }\n//         //         });\n//         //     }\n            \n//         //     d.fields_dict.rack.get_query = () => {\n//         //         return {\n//         //             query: \"onegene.onegene.custom.get_rack_query\",\n//         //             filters: {\n//         //                 item_code: d.get_value(\"item_code\")\n//         //             }\n//         //         };\n//         //     };\n        \n            \n//         //     d.fields_dict.location.get_query = () => {\n//         //         return {\n//         //             query: \"onegene.onegene.custom.get_rack_location_query\",\n//         //             filters: {\n//         //                 item_code: d.get_value(\"item_code\")\n//         //             }\n//         //         };\n//         //     }\n            \n//         //     d.show();\n//         // });\n\n//         if (frm.doc.custom_issued_by != '' && frm.doc.__islocal) {\n//             user = frappe.session.user\n//             frappe.db.get_value(\"Employee\", {\n//                     'user_id': user\n//                 }, ['name'])\n//                 .then(r => {\n//                     if (r.message && r.message.name) {\n//                         frm.set_value('custom_issued_by', r.message.name);\n//                     }\n\n//                 })\n//         }\n//         if (frm.doc.__islocal) {\n//             frm.set_value('stock_entry_type', 'Material Transfer')\n//             frappe.after_ajax(() => {\n//                 // Wait a little to ensure items are mapped (if delayed)\n//                 setTimeout(() => {\n//                     (frm.doc.items || []).forEach(item => {\n//                         frappe.model.set_value(item.doctype, item.name, 'qty', 0);\n//                     });\n//                 }, 300); // small delay to ensure items exist\n//             });\n//         }\n//         frm.set_query(\"custom_material_request\", function() {\n//             const today = frappe.datetime.get_today();\n//             const today_830 = `${today} 08:30:00`;\n//             return {\n//                 filters: {\n//                     \"docstatus\": 1,\n//                     \"material_request_type\": \"Material Transfer\",\n//                     \"status\": [\"not in\", [\"Transferred\", \"Issued\", \"Cancelled\", \"Stopped\"]],\n//                     \"creation\": [\">\", today_830]\n//                 }\n//             }\n//         })\n//     },\n//     onload(frm) {\n//         if (frm.doc.custom_issued_by != '' && frm.doc.__islocal) {\n//             user = frappe.session.user\n//             frappe.db.get_value(\"Employee\", {\n//                     'user_id': user\n//                 }, ['name'])\n//                 .then(r => {\n//                     if (r.message && r.message.name) {\n//                         frm.set_value('custom_issued_by', r.message.name);\n//                     }\n\n//                 })\n//         }\n//         if (frm.doc.__islocal) {\n//             frm.set_value('stock_entry_type', 'Material Transfer')\n//             frappe.after_ajax(() => {\n//                 setTimeout(() => {\n//                     (frm.doc.items || []).forEach(item => {\n//                         frappe.model.set_value(item.doctype, item.name, 'qty', 0);\n//                     });\n//                 }, 300);\n//             });\n\n//             frm.refresh_field('items');\n//             setTimeout(function() {\n//             if (frm.doc.custom_material_request && frm.doc.__islocal) {\n//                 frappe.call({\n//                     method: \"frappe.client.get\",\n//                     args: {\n//                         doctype: \"Material Request\",\n//                         name: frm.doc.custom_material_request\n//                     },\n//                     callback: function(response) {\n//                         if (response.message) {\n//                             let mr_doc = response.message;\n\n//                             frm.doc.items.forEach(item => {\n//                                 frappe.model.set_value(item.doctype, item.name, 't_warehouse', \"Shop Floor - WAIP\");\n//                                 let matching_item = mr_doc.items.find(mr_item => mr_item.item_code === item.item_code);\n\n//                                 if (matching_item) {\n//                                     let balance_qty = flt(matching_item.qty) - flt(matching_item.ordered_qty);\n\n//                                     frappe.model.set_value(item.doctype, item.name, 'balance_qty_to_receive', balance_qty);\n//                                 }\n//                             });\n//                         }\n//                     }\n//                 });\n//             }\n//         }, 1000);\n//         }\n//     },\n//     custom_material_request(frm) {\n//         frappe.call({\n//             method: \"erpnext.stock.doctype.material_request.material_request.make_stock_entry\",\n//             args: {\n//                 source_name: frm.doc.custom_material_request, // first selected MR\n//             },\n//             callback(r) {\n//                 if (!r.message) return;\n//                 // Clear existing items in Stock Entry\n//                 frm.clear_table(\"items\");\n\n//                 // Add items from the response\n//                 (r.message.items || []).forEach(row => {\n//                     const child = frm.add_child(\"items\");\n//                     Object.assign(child, row);\n//                     child.qty = 0;\n//                 });\n                \n//                 frm.doc.to_warehouse = \"Shop Floor - WAIP\";\n//                 frm.refresh_field(\"items\");\n//             }\n//         });\n//     }\n\n// })\n\n// frappe.ui.form.on('Stock Entry Detail', {\n//     qty(frm, cdt, cdn) {\n//         var child = locals[cdt][cdn]\n        \n//          if(child.item_code){\n//           frappe.db.get_value(\"Item\",{\"name\":child.item_code},\"custom_warehouse\").then(r=>{\n//               if (r.message && r.message.custom_warehouse){\n//                   frappe.model.set_value(cdt,cdn,\"t_warehouse\",r.message.custom_warehouse)\n//               }\n               \n//           })\n           \n           \n//         }\n        \n        \n//         if (child.s_warehouse || child.t_warehouse && frm.doc.stock_entry_type == \"Material Transfer\") {\n//             frappe.call({\n//                 'method': 'onegene.onegene.custom.validate_stock_qty',\n//                 'args': {\n//                     'item_code': child.item_code,\n//                     \"warehouse\": child.s_warehouse || child.t_warehouse,\n//                     \"posting_date\": frm.doc.posting_date,\n//                     \"posting_time\": frm.doc.posting_time,\n//                     \"qty\": child.qty,\n//                     \"idx\": child.idx\n//                 }\n//             })\n//             if (child.qty > child.actual_qty) {\n//                 frappe.model.set_value(cdt, cdn, 'qty', 0);\n//             }\n//         }\n//     },\n//     item_code(frm, cdt, cdn) {\n//         var child = locals[cdt][cdn]\n        \n    \n        \n//         if (child.s_warehouse || child.t_warehouse && frm.doc.stock_entry_type == \"Material Transfer\") {\n//             frappe.call({\n//                 'method': 'onegene.onegene.custom.validate_stock_qty',\n//                 'args': {\n//                     'item_code': child.item_code,\n//                     \"warehouse\": child.s_warehouse || child.t_warehouse,\n//                     \"posting_date\": frm.doc.posting_date,\n//                     \"posting_time\": frm.doc.posting_time,\n//                     \"qty\": child.qty,\n//                     \"idx\": child.idx\n//                 }\n//             })\n//         }\n//         if (frm.doc.custom_material_request && child.item_code) {\n//             frappe.call({\n//                 method: \"frappe.client.get\",\n//                 args: {\n//                     doctype: \"Material Request\",\n//                     name: frm.doc.custom_material_request\n//                 },\n//                 callback: function(response) {\n//                     if (response.message) {\n//                         var mr_doc = response.message;\n\n//                         // Find matching item row in Material Request\n//                         var matching_item = mr_doc.items.find(mr_item => mr_item.item_code === child.item_code);\n\n//                         if (matching_item) {\n//                             var balance_qty = flt(matching_item.qty) - flt(matching_item.ordered_qty);\n\n//                             frappe.model.set_value(cdt, cdn, \"balance_qty_to_receive\", balance_qty);\n//                         }\n//                     }\n//                 }\n//             });\n//         }\n\n        \n//     }\n// })\n\n// frappe.ui.form.on('Stock Entry', {\n//     onload: function(frm) {\n//         if (!frm.doc.posting_time) {\n//             frm.set_value('posting_time', frappe.datetime.now_time());\n//         }\n//     }\n// });\n\n\nfrappe.ui.form.on('Stock Entry Detail', {\n    \n    \n    item_code(frm, cdt, cdn) {\n        \n        var child = locals[cdt][cdn]\n        \n        \n         if(child.item_code){\n          frappe.db.get_value(\"Item\",{\"name\":child.item_code},\"custom_warehouse\").then(r=>{\n               if (r.message && r.message.custom_warehouse){\n                   frappe.model.set_value(cdt,cdn,\"t_warehouse\",r.message.custom_warehouse)\n               }\n               \n           })\n           \n           \n        }\n        \n    }\n})\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order Schedule",
  "enabled": 1,
  "modified": "2025-11-22 12:34:20.136417",
  "module": "ONEGENE",
  "name": "Sales Order Schedule",
  "script": "let core_settings = frappe.listview_settings['Sales Order Schedule'] || {};\nfrappe.listview_settings['Sales Order Schedule'] = {\n    ...core_settings,\n    onload: function(listview) {\n\n        listview.filter_area.clear().then(r => {\n\n            const currentMonth = new Date().toLocaleString('default', {\n                month: 'short'\n            }).toUpperCase();\n\n\n            listview.filter_area.add([\n                [\n                    \"Sales Order Schedule\", \"schedule_month\", \"=\", currentMonth\n\n\n                ]\n            ]);\n\n            if (frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System Manager\")) {\n                listview.page.add_inner_button(\"Import Schedule\", function() {\n                    frappe.set_route('sales-order-schedule-settings')\n                });\n            }\n\n\n        })\n\n\n\n\n    },\n\n\n\n    refresh: function(listview) {\n        listview.page.add_inner_button(__('Customer Wise'), function() {\n            const filters = listview.filter_area.get();\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\n\n            const year = new Date().getFullYear().toString().slice(-2);\n\n\n            if (!mon) {\n                mon = new Date().toLocaleString('default', {\n                    month: 'short'\n                }).toUpperCase();\n            }\n\n\n\n            frappe.call({\n                method: \"onegene.onegene.custom.customer_wise_plan\",\n                args: {\n                    month: mon\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        const groupedData = r.message;\n                        const groups = Object.keys(groupedData);\n\n                        const leftGroup = groups.find(g => g.toUpperCase() === 'DOMESTIC') || groups[0] || 'DOMESTIC';\n                        const rightGroup = groups.find(g => g.toUpperCase() === 'EXPORT') || groups[1] || 'EXPORT';\n\n                        const leftCustomers = groupedData[leftGroup] || {};\n                        const rightCustomers = groupedData[rightGroup] || {};\n\n                        // generateTableHTML now returns {html, subtotal}\n                        const leftData = generateTableHTML(leftGroup, leftCustomers);\n                        const rightData = generateTableHTML(rightGroup, rightCustomers);\n\n                        const combinedHTML = `\n                <style>\n                    .table-container {\n                        display: flex;\n                        justify-content: space-between;\n                        align-items: flex-start;\n                        gap: 20px;\n                        flex-wrap: wrap;\n                    }\n                    .table-wrapper {\n                        flex: 1;\n                        min-width: 48%;\n                    }\n                    table {\n                        width: 100%;\n                        border-collapse: collapse;\n                    }\n                    th, td {\n                        padding: 6px;\n                        text-align: left;\n                        font-size: 12px;\n                        vertical-align: top;\n                    }\n                    th {\n                        background-color: #ffc000;\n                        text-align: center;\n                        color: black;\n                    }\n                    .subtotal-row {\n                        \n                        font-weight: bold;\n                    }\n                    .type-text {\n                        color: red;\n                        font-weight: bold;\n                        text-align: center;\n                        vertical-align: middle;\n                    }\n                    .no-right-border {\n                        border-right: none !important;\n                    }\n                </style>\n                <div style=\"border:0.3px solid gray;border-bottom-width: thin;\">\n                <div style=\"display: flex; justify-content: center; align-items: center;border-bottom:1px solid gray;\">\n                    <p style=\"font-size:20px; font-weight:bold; margin-top:5px; color:black; \">Customer Wise Sales Plan - ${mon}'${year}</p>\n                </div>\n\n                <div class=\"table-container\" style=\"border-right:hidden;\">\n                    <div class=\"table-wrapper\" style=\"border-left:none;\">${leftData.html}</div>\n                    <div class=\"table-wrapper\" style=\"border-right:hidden !important;border-bottom:hidden !important;border-width:thin;\">${rightData.html}</div>\n                </div>\n                \n                <div style=\"display: flex;  align-items: center; border: 0.5px solid gray; background-color:yellow; border-bottom:hidden;border-left:hidden;border-right:hidden;\">\n                    <p style=\"font-weight:bold; margin-top:5px; margin-left:500px; color:black;\">\n                        Total Sales Plan: <span style=\"margin-left:150px;border-top:hidden;\">₹ ${(leftData.subtotal + rightData.subtotal).toLocaleString()}</span>\n                    </p>\n                </div>\n                </div>\n            `;\n\n                        let dialog = new frappe.ui.Dialog({\n                            title: __(\"Customer Wise Sales Plan\"),\n                            fields: [{\n                                fieldtype: \"HTML\",\n                                fieldname: \"customer_wise_table\",\n                                options: combinedHTML\n                            }],\n                            size: 'extra-large'\n                        });\n\n                        dialog.show();\n                    }\n                }\n            });\n\n\n\n\n\n\n        }, __('Summary Value'));\n\n\n        listview.page.add_inner_button(__('Department Wise'), function() {\n            const filters = listview.filter_area.get();\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\n\n            const year = new Date().getFullYear().toString().slice(-2);\n\n            if (!mon) {\n                mon = new Date().toLocaleString('default', {\n                    month: 'short'\n                }).toUpperCase();\n            }\n\n            frappe.call({\n                method: \"onegene.onegene.custom.department_wise_plan\",\n                args: {\n                    month: mon\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        const groupedData = r.message;\n                        const departments = Object.keys(groupedData) // sorted for clarity\n                        let grandTotal = 0;\n\n                        let tableHTML = `\n                    <style>\n                        table {\n                            width: 100%;\n                            border-collapse: collapse;\n                            font-size: 13px;\n                        }\n                        th, td {\n                            border: 1px solid #000;\n                            padding: 8px;\n                            text-align: left;\n                        }\n                        th {\n                            background-color: #ffc000;\n                            color: black;\n                            text-align: center;\n                        }\n                        .title-row td {\n                            font-size: 18px;\n                            font-weight: bold;\n                            text-align: center;\n                            border: none;\n                            padding: 12px 0;\n                        }\n                        .total-row {\n                            background-color: #ffff00;\n                            font-weight: bold;\n                        }\n                        .right-align {\n                            text-align: right;\n                        }\n                    </style>\n\n                    <table>\n                        \n                        <thead>\n                        <tr >\n                            <td colspan=\"2\" style=\"text-align:center; font-size:20px; font-weight:bold; color:black;\">Department Wise Sales Plan - ${mon}'${year}</td>\n                        </tr>\n                            <tr>\n                                <th style=\"color:black;\">Department</th>\n                                <th style=\"color:#2206f6;\">Schedule Value</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                `;\n\n                        departments.forEach(dep => {\n                            let amount = groupedData[dep] || 0;\n                            amount = Math.round(amount);\n                            grandTotal += amount;\n\n                            tableHTML += `\n                        <tr>\n                            <td style=\"color:black;\">${dep}</td>\n                            <td class=\"right-align\" style=\"color:black;\">${amount === 0 ? \"-\" : \"₹ \" + amount.toLocaleString()}</td>\n                        </tr>\n                    `;\n                        });\n\n                        // Add TOTAL row\n                        tableHTML += `\n                    <tr class=\"total-row\">\n                        <td style=\"color:black;\">TOTAL</td>\n                        <td class=\"right-align;\" style=\" text-align:right; color:black;\">₹ ${grandTotal.toLocaleString()}</td>\n                    </tr>\n                `;\n\n                        tableHTML += `</tbody></table>`;\n\n                        let dialog = new frappe.ui.Dialog({\n                            title: __(\"Department Wise Sales Plan\"),\n                            fields: [{\n                                fieldtype: \"HTML\",\n                                fieldname: \"department_wise_table\",\n                                options: tableHTML\n                            }],\n                            size: 'medium'\n                        });\n\n                        dialog.show();\n                    }\n                }\n            });\n        }, __('Summary Value'));\n\n        listview.page.add_inner_button(__('Customer Group Wise'), function() {\n            const filters = listview.filter_area.get();\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\n\n            const year = new Date().getFullYear().toString().slice(-2);\n\n            if (!mon) {\n                mon = new Date().toLocaleString('default', {\n                    month: 'short'\n                }).toUpperCase();\n            }\n\n            frappe.call({\n                method: \"onegene.onegene.custom.customer_group_wise\",\n                args: {\n                    month: mon\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        const groupedData = r.message;\n                        const departments = Object.keys(groupedData) // sorted for clarity\n                        let grandTotal = 0;\n\n                        let tableHTML = `\n                    <style>\n                        table {\n                            width: 100%;\n                            border-collapse: collapse;\n                            font-size: 13px;\n                        }\n                        th, td {\n                            border: 1px solid #000;\n                            padding: 8px;\n                            text-align: left;\n                        }\n                        th {\n                            background-color: #ffc000;\n                            color: black;\n                            text-align: center;\n                        }\n                        .title-row td {\n                            font-size: 18px;\n                            font-weight: bold;\n                            text-align: center;\n                            border: none;\n                            padding: 12px 0;\n                        }\n                        .total-row {\n                            background-color: #ffff00;\n                            font-weight: bold;\n                        }\n                        .right-align {\n                            text-align: right;\n                        }\n                    </style>\n\n                    <table>\n                        \n                        <thead>\n                        <tr >\n                            <td colspan=\"2\" style=\"text-align:center; font-size:20px; font-weight:bold; color:black;\">Customer Group Wise Sales Plan - ${mon}'${year}</td>\n                        </tr>\n                            <tr>\n                                <th style=\"color:black;\">Customer Group</th>\n                                <th style=\"color:#2206f6;\">Schedule Value</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                `;\n\n                        departments.forEach(dep => {\n                            let amount = groupedData[dep] || 0;\n                            amount = Math.round(amount);\n                            grandTotal += amount;\n\n                            tableHTML += `\n                        <tr>\n                            <td style=\"color:black;\">${dep}</td>\n                            <td class=\"right-align\" style=\"color:black;\">${amount === 0 ? \"-\" : \"₹ \" + amount.toLocaleString()}</td>\n                        </tr>\n                    `;\n                        });\n\n                        // Add TOTAL row\n                        tableHTML += `\n                    <tr class=\"total-row\">\n                        <td style=\"color:black;\">TOTAL</td>\n                        <td class=\"right-align;\" style=\" text-align:right; color:black;\">₹ ${grandTotal.toLocaleString()}</td>\n                    </tr>\n                `;\n\n                        tableHTML += `</tbody></table>`;\n\n                        let dialog = new frappe.ui.Dialog({\n                            title: __(\"Customer Group Wise Sales Plan\"),\n                            fields: [{\n                                fieldtype: \"HTML\",\n                                fieldname: \"department_wise_table\",\n                                options: tableHTML\n                            }],\n                            size: 'medium'\n                        });\n\n                        dialog.show();\n                    }\n                }\n            });\n        }, __('Summary Value'));\n\n        if (frappe.user.has_role(\"System Manager\") || frappe.user.has_role(\"Administrator\")) {\n            listview.page.add_inner_button(__('Currency'), function() {\n                const filters = listview.filter_area.get();\n                const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\n                let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\n    \n                const year = new Date().getFullYear().toString().slice(-2);\n                const nextyear = parseInt(year) + 1;\n    \n                if (!mon) {\n                    mon = new Date().toLocaleString('default', {\n                        month: 'short'\n                    }).toUpperCase();\n                }\n    \n    \n                frappe.call({\n                    method: \"onegene.onegene.doctype.sales_order_schedule.sales_order_schedule.currency_exchange_rate_list\",\n                    args: {\n                        month: mon\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n    \n                            const dialog = new frappe.ui.Dialog({\n                                title: __(\"Currency Exchange Rate List\"),\n                                fields: [{\n                                    label: \"Exchange Rates\",\n                                    fieldname: \"exchange_rates\",\n                                    fieldtype: \"Table\",\n                                    cannot_add_rows: true,\n                                    in_place_edit: true,\n                                    data: r.message,\n                                    fields: [{\n                                            fieldname: 'currency',\n                                            fieldtype: 'Data',\n                                            label: 'Currency',\n                                            read_only: 1,\n                                            in_list_view: 1,\n                                        },\n                                        {\n                                            fieldname: 'exchange_rate',\n                                            fieldtype: 'Float',\n                                            label: 'Exchange Rate (INR)',\n                                            precision: 6,\n                                            in_list_view: 1,\n                                        }\n                                    ]\n                                }],\n                                size: \"medium\"\n                            });\n    \n                            dialog.set_primary_action(\"Update\", function() {\n    \n                                // ✅ get values from dialog\n                                const values = dialog.get_values();\n    \n                                frappe.call({\n                                    method: \"onegene.onegene.doctype.sales_order_schedule.sales_order_schedule.update_exchange_rates\",\n                                    args: {\n                                        month: mon,\n                                        data: JSON.stringify(values.exchange_rates),\n                                    },\n                                    freeze: true,\n                                    callback: function(r) {\n                                        if (r.message) {\n                                            frappe.msgprint({\n                                                title: __('Success'),\n                                                message: __('Exchange Rate updated successfully.'),\n                                                indicator: 'green'\n                                            });\n                                        }\n                                    }\n                                });\n    \n                                dialog.hide();\n                            });\n    \n                            dialog.show();\n                        }\n                    }\n                });\n    \n    \n    \n    \n            });\n        }\n\n    }\n\n\n\n}\n\n\n\n// function generateTableHTML(group, customers) {\n//     const keys = Object.keys(customers);\n//     let subtotal = 0;\n\n//     let html = `\n//         <table border=\"1\">\n//             <thead>\n\n//                 <tr>\n//                     <th style=\"width: 100px;\">Type</th>\n//                     <th>Customer</th>\n//                     <th style=\"color:blue;\">Schedule Value</th>\n//                 </tr>\n//             </thead>\n//             <tbody>\n//     `;\n\n//     keys.forEach((cust, index) => {\n//         const value = customers[cust] || 0;\n//         subtotal += value;\n\n//         html += `<tr>`;\n\n//         // For the \"Type\" column, show group name only once (rowspan)\n//         if(index === 0) {\n//             html += `<td rowspan=\"${keys.length}\" class=\"type-text\" style=\"vertical-align: middle; text-align: center; font-weight: bold; color: red;\">${group}</td>`;\n//         }\n\n//         html += `\n//                 <td>${cust}</td>\n//                 <td style=\"text-align:right;\">${value ? \"₹ \" + value.toLocaleString() : \"-\"}</td>\n//             </tr>`;\n//     });\n\n//     // If no customers, still show the group in the \"Type\" column for 1 row\n//     if(keys.length === 0) {\n//         html += `\n//             <tr>\n//                 <td class=\"type-text\" style=\"vertical-align: middle; text-align: center; font-weight: bold; color: red;\">${group}</td>\n//                 <td colspan=\"2\" style=\"text-align:center;\">No Data</td>\n//             </tr>`;\n//     }\n\n//     html += `\n//         <tr class=\"subtotal-row\">\n//             <td colspan=\"2\">SUB TOTAL</td>\n//             <td style=\"text-align:right;\">₹ ${subtotal.toLocaleString()}</td>\n//         </tr>\n//         <tr class=\"total-row\">\n//             <td colspan=\"2\" style=\"text-align:right; font-size:14px;\">Total</td>\n//             <td style=\"text-align:right; font-size:14px;\">₹ ${subtotal.toLocaleString()}</td>\n//         </tr>\n//     </tbody></table>`;\n\n//     return html;\n// }\n\nfunction generateTableHTML(group, customers) {\n    const keys = Object.keys(customers);\n    let subtotal = 0;\n\n    keys.sort((a, b) => {\n        const aIsHanon = a.trim().toLowerCase().startsWith(\"hanon\");\n        const bIsHanon = b.trim().toLowerCase().startsWith(\"hanon\");\n\n        if (aIsHanon && !bIsHanon) return -1; // a first\n        if (!aIsHanon && bIsHanon) return 1; // b first\n        return 0; // otherwise keep original order\n    });\n\n\n    let html = `\n        <table border=\"1\" style=\"border-collapse:collapse;\">\n            <thead>\n                <tr>\n                    <th style=\"width: 100px;border-top:hidden;\">Type</th>\n                    <th style=\"border-top:hidden;\">Customer</th>\n                    <th style=\"color:#2206f6;border-top:hidden;\">Schedule Value</th>\n                </tr>\n            </thead>\n            <tbody>\n    `;\n\n    keys.forEach((cust, index) => {\n        let value = customers[cust] || 0;\n        value = Math.round(value);\n        subtotal += value;\n\n        html += `<tr>`;\n\n        // For the \"Type\" column, show group name only once (rowspan)\n        if (index === 0) {\n            const borderStyle = group === \"Domestic\" ? \"border-left: hidden;\" : \"\";\n            const borderStyle_EXPORT = group === \"Export\" ? \"border-bottom: hidden;\" : \"\";\n            html += `<td rowspan=\"${keys.length +1}\" class=\"type-text\" style=\"vertical-align: middle; text-align: center; font-weight: bold; color: #b00d0a;${borderStyle}${borderStyle_EXPORT}\">${group ==\"Domestic\" ? \"DOMESTIC\" : \"EXPORT\"}</td>`;\n        }\n        const borderStyle_new = group === \"Export\" ? \"border-right: hidden;\" : \"\";\n        html += `\n                <td style=\"font-weight:bold;color:black;\">${cust}</td>\n                <td style=\"text-align:right; font-weight:bold; color:black;${borderStyle_new}\">${value ? \"₹ \" + value.toLocaleString() : \"-\"}</td>\n            </tr>`;\n    });\n\n    if (keys.length === 0) {\n\n        html += `\n            <tr>\n                <td class=\"type-text\" style=\"vertical-align: middle; text-align: center; font-weight: bold; color: #b00d0a;\">${group}</td>\n                <td colspan=\"2\" style=\"text-align:center;\">No Data</td>\n            </tr>`;\n    }\n    subtotal = Math.round(subtotal);\n    const borderStyle_EXPORT = group === \"Export\" ? \"border-bottom: hidden !important;\" : \"\";\n    // Only subtotal row remains\n    html += `\n        <tr>\n            \n            <td colspan=\"1\" style=\"background-color: #00ffff; color:black;${borderStyle_EXPORT} \">SUB TOTAL</td>\n            <td style=\"text-align:right; background-color: #00ffff; color:black;${borderStyle_EXPORT} \">₹ ${subtotal.toLocaleString()}</td>\n        </tr>\n    </tbody></table>`;\n\n    return {\n        html,\n        subtotal\n    };\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-09-06 11:27:57.077874",
  "module": "ONEGENE",
  "name": "Item List",
  "script": "let core_settings = frappe.listview_settings['Item'] || {};\r\n\r\nfrappe.listview_settings['Item'] = {\r\n    ...core_settings,\r\n    onload(listview) {\r\n\r\n        listview.filter_area.clear().then(() => {\r\n            listview.filter_area.add([\r\n                [\"Item\", \"custom_service_category\", \"!=\", \"Subcontracting\"]\r\n            ]);\r\n        });\r\n    }\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quality Pending",
  "enabled": 1,
  "modified": "2025-09-13 15:52:44.686175",
  "module": "ONEGENE",
  "name": "Quality Pending",
  "script": "frappe.listview_settings['Quality Pending'] = {\r\n    onload(listview) {\r\n        listview.filter_area.add([[listview.doctype, 'status', '!=', 'Completed']]);\r\n    }\r\n};\r\n",
  "view": "List"
 }
]